{"id":"37888046051","type":"IssueCommentEvent","actor":{"id":18599032,"login":"Atemu","display_login":"Atemu","gravatar_id":"","url":"https://api.github.com/users/Atemu","avatar_url":"https://avatars.githubusercontent.com/u/18599032?"},"repo":{"id":4542716,"name":"NixOS/nixpkgs","url":"https://api.github.com/repos/NixOS/nixpkgs"},"payload":{"action":"created","issue":{"url":"https://api.github.com/repos/NixOS/nixpkgs/issues/8567","repository_url":"https://api.github.com/repos/NixOS/nixpkgs","labels_url":"https://api.github.com/repos/NixOS/nixpkgs/issues/8567/labels{/name}","comments_url":"https://api.github.com/repos/NixOS/nixpkgs/issues/8567/comments","events_url":"https://api.github.com/repos/NixOS/nixpkgs/issues/8567/events","html_url":"https://github.com/NixOS/nixpkgs/issues/8567","id":91945224,"node_id":"MDU6SXNzdWU5MTk0NTIyNA==","number":8567,"title":"`fetchgit` with `leaveDotGit = true` is still not completely deterministic","user":{"login":"wizeman","id":168610,"node_id":"MDQ6VXNlcjE2ODYxMA==","avatar_url":"https://avatars.githubusercontent.com/u/168610?v=4","gravatar_id":"","url":"https://api.github.com/users/wizeman","html_url":"https://github.com/wizeman","followers_url":"https://api.github.com/users/wizeman/followers","following_url":"https://api.github.com/users/wizeman/following{/other_user}","gists_url":"https://api.github.com/users/wizeman/gists{/gist_id}","starred_url":"https://api.github.com/users/wizeman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wizeman/subscriptions","organizations_url":"https://api.github.com/users/wizeman/orgs","repos_url":"https://api.github.com/users/wizeman/repos","events_url":"https://api.github.com/users/wizeman/events{/privacy}","received_events_url":"https://api.github.com/users/wizeman/received_events","type":"User","site_admin":false},"labels":[{"id":290143264,"node_id":"MDU6TGFiZWwyOTAxNDMyNjQ=","url":"https://api.github.com/repos/NixOS/nixpkgs/labels/6.topic:%20reproducible%20builds","name":"6.topic: reproducible builds","color":"fef2c0","default":false,"description":null},{"id":786406134,"node_id":"MDU6TGFiZWw3ODY0MDYxMzQ=","url":"https://api.github.com/repos/NixOS/nixpkgs/labels/6.topic:%20fetch","name":"6.topic: fetch","color":"fef2c0","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":65,"created_at":"2015-06-30T00:50:50Z","updated_at":"2024-04-28T10:31:22Z","closed_at":null,"author_association":"MEMBER","active_lock_reason":null,"body":"The hash of the `cargo` git repository returned by `fetchgit` has changed twice already, even though the git revision didn't change (see de322b48b7006cf72d6adc37a833f2e045950536 and now #8566).\n\nSee also: #4752 and #4767\n\ncc @bjornfor and @madjar (due to #4767).\n","reactions":{"url":"https://api.github.com/repos/NixOS/nixpkgs/issues/8567/reactions","total_count":3,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/NixOS/nixpkgs/issues/8567/timeline","performed_via_github_app":null,"state_reason":null},"comment":{"url":"https://api.github.com/repos/NixOS/nixpkgs/issues/comments/2081427074","html_url":"https://github.com/NixOS/nixpkgs/issues/8567#issuecomment-2081427074","issue_url":"https://api.github.com/repos/NixOS/nixpkgs/issues/8567","id":2081427074,"node_id":"IC_kwDOAEVQ_M58EA6C","user":{"login":"Atemu","id":18599032,"node_id":"MDQ6VXNlcjE4NTk5MDMy","avatar_url":"https://avatars.githubusercontent.com/u/18599032?v=4","gravatar_id":"","url":"https://api.github.com/users/Atemu","html_url":"https://github.com/Atemu","followers_url":"https://api.github.com/users/Atemu/followers","following_url":"https://api.github.com/users/Atemu/following{/other_user}","gists_url":"https://api.github.com/users/Atemu/gists{/gist_id}","starred_url":"https://api.github.com/users/Atemu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Atemu/subscriptions","organizations_url":"https://api.github.com/users/Atemu/orgs","repos_url":"https://api.github.com/users/Atemu/repos","events_url":"https://api.github.com/users/Atemu/events{/privacy}","received_events_url":"https://api.github.com/users/Atemu/received_events","type":"User","site_admin":false},"created_at":"2024-04-28T10:31:21Z","updated_at":"2024-04-28T10:31:21Z","author_association":"MEMBER","body":"> It can't just be a collection of loose object files, as that takes too much space on disk. We have to use Git pack files.\r\n\r\nI don't see that as a given. Sure it'd be space inefficient but that's a helluvalot better than not working at all.\r\n\r\n> We shouldn't use Git itself to create the new repository, as we don't control its determinism, and its implementation is subject to change.\r\n\r\nWe don't have an exclusive right to determinism. As long as a tool explicitly guarantees determinism in its output, we can use it for FODs. See i.e. cargo or Go vendor hashes.\r\n\r\nThe problem is rather that git does have any such guarantees w.r.t. its repository format AFAIK. If that existed and was enforced by upstream (i.e. breaking it would be considered a bug) we could absolutely use it.\r\n\r\n> This looks like the only sustainable solution: TRUSTING git and delegating to git some of nix' work.\r\n\r\n> All other solutions are conceptually flawed and hackish because git and nix do more or less the same job so they will always keep stepping on each other's toes.\r\n\r\nGit and Nix do not do the same job. Nix is primarily a raw *input-addressed* store for binary data while git is a *content-addressed* store for plain-text data.\r\n\r\nThe only overlap is that Nix also contains a content-addressed store on the side in the form of FODs aswell as the experimental CA-derivations.\r\n\r\nI too would like to see native support for Git and other trustworthy content-addressing schemes such as IPFS or torrents. That's quite complex however as it'd necessitate changes to Nix itself and isn't really a topic to be discussed here. You'd need an RFC concerning the Nix package manager for that and quite a bit of lead-up time before it could actually be used in Nixpkgs probably.\r\n\r\n> With the infamous autotools finally dying, the number of projects that fail to build when .git is missing will only go up and up.\r\n\r\nAutotools has been dying for a while now. While I too whish it'd go on with it finally, that's still at least a few decades off.\r\n\r\nFortunately however, most build tools have no direct dependence on Git in any way. The worst they usually do is to encode the current commit id and that's where I'd draw the line for \"the build tool is borken\" too because any more dependency on the state of the VCS is a bug IMHO.\r\n\r\n> From the perspective of a maintainer who has never heard about nix or similar (= most maintainers), abandoning tarballs simplifies the source release process greatly which (the irony) helps ensuring build reproducibility. Dropping the tarball layer of indirection also reduces the attack surface: see for instance the recent jiaT75 attack on XZ.\r\n\r\nNote that this is an entirely tangential topic.\r\n\r\nYou also appear to be a little confused here. We have no hard dependence on upstream tarballs. We have fetchgit, fetchFromGitHub and the like and they're used everywhere. The only reason release tarballs are used in Nixpkgs is because of technical feasibility reasons (i.e. bootstrap) or because people had a preference for them. There is no clear policy concerning this, see https://discourse.nixos.org/t/reconsider-reusing-upstream-tarballs/42524.\r\n\r\nThis discussion only concerns calling fetchGit with the `leaveDotGit = true` argument which is necessary because in some rare cases, the build tool is (IMHO) broken and does have a hard dependency on the VCS state; it must be present during the (pure) build.\r\n\r\n> As per my comment above - only when it is created by Git itself, surely?\r\n\r\nOnly when it's not guaranteed to be stable IMO. It doesn't matter whether git or some other tool generates it but it has to be stable. If some external tool's output is also not stable, that's no good either.","reactions":{"url":"https://api.github.com/repos/NixOS/nixpkgs/issues/comments/2081427074/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null}},"public":true,"created_at":"2024-04-28T10:31:22Z","org":{"id":487568,"login":"NixOS","gravatar_id":"","url":"https://api.github.com/orgs/NixOS","avatar_url":"https://avatars.githubusercontent.com/u/487568?"}}
