{"id":"30714842333","type":"PullRequestEvent","actor":{"id":41658782,"login":"ChanTsune","display_login":"ChanTsune","gravatar_id":"","url":"https://api.github.com/users/ChanTsune","avatar_url":"https://avatars.githubusercontent.com/u/41658782?"},"repo":{"id":553665726,"name":"tukaani-project/xz","url":"https://api.github.com/repos/tukaani-project/xz"},"payload":{"action":"opened","number":57,"pull_request":{"url":"https://api.github.com/repos/tukaani-project/xz/pulls/57","id":1451903541,"node_id":"PR_kwDOIQBEvs5Wiko1","html_url":"https://github.com/tukaani-project/xz/pull/57","diff_url":"https://github.com/tukaani-project/xz/pull/57.diff","patch_url":"https://github.com/tukaani-project/xz/pull/57.patch","issue_url":"https://api.github.com/repos/tukaani-project/xz/issues/57","number":57,"state":"open","locked":false,"title":"Support build target `wasm32-unknown-unknown` in clang when `ENABLE_THREADS=OFF`","user":{"login":"ChanTsune","id":41658782,"node_id":"MDQ6VXNlcjQxNjU4Nzgy","avatar_url":"https://avatars.githubusercontent.com/u/41658782?v=4","gravatar_id":"","url":"https://api.github.com/users/ChanTsune","html_url":"https://github.com/ChanTsune","followers_url":"https://api.github.com/users/ChanTsune/followers","following_url":"https://api.github.com/users/ChanTsune/following{/other_user}","gists_url":"https://api.github.com/users/ChanTsune/gists{/gist_id}","starred_url":"https://api.github.com/users/ChanTsune/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChanTsune/subscriptions","organizations_url":"https://api.github.com/users/ChanTsune/orgs","repos_url":"https://api.github.com/users/ChanTsune/repos","events_url":"https://api.github.com/users/ChanTsune/events{/privacy}","received_events_url":"https://api.github.com/users/ChanTsune/received_events","type":"User","site_admin":false},"body":"Thanks for the review #56 yesterday!\r\n\r\nI tried another approach, could you please review this one?\r\n\r\n## Pull request checklist\r\n\r\nPlease check if your PR fulfills the following requirements:\r\n- [x] Tests for the changes have been added (for bug fixes / features)\r\n- [x] Docs have been reviewed and added / updated if needed (for bug fixes / features)\r\n- [x] Build was run locally and without warnings or errors\r\n- [x] All previous and new tests pass\r\n\r\n\r\n## Pull request type\r\n\r\n<!-- Please try to limit your pull request to one type, submit multiple\r\npull requests if needed. --> \r\n\r\nPlease check the type of change your PR introduces:\r\n- [ ] Bugfix\r\n- [ ] Feature\r\n- [ ] Code style update (formatting, renaming, typo fix)\r\n- [x] Refactoring (no functional changes, no api changes)\r\n- [x] Build related changes\r\n- [ ] Documentation content changes\r\n- [ ] Other (please describe): \r\n\r\n\r\n## What is the current behavior?\r\n<!-- Please describe the current behavior that you are modifying. -->\r\n```\r\n$ mkdir build && cd build\r\n$ cmake .. -DENABLE_THREADS=OFF\r\n$ make liblzma\r\n[  0%] Building C object CMakeFiles/liblzma.dir/src/common/tuklib_physmem.c.obj                                       \r\n[  1%] Building C object CMakeFiles/liblzma.dir/src/liblzma/check/check.c.obj                                         \r\nIn file included from /xz/src/liblzma/check/check.c:13:                                                               \r\nIn file included from /xz/src/liblzma/check/check.h:16:                                                               \r\nIn file included from /xz/src/liblzma/common/common.h:17:\r\nIn file included from /xz/src/common/mythread.h:84:\r\n/wasi-sysroot/include/signal.h:2:2: error: \"wasm lacks signal support; to enable minimal signal emulation, compile with -D_WASI_EMULATED_SIGNAL and link with -lwasi-emulated-signal\"\r\n#error \"wasm lacks signal support; to enable minimal signal emulation, \\\r\n ^\r\nIn file included from /xz/src/liblzma/check/check.c:13:\r\nIn file included from /xz/src/liblzma/check/check.h:16:\r\nIn file included from /xz/src/liblzma/common/common.h:17:\r\n/xz/src/common/mythread.h:87:33: error: unknown type name 'sigset_t'\r\nmythread_sigmask(int how, const sigset_t *restrict set,\r\n                                ^\r\n/xz/src/common/mythread.h:88:3: error: unknown type name 'sigset_t'\r\n                sigset_t *restrict oset)\r\n                ^\r\n/xz/src/common/mythread.h:90:12: error: call to undeclared function 'sigprocmask'; ISO C99 and later do not support implicit function declarations [-Wimplicit-function-declaration]\r\n        int ret = sigprocmask(how, set, oset);\r\n                  ^\r\n4 errors generated.\r\nmake[3]: *** [CMakeFiles/liblzma.dir/build.make:90: CMakeFiles/liblzma.dir/src/liblzma/check/check.c.obj] Error 1\r\nmake[2]: *** [CMakeFiles/Makefile2:139: CMakeFiles/liblzma.dir/all] Error 2\r\nmake[1]: *** [CMakeFiles/Makefile2:146: CMakeFiles/liblzma.dir/rule] Error 2\r\nmake: *** [Makefile:179: liblzma] Error 2\r\n```\r\n\r\n<!-- Related issue this PR addresses, if applicable -->\r\nRelated Issue URL: \r\n#56 \r\n\r\n## What is the new behavior?\r\n<!-- Please describe the behavior or changes that are being added by this\r\nPR. -->\r\n\r\n- Changed to exclude signal functions not supported by WebAssembly using the predefined `__wasm__` macro when the build target is set to wasm32 with clang.\r\nThis change allows `liblzma` to be built with the platform-independent `wasm32-uknown-unknown` target.\r\nI believe this exclusion will work in the same way as the build when targeting Windows, so it will minimize unexpected changes.\r\n\r\n## Does this introduce a breaking change?\r\n\r\n- [ ] Yes\r\n- [x] No\r\n\r\n<!-- If this introduces a breaking change, please describe the impact and\r\nmigration path for existing applications below. -->\r\n\r\n\r\n## Other information\r\n\r\nBuild tested on docker\r\n\r\n`Dockerfile`\r\n```docker\r\nFROM ghcr.io/webassembly/wasi-sdk:latest\r\n\r\nRUN apt update && apt install -y git\r\n\r\nRUN git clone https://github.com/ChanTsune/xz.git\r\n\r\nRUN mkdir -p ./xz/build\r\n\r\nRUN cd xz && git fetch && git switch feature/liblzma/wasm\r\n\r\nWORKDIR /xz/build\r\n\r\nRUN cmake .. -DENABLE_THREADS=OFF\r\n\r\nRUN CFLAGS=\"-target wasm32-unknown-unknown\" make liblzma\r\n```\r\n\r\n```sh\r\n$ docker build -t xz .\r\n```\r\n\r\nIf you need, you can see the predefined macros when targeting wasm32 in clang by following commands\r\n```\r\n$ clang -E -dM -target wasm32-unknown-unknown -x c /dev/null\r\n```\r\nor if you want to check with the latest wasi-sdk clang\r\n```sh\r\n$ docker image pull ghcr.io/webassembly/wasi-sdk\r\n$ docker run --rm -i ghcr.io/webassembly/wasi-sdk clang-16 -E -dM -target wasm32-unknown-unknown -x c /dev/null\r\n```\r\n","created_at":"2023-07-27T12:23:12Z","updated_at":"2023-07-27T12:23:12Z","closed_at":null,"merged_at":null,"merge_commit_sha":null,"assignee":null,"assignees":[],"requested_reviewers":[],"requested_teams":[],"labels":[],"milestone":null,"draft":false,"commits_url":"https://api.github.com/repos/tukaani-project/xz/pulls/57/commits","review_comments_url":"https://api.github.com/repos/tukaani-project/xz/pulls/57/comments","review_comment_url":"https://api.github.com/repos/tukaani-project/xz/pulls/comments{/number}","comments_url":"https://api.github.com/repos/tukaani-project/xz/issues/57/comments","statuses_url":"https://api.github.com/repos/tukaani-project/xz/statuses/2a71bbca66fc6009db62c4ef9ba849e806e49ef8","head":{"label":"ChanTsune:feature/liblzma/wasm","ref":"feature/liblzma/wasm","sha":"2a71bbca66fc6009db62c4ef9ba849e806e49ef8","user":{"login":"ChanTsune","id":41658782,"node_id":"MDQ6VXNlcjQxNjU4Nzgy","avatar_url":"https://avatars.githubusercontent.com/u/41658782?v=4","gravatar_id":"","url":"https://api.github.com/users/ChanTsune","html_url":"https://github.com/ChanTsune","followers_url":"https://api.github.com/users/ChanTsune/followers","following_url":"https://api.github.com/users/ChanTsune/following{/other_user}","gists_url":"https://api.github.com/users/ChanTsune/gists{/gist_id}","starred_url":"https://api.github.com/users/ChanTsune/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChanTsune/subscriptions","organizations_url":"https://api.github.com/users/ChanTsune/orgs","repos_url":"https://api.github.com/users/ChanTsune/repos","events_url":"https://api.github.com/users/ChanTsune/events{/privacy}","received_events_url":"https://api.github.com/users/ChanTsune/received_events","type":"User","site_admin":false},"repo":{"id":670838402,"node_id":"R_kgDOJ_wugg","name":"xz","full_name":"ChanTsune/xz","private":false,"owner":{"login":"ChanTsune","id":41658782,"node_id":"MDQ6VXNlcjQxNjU4Nzgy","avatar_url":"https://avatars.githubusercontent.com/u/41658782?v=4","gravatar_id":"","url":"https://api.github.com/users/ChanTsune","html_url":"https://github.com/ChanTsune","followers_url":"https://api.github.com/users/ChanTsune/followers","following_url":"https://api.github.com/users/ChanTsune/following{/other_user}","gists_url":"https://api.github.com/users/ChanTsune/gists{/gist_id}","starred_url":"https://api.github.com/users/ChanTsune/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChanTsune/subscriptions","organizations_url":"https://api.github.com/users/ChanTsune/orgs","repos_url":"https://api.github.com/users/ChanTsune/repos","events_url":"https://api.github.com/users/ChanTsune/events{/privacy}","received_events_url":"https://api.github.com/users/ChanTsune/received_events","type":"User","site_admin":false},"html_url":"https://github.com/ChanTsune/xz","description":"XZ Utils Official Repository","fork":true,"url":"https://api.github.com/repos/ChanTsune/xz","forks_url":"https://api.github.com/repos/ChanTsune/xz/forks","keys_url":"https://api.github.com/repos/ChanTsune/xz/keys{/key_id}","collaborators_url":"https://api.github.com/repos/ChanTsune/xz/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/ChanTsune/xz/teams","hooks_url":"https://api.github.com/repos/ChanTsune/xz/hooks","issue_events_url":"https://api.github.com/repos/ChanTsune/xz/issues/events{/number}","events_url":"https://api.github.com/repos/ChanTsune/xz/events","assignees_url":"https://api.github.com/repos/ChanTsune/xz/assignees{/user}","branches_url":"https://api.github.com/repos/ChanTsune/xz/branches{/branch}","tags_url":"https://api.github.com/repos/ChanTsune/xz/tags","blobs_url":"https://api.github.com/repos/ChanTsune/xz/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/ChanTsune/xz/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/ChanTsune/xz/git/refs{/sha}","trees_url":"https://api.github.com/repos/ChanTsune/xz/git/trees{/sha}","statuses_url":"https://api.github.com/repos/ChanTsune/xz/statuses/{sha}","languages_url":"https://api.github.com/repos/ChanTsune/xz/languages","stargazers_url":"https://api.github.com/repos/ChanTsune/xz/stargazers","contributors_url":"https://api.github.com/repos/ChanTsune/xz/contributors","subscribers_url":"https://api.github.com/repos/ChanTsune/xz/subscribers","subscription_url":"https://api.github.com/repos/ChanTsune/xz/subscription","commits_url":"https://api.github.com/repos/ChanTsune/xz/commits{/sha}","git_commits_url":"https://api.github.com/repos/ChanTsune/xz/git/commits{/sha}","comments_url":"https://api.github.com/repos/ChanTsune/xz/comments{/number}","issue_comment_url":"https://api.github.com/repos/ChanTsune/xz/issues/comments{/number}","contents_url":"https://api.github.com/repos/ChanTsune/xz/contents/{+path}","compare_url":"https://api.github.com/repos/ChanTsune/xz/compare/{base}...{head}","merges_url":"https://api.github.com/repos/ChanTsune/xz/merges","archive_url":"https://api.github.com/repos/ChanTsune/xz/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/ChanTsune/xz/downloads","issues_url":"https://api.github.com/repos/ChanTsune/xz/issues{/number}","pulls_url":"https://api.github.com/repos/ChanTsune/xz/pulls{/number}","milestones_url":"https://api.github.com/repos/ChanTsune/xz/milestones{/number}","notifications_url":"https://api.github.com/repos/ChanTsune/xz/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/ChanTsune/xz/labels{/name}","releases_url":"https://api.github.com/repos/ChanTsune/xz/releases{/id}","deployments_url":"https://api.github.com/repos/ChanTsune/xz/deployments","created_at":"2023-07-26T00:51:03Z","updated_at":"2023-07-26T00:51:03Z","pushed_at":"2023-07-27T11:54:24Z","git_url":"git://github.com/ChanTsune/xz.git","ssh_url":"git@github.com:ChanTsune/xz.git","clone_url":"https://github.com/ChanTsune/xz.git","svn_url":"https://github.com/ChanTsune/xz","homepage":"https://tukaani.org","size":4484,"stargazers_count":0,"watchers_count":0,"language":null,"has_issues":false,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":false,"forks_count":0,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":0,"license":{"key":"other","name":"Other","spdx_id":"NOASSERTION","url":null,"node_id":"MDc6TGljZW5zZTA="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":[],"visibility":"public","forks":0,"open_issues":0,"watchers":0,"default_branch":"master"}},"base":{"label":"tukaani-project:master","ref":"master","sha":"db5019d691f980d622fb56fdcf383af2c3519c98","user":{"login":"tukaani-project","id":116083088,"node_id":"O_kgDOButJkA","avatar_url":"https://avatars.githubusercontent.com/u/116083088?v=4","gravatar_id":"","url":"https://api.github.com/users/tukaani-project","html_url":"https://github.com/tukaani-project","followers_url":"https://api.github.com/users/tukaani-project/followers","following_url":"https://api.github.com/users/tukaani-project/following{/other_user}","gists_url":"https://api.github.com/users/tukaani-project/gists{/gist_id}","starred_url":"https://api.github.com/users/tukaani-project/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tukaani-project/subscriptions","organizations_url":"https://api.github.com/users/tukaani-project/orgs","repos_url":"https://api.github.com/users/tukaani-project/repos","events_url":"https://api.github.com/users/tukaani-project/events{/privacy}","received_events_url":"https://api.github.com/users/tukaani-project/received_events","type":"Organization","site_admin":false},"repo":{"id":553665726,"node_id":"R_kgDOIQBEvg","name":"xz","full_name":"tukaani-project/xz","private":false,"owner":{"login":"tukaani-project","id":116083088,"node_id":"O_kgDOButJkA","avatar_url":"https://avatars.githubusercontent.com/u/116083088?v=4","gravatar_id":"","url":"https://api.github.com/users/tukaani-project","html_url":"https://github.com/tukaani-project","followers_url":"https://api.github.com/users/tukaani-project/followers","following_url":"https://api.github.com/users/tukaani-project/following{/other_user}","gists_url":"https://api.github.com/users/tukaani-project/gists{/gist_id}","starred_url":"https://api.github.com/users/tukaani-project/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tukaani-project/subscriptions","organizations_url":"https://api.github.com/users/tukaani-project/orgs","repos_url":"https://api.github.com/users/tukaani-project/repos","events_url":"https://api.github.com/users/tukaani-project/events{/privacy}","received_events_url":"https://api.github.com/users/tukaani-project/received_events","type":"Organization","site_admin":false},"html_url":"https://github.com/tukaani-project/xz","description":"XZ Utils Official Repository","fork":false,"url":"https://api.github.com/repos/tukaani-project/xz","forks_url":"https://api.github.com/repos/tukaani-project/xz/forks","keys_url":"https://api.github.com/repos/tukaani-project/xz/keys{/key_id}","collaborators_url":"https://api.github.com/repos/tukaani-project/xz/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/tukaani-project/xz/teams","hooks_url":"https://api.github.com/repos/tukaani-project/xz/hooks","issue_events_url":"https://api.github.com/repos/tukaani-project/xz/issues/events{/number}","events_url":"https://api.github.com/repos/tukaani-project/xz/events","assignees_url":"https://api.github.com/repos/tukaani-project/xz/assignees{/user}","branches_url":"https://api.github.com/repos/tukaani-project/xz/branches{/branch}","tags_url":"https://api.github.com/repos/tukaani-project/xz/tags","blobs_url":"https://api.github.com/repos/tukaani-project/xz/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/tukaani-project/xz/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/tukaani-project/xz/git/refs{/sha}","trees_url":"https://api.github.com/repos/tukaani-project/xz/git/trees{/sha}","statuses_url":"https://api.github.com/repos/tukaani-project/xz/statuses/{sha}","languages_url":"https://api.github.com/repos/tukaani-project/xz/languages","stargazers_url":"https://api.github.com/repos/tukaani-project/xz/stargazers","contributors_url":"https://api.github.com/repos/tukaani-project/xz/contributors","subscribers_url":"https://api.github.com/repos/tukaani-project/xz/subscribers","subscription_url":"https://api.github.com/repos/tukaani-project/xz/subscription","commits_url":"https://api.github.com/repos/tukaani-project/xz/commits{/sha}","git_commits_url":"https://api.github.com/repos/tukaani-project/xz/git/commits{/sha}","comments_url":"https://api.github.com/repos/tukaani-project/xz/comments{/number}","issue_comment_url":"https://api.github.com/repos/tukaani-project/xz/issues/comments{/number}","contents_url":"https://api.github.com/repos/tukaani-project/xz/contents/{+path}","compare_url":"https://api.github.com/repos/tukaani-project/xz/compare/{base}...{head}","merges_url":"https://api.github.com/repos/tukaani-project/xz/merges","archive_url":"https://api.github.com/repos/tukaani-project/xz/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/tukaani-project/xz/downloads","issues_url":"https://api.github.com/repos/tukaani-project/xz/issues{/number}","pulls_url":"https://api.github.com/repos/tukaani-project/xz/pulls{/number}","milestones_url":"https://api.github.com/repos/tukaani-project/xz/milestones{/number}","notifications_url":"https://api.github.com/repos/tukaani-project/xz/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/tukaani-project/xz/labels{/name}","releases_url":"https://api.github.com/repos/tukaani-project/xz/releases{/id}","deployments_url":"https://api.github.com/repos/tukaani-project/xz/deployments","created_at":"2022-10-18T15:11:36Z","updated_at":"2023-07-26T02:26:43Z","pushed_at":"2023-07-27T12:23:13Z","git_url":"git://github.com/tukaani-project/xz.git","ssh_url":"git@github.com:tukaani-project/xz.git","clone_url":"https://github.com/tukaani-project/xz.git","svn_url":"https://github.com/tukaani-project/xz","homepage":"https://tukaani.org","size":4478,"stargazers_count":75,"watchers_count":75,"language":"C","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":false,"forks_count":21,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":4,"license":{"key":"other","name":"Other","spdx_id":"NOASSERTION","url":null,"node_id":"MDc6TGljZW5zZTA="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["c","cli","compression","library"],"visibility":"public","forks":21,"open_issues":4,"watchers":75,"default_branch":"master"}},"_links":{"self":{"href":"https://api.github.com/repos/tukaani-project/xz/pulls/57"},"html":{"href":"https://github.com/tukaani-project/xz/pull/57"},"issue":{"href":"https://api.github.com/repos/tukaani-project/xz/issues/57"},"comments":{"href":"https://api.github.com/repos/tukaani-project/xz/issues/57/comments"},"review_comments":{"href":"https://api.github.com/repos/tukaani-project/xz/pulls/57/comments"},"review_comment":{"href":"https://api.github.com/repos/tukaani-project/xz/pulls/comments{/number}"},"commits":{"href":"https://api.github.com/repos/tukaani-project/xz/pulls/57/commits"},"statuses":{"href":"https://api.github.com/repos/tukaani-project/xz/statuses/2a71bbca66fc6009db62c4ef9ba849e806e49ef8"}},"author_association":"NONE","auto_merge":null,"active_lock_reason":null,"merged":false,"mergeable":null,"rebaseable":null,"mergeable_state":"unknown","merged_by":null,"comments":0,"review_comments":0,"maintainer_can_modify":true,"commits":1,"additions":1,"deletions":1,"changed_files":1}},"public":true,"created_at":"2023-07-27T12:23:13Z","org":{"id":116083088,"login":"tukaani-project","gravatar_id":"","url":"https://api.github.com/orgs/tukaani-project","avatar_url":"https://avatars.githubusercontent.com/u/116083088?"}}
