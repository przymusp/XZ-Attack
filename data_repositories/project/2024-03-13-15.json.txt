{"id":"36516414296","type":"IssueCommentEvent","actor":{"id":19591868,"login":"skosukhin","display_login":"skosukhin","gravatar_id":"","url":"https://api.github.com/users/skosukhin","avatar_url":"https://avatars.githubusercontent.com/u/19591868?"},"repo":{"id":553665726,"name":"tukaani-project/xz","url":"https://api.github.com/repos/tukaani-project/xz"},"payload":{"action":"created","issue":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/91","repository_url":"https://api.github.com/repos/tukaani-project/xz","labels_url":"https://api.github.com/repos/tukaani-project/xz/issues/91/labels{/name}","comments_url":"https://api.github.com/repos/tukaani-project/xz/issues/91/comments","events_url":"https://api.github.com/repos/tukaani-project/xz/issues/91/events","html_url":"https://github.com/tukaani-project/xz/pull/91","id":2183979010,"node_id":"PR_kwDOIQBEvs5pgS85","number":91,"title":"liblzma: Fix building with NVHPC (NVIDIA HPC SDK).","user":{"login":"skosukhin","id":19591868,"node_id":"MDQ6VXNlcjE5NTkxODY4","avatar_url":"https://avatars.githubusercontent.com/u/19591868?v=4","gravatar_id":"","url":"https://api.github.com/users/skosukhin","html_url":"https://github.com/skosukhin","followers_url":"https://api.github.com/users/skosukhin/followers","following_url":"https://api.github.com/users/skosukhin/following{/other_user}","gists_url":"https://api.github.com/users/skosukhin/gists{/gist_id}","starred_url":"https://api.github.com/users/skosukhin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/skosukhin/subscriptions","organizations_url":"https://api.github.com/users/skosukhin/orgs","repos_url":"https://api.github.com/users/skosukhin/repos","events_url":"https://api.github.com/users/skosukhin/events{/privacy}","received_events_url":"https://api.github.com/users/skosukhin/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2024-03-13T13:06:26Z","updated_at":"2024-03-13T15:20:46Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"draft":false,"pull_request":{"url":"https://api.github.com/repos/tukaani-project/xz/pulls/91","html_url":"https://github.com/tukaani-project/xz/pull/91","diff_url":"https://github.com/tukaani-project/xz/pull/91.diff","patch_url":"https://github.com/tukaani-project/xz/pull/91.patch","merged_at":null},"body":"NVHPC compiler has several issues that make it impossible to build liblzma:\r\n  - the compiler cannot handle unions that contain pointers that are not the first members (in some cases);\r\n  - the compiler cannot handle the assembler code in range_decoder.h (LZMA_RANGE_DECODER_CONFIG has to be set to zero);\r\n  - the compiler fails to produce valid code for delta_decode if the vectorization is enabled, which results in failed tests.\r\n\r\nThis introduces NVHPC-specific workarounds that address the issues.\r\n\r\n## Pull request checklist\r\n\r\nPlease check if your PR fulfills the following requirements:\r\n- [ ] Tests for the changes have been added (for bug fixes / features)\r\n- [ ] Docs have been reviewed and added / updated if needed (for bug fixes / features)\r\n- [ ] Build was run locally and without warnings or errors\r\n- [x] All previous and new tests pass\r\n\r\n\r\n## Pull request type\r\n\r\nPlease check the type of change your PR introduces:\r\n- [ ] Bugfix\r\n- [ ] Feature\r\n- [ ] Code style update (formatting, renaming, typo fix)\r\n- [ ] Refactoring (no functional changes, no api changes)\r\n- [ ] Build related changes\r\n- [ ] Documentation content changes\r\n- [x] Other (please describe): workarounds for the compiler\r\n\r\n\r\n## What is the current behavior?\r\nIt's not possible to build and get the tests pass with any existing release of the NVHPC compiler even when configuring as follows:\r\n```console\r\n$ ./configure --disable-symbol-versions CPPFLAGS='-DLZMA_RANGE_DECODER_CONFIG=0' CFLAGS='-O'\r\n```\r\n(`-O` is the same as the default `-O2` but without SIMD)\r\n\r\n\r\n## What is the new behavior?\r\nIt is possible to build and get the tests pass with any existing release of the NVHPC compiler when configuring as follows:\r\n```console\r\n$ ./configure --disable-symbol-versions\r\n```\r\n\r\n## Does this introduce a breaking change?\r\n\r\n- [ ] Yes\r\n- [x] No\r\n\r\n\r\n## Other information\r\n\r\nI don't know if there is any interest in supporting NVHPC and I'd understand if there's none.","reactions":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/91/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/tukaani-project/xz/issues/91/timeline","performed_via_github_app":null,"state_reason":null},"comment":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/comments/1994649483","html_url":"https://github.com/tukaani-project/xz/pull/91#issuecomment-1994649483","issue_url":"https://api.github.com/repos/tukaani-project/xz/issues/91","id":1994649483,"node_id":"IC_kwDOIQBEvs524--L","user":{"login":"skosukhin","id":19591868,"node_id":"MDQ6VXNlcjE5NTkxODY4","avatar_url":"https://avatars.githubusercontent.com/u/19591868?v=4","gravatar_id":"","url":"https://api.github.com/users/skosukhin","html_url":"https://github.com/skosukhin","followers_url":"https://api.github.com/users/skosukhin/followers","following_url":"https://api.github.com/users/skosukhin/following{/other_user}","gists_url":"https://api.github.com/users/skosukhin/gists{/gist_id}","starred_url":"https://api.github.com/users/skosukhin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/skosukhin/subscriptions","organizations_url":"https://api.github.com/users/skosukhin/orgs","repos_url":"https://api.github.com/users/skosukhin/repos","events_url":"https://api.github.com/users/skosukhin/events{/privacy}","received_events_url":"https://api.github.com/users/skosukhin/received_events","type":"User","site_admin":false},"created_at":"2024-03-13T15:20:45Z","updated_at":"2024-03-13T15:20:45Z","author_association":"NONE","body":"I was also surprised that `#pragma routine novector` made the difference for `delta_decode`, which does not have a loop. It might have to do with the `restrict`. I haven't dug deeper.\r\n\r\nThe problems in `delta_decoder.c` and `range_decoder.h` have not been reported yet. The one in `string_conversion.c` was reported long ago but NVIDIA does not seem to have high priority for their C compiler (C++ and Fortran get more attention). We monitor several issues ([1](https://gitlab.dkrz.de/dkrz-sw/yac/-/blob/c8fe4fe545ab2e6090afc649fb28263333bb4daf/src/config_yaml.c#L213-222), [2](https://gitlab.dkrz.de/dkrz-sw/yac/-/blob/c8fe4fe545ab2e6090afc649fb28263333bb4daf/src/config_yaml.c#L245-253), [3](https://gitlab.dkrz.de/dkrz-sw/yac/-/blob/c8fe4fe545ab2e6090afc649fb28263333bb4daf/src/config_yaml.c#L268-271)) in our project and I will let you know if anything changes.","reactions":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/comments/1994649483/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null}},"public":true,"created_at":"2024-03-13T15:20:46Z","org":{"id":116083088,"login":"tukaani-project","gravatar_id":"","url":"https://api.github.com/orgs/tukaani-project","avatar_url":"https://avatars.githubusercontent.com/u/116083088?"}}
{"id":"36517549348","type":"IssueCommentEvent","actor":{"id":78042786,"login":"JiaT75","display_login":"JiaT75","gravatar_id":"","url":"https://api.github.com/users/JiaT75","avatar_url":"https://avatars.githubusercontent.com/u/78042786?"},"repo":{"id":553665726,"name":"tukaani-project/xz","url":"https://api.github.com/repos/tukaani-project/xz"},"payload":{"action":"created","issue":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/91","repository_url":"https://api.github.com/repos/tukaani-project/xz","labels_url":"https://api.github.com/repos/tukaani-project/xz/issues/91/labels{/name}","comments_url":"https://api.github.com/repos/tukaani-project/xz/issues/91/comments","events_url":"https://api.github.com/repos/tukaani-project/xz/issues/91/events","html_url":"https://github.com/tukaani-project/xz/pull/91","id":2183979010,"node_id":"PR_kwDOIQBEvs5pgS85","number":91,"title":"liblzma: Fix building with NVHPC (NVIDIA HPC SDK).","user":{"login":"skosukhin","id":19591868,"node_id":"MDQ6VXNlcjE5NTkxODY4","avatar_url":"https://avatars.githubusercontent.com/u/19591868?v=4","gravatar_id":"","url":"https://api.github.com/users/skosukhin","html_url":"https://github.com/skosukhin","followers_url":"https://api.github.com/users/skosukhin/followers","following_url":"https://api.github.com/users/skosukhin/following{/other_user}","gists_url":"https://api.github.com/users/skosukhin/gists{/gist_id}","starred_url":"https://api.github.com/users/skosukhin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/skosukhin/subscriptions","organizations_url":"https://api.github.com/users/skosukhin/orgs","repos_url":"https://api.github.com/users/skosukhin/repos","events_url":"https://api.github.com/users/skosukhin/events{/privacy}","received_events_url":"https://api.github.com/users/skosukhin/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2024-03-13T13:06:26Z","updated_at":"2024-03-13T15:50:19Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"draft":false,"pull_request":{"url":"https://api.github.com/repos/tukaani-project/xz/pulls/91","html_url":"https://github.com/tukaani-project/xz/pull/91","diff_url":"https://github.com/tukaani-project/xz/pull/91.diff","patch_url":"https://github.com/tukaani-project/xz/pull/91.patch","merged_at":null},"body":"NVHPC compiler has several issues that make it impossible to build liblzma:\r\n  - the compiler cannot handle unions that contain pointers that are not the first members (in some cases);\r\n  - the compiler cannot handle the assembler code in range_decoder.h (LZMA_RANGE_DECODER_CONFIG has to be set to zero);\r\n  - the compiler fails to produce valid code for delta_decode if the vectorization is enabled, which results in failed tests.\r\n\r\nThis introduces NVHPC-specific workarounds that address the issues.\r\n\r\n## Pull request checklist\r\n\r\nPlease check if your PR fulfills the following requirements:\r\n- [ ] Tests for the changes have been added (for bug fixes / features)\r\n- [ ] Docs have been reviewed and added / updated if needed (for bug fixes / features)\r\n- [ ] Build was run locally and without warnings or errors\r\n- [x] All previous and new tests pass\r\n\r\n\r\n## Pull request type\r\n\r\nPlease check the type of change your PR introduces:\r\n- [ ] Bugfix\r\n- [ ] Feature\r\n- [ ] Code style update (formatting, renaming, typo fix)\r\n- [ ] Refactoring (no functional changes, no api changes)\r\n- [ ] Build related changes\r\n- [ ] Documentation content changes\r\n- [x] Other (please describe): workarounds for the compiler\r\n\r\n\r\n## What is the current behavior?\r\nIt's not possible to build and get the tests pass with any existing release of the NVHPC compiler even when configuring as follows:\r\n```console\r\n$ ./configure --disable-symbol-versions CPPFLAGS='-DLZMA_RANGE_DECODER_CONFIG=0' CFLAGS='-O'\r\n```\r\n(`-O` is the same as the default `-O2` but without SIMD)\r\n\r\n\r\n## What is the new behavior?\r\nIt is possible to build and get the tests pass with any existing release of the NVHPC compiler when configuring as follows:\r\n```console\r\n$ ./configure --disable-symbol-versions\r\n```\r\n\r\n## Does this introduce a breaking change?\r\n\r\n- [ ] Yes\r\n- [x] No\r\n\r\n\r\n## Other information\r\n\r\nI don't know if there is any interest in supporting NVHPC and I'd understand if there's none.","reactions":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/91/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/tukaani-project/xz/issues/91/timeline","performed_via_github_app":null,"state_reason":null},"comment":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/comments/1994743011","html_url":"https://github.com/tukaani-project/xz/pull/91#issuecomment-1994743011","issue_url":"https://api.github.com/repos/tukaani-project/xz/issues/91","id":1994743011,"node_id":"IC_kwDOIQBEvs525Vzj","user":{"login":"JiaT75","id":78042786,"node_id":"MDQ6VXNlcjc4MDQyNzg2","avatar_url":"https://avatars.githubusercontent.com/u/78042786?v=4","gravatar_id":"","url":"https://api.github.com/users/JiaT75","html_url":"https://github.com/JiaT75","followers_url":"https://api.github.com/users/JiaT75/followers","following_url":"https://api.github.com/users/JiaT75/following{/other_user}","gists_url":"https://api.github.com/users/JiaT75/gists{/gist_id}","starred_url":"https://api.github.com/users/JiaT75/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JiaT75/subscriptions","organizations_url":"https://api.github.com/users/JiaT75/orgs","repos_url":"https://api.github.com/users/JiaT75/repos","events_url":"https://api.github.com/users/JiaT75/events{/privacy}","received_events_url":"https://api.github.com/users/JiaT75/received_events","type":"User","site_admin":false},"created_at":"2024-03-13T15:50:18Z","updated_at":"2024-03-13T15:50:18Z","author_association":"MEMBER","body":"> I was also surprised that `#pragma routine novector` made the difference for `delta_decode`, which does not have a loop. It might have to do with the `restrict`. I haven't dug deeper.\r\n\r\nIts likely the call to `decode_buffer()` is being inlined, so that could be why some sort of vectorization is happening. \r\n\r\n> The problems in `delta_decoder.c` and `range_decoder.h` have not been reported yet.\r\n\r\nDoes NVHPC support any kind of inline assembly, or is there something we are using that specifically is a problem?\r\n\r\n> We monitor several issues ([1](https://gitlab.dkrz.de/dkrz-sw/yac/-/blob/c8fe4fe545ab2e6090afc649fb28263333bb4daf/src/config_yaml.c#L213-222), [2](https://gitlab.dkrz.de/dkrz-sw/yac/-/blob/c8fe4fe545ab2e6090afc649fb28263333bb4daf/src/config_yaml.c#L245-253), [3](https://gitlab.dkrz.de/dkrz-sw/yac/-/blob/c8fe4fe545ab2e6090afc649fb28263333bb4daf/src/config_yaml.c#L268-271)) in our project and I will let you know if anything changes.\r\n\r\nThanks!\r\n\r\n","reactions":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/comments/1994743011/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null}},"public":true,"created_at":"2024-03-13T15:50:19Z","org":{"id":116083088,"login":"tukaani-project","gravatar_id":"","url":"https://api.github.com/orgs/tukaani-project","avatar_url":"https://avatars.githubusercontent.com/u/116083088?"}}
