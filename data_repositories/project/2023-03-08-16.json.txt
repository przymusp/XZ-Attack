{"id":"27581070539","type":"IssueCommentEvent","actor":{"id":120408189,"login":"Larhzu","display_login":"Larhzu","gravatar_id":"","url":"https://api.github.com/users/Larhzu","avatar_url":"https://avatars.githubusercontent.com/u/120408189?"},"repo":{"id":553665726,"name":"tukaani-project/xz","url":"https://api.github.com/repos/tukaani-project/xz"},"payload":{"action":"created","issue":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/43","repository_url":"https://api.github.com/repos/tukaani-project/xz","labels_url":"https://api.github.com/repos/tukaani-project/xz/issues/43/labels{/name}","comments_url":"https://api.github.com/repos/tukaani-project/xz/issues/43/comments","events_url":"https://api.github.com/repos/tukaani-project/xz/issues/43/events","html_url":"https://github.com/tukaani-project/xz/pull/43","id":1610442947,"node_id":"PR_kwDOIQBEvs5LUTCK","number":43,"title":"xz: Improve compatibility with systems without capability mode support","user":{"login":"delphij","id":1045626,"node_id":"MDQ6VXNlcjEwNDU2MjY=","avatar_url":"https://avatars.githubusercontent.com/u/1045626?v=4","gravatar_id":"","url":"https://api.github.com/users/delphij","html_url":"https://github.com/delphij","followers_url":"https://api.github.com/users/delphij/followers","following_url":"https://api.github.com/users/delphij/following{/other_user}","gists_url":"https://api.github.com/users/delphij/gists{/gist_id}","starred_url":"https://api.github.com/users/delphij/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/delphij/subscriptions","organizations_url":"https://api.github.com/users/delphij/orgs","repos_url":"https://api.github.com/users/delphij/repos","events_url":"https://api.github.com/users/delphij/events{/privacy}","received_events_url":"https://api.github.com/users/delphij/received_events","type":"User","site_admin":false},"labels":[{"id":4687621022,"node_id":"LA_kwDOIQBEvs8AAAABF2drng","url":"https://api.github.com/repos/tukaani-project/xz/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":5016626567,"node_id":"LA_kwDOIQBEvs8AAAABKwOlhw","url":"https://api.github.com/repos/tukaani-project/xz/labels/5.4.2","name":"5.4.2","color":"006b75","default":false,"description":"Item earmarked for 5.4.2 release"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2023-03-05T23:55:38Z","updated_at":"2023-03-08T16:15:36Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"draft":false,"pull_request":{"url":"https://api.github.com/repos/tukaani-project/xz/pulls/43","html_url":"https://github.com/tukaani-project/xz/pull/43","diff_url":"https://github.com/tukaani-project/xz/pull/43.diff","patch_url":"https://github.com/tukaani-project/xz/pull/43.patch","merged_at":null},"body":"When the kernel is built without capability mode support, or when using an emulator like qemu-user-static that does not translate system calls, these calls will return a negative number and set the errno to ENOSYS. However, this error does not indicate a real programming or runtime error and is generally ignored by base system applications built with capability mode sandboxing.\r\n\r\n## Pull request checklist\r\n\r\nPlease check if your PR fulfills the following requirements:\r\n- [ ] Tests for the changes have been added (for bug fixes / features)\r\n- [ ] Docs have been reviewed and added / updated if needed (for bug fixes / features)\r\n- [X] Build was run locally and without warnings or errors\r\n- [X] All previous and new tests pass\r\n\r\n\r\n## Pull request type\r\n\r\nPlease check the type of change your PR introduces:\r\n- [X] Bugfix\r\n\r\n## What is the current behavior?\r\n\r\nxz would abort execution with `Failed to enable the sandbox` when capability mode system calls failed, regardless if the host system have capability mode support.\r\n\r\nIt is advisable that binaries with capability mode sandbox enabled to ignore capability mode errors when they are solely because the system does not have the support, this is done on many applications including OpenSSH and base system utilities.  In fact, FreeBSD have a set of macros called [capsicum_helpers(3)](https://man.freebsd.org/cgi/man.cgi?query=capsicum_helpers&sektion=3) which [wraps](https://cgit.freebsd.org/src/tree/lib/libcapsicum/capsicum_helpers.h#n153) this anti-pattern.\r\n\r\n<!-- Related issue this PR addresses, if applicable -->\r\nRelated Issue URL: https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=269185\r\n\r\n\r\n## What is the new behavior?\r\n\r\nxz will ignore sandbox failures caused by the kernel lacking support of capsicum mode.\r\n\r\n## Does this introduce a breaking change?\r\n\r\n- [ ] Yes\r\n- [X] No\r\n\r\n\r\n## Other information\r\n\r\nThe proposed patch modified `cap_*` calls to also check if the failure was caused by the lack of support (ENOSYS) and make it ignore it.  If possible, it's probably reasonable to just use `caph_*` calls found in `capsicum_helpers(3)`.","reactions":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/43/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/tukaani-project/xz/issues/43/timeline","performed_via_github_app":null,"state_reason":null},"comment":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/comments/1460441163","html_url":"https://github.com/tukaani-project/xz/pull/43#issuecomment-1460441163","issue_url":"https://api.github.com/repos/tukaani-project/xz/issues/43","id":1460441163,"node_id":"IC_kwDOIQBEvs5XDJBL","user":{"login":"Larhzu","id":120408189,"node_id":"U_kgDOBy1IfQ","avatar_url":"https://avatars.githubusercontent.com/u/120408189?v=4","gravatar_id":"","url":"https://api.github.com/users/Larhzu","html_url":"https://github.com/Larhzu","followers_url":"https://api.github.com/users/Larhzu/followers","following_url":"https://api.github.com/users/Larhzu/following{/other_user}","gists_url":"https://api.github.com/users/Larhzu/gists{/gist_id}","starred_url":"https://api.github.com/users/Larhzu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Larhzu/subscriptions","organizations_url":"https://api.github.com/users/Larhzu/orgs","repos_url":"https://api.github.com/users/Larhzu/repos","events_url":"https://api.github.com/users/Larhzu/events{/privacy}","received_events_url":"https://api.github.com/users/Larhzu/received_events","type":"User","site_admin":false},"created_at":"2023-03-08T16:15:36Z","updated_at":"2023-03-08T16:15:36Z","author_association":"MEMBER","body":"@JiaT75: I apologize for the inappropriate harsh message above. I shouldn't post when in bad mood.\r\n\r\n@delphij: OK, so avoiding non-zero exit status is essential.\r\n\r\nIs a warning message good or bad? I thought it's not good to print a warning on `ENOSYS` since the reason for the error is clearly outside of xz (kernel or emulator not supporting the syscall) and it could be annoying if all Capsicum processes showed such warnings on every invocation. But it can be argued that it's good to inform users about the situation.\r\n\r\nIf cap_rights_limit(2) can return `ENOSYS` then I suppose it doesn't hurt to check it even after a successful call to cap_enter(2).\r\n\r\nOther OSes with Capsicum support I hadn't thought about. So I guess for now it's simplest to avoid capsicum_helpers(3).\r\n\r\nI tested the new cap_rights_limit calls on FreeBSD 13.1 and they seem to work even with `sysctl kern.trap_enotcap=1` so I guess they *might* be safe to add even to the next stable release but it can be decided later.","reactions":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/comments/1460441163/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null}},"public":true,"created_at":"2023-03-08T16:15:36Z","org":{"id":116083088,"login":"tukaani-project","gravatar_id":"","url":"https://api.github.com/orgs/tukaani-project","avatar_url":"https://avatars.githubusercontent.com/u/116083088?"}}
{"id":"27582023561","type":"WatchEvent","actor":{"id":120408189,"login":"Larhzu","display_login":"Larhzu","gravatar_id":"","url":"https://api.github.com/users/Larhzu","avatar_url":"https://avatars.githubusercontent.com/u/120408189?"},"repo":{"id":553665726,"name":"tukaani-project/xz","url":"https://api.github.com/repos/tukaani-project/xz"},"payload":{"action":"started"},"public":true,"created_at":"2023-03-08T16:49:51Z","org":{"id":116083088,"login":"tukaani-project","gravatar_id":"","url":"https://api.github.com/orgs/tukaani-project","avatar_url":"https://avatars.githubusercontent.com/u/116083088?"}}
