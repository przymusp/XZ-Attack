{"id":"37880429261","type":"IssueCommentEvent","actor":{"id":46978960,"login":"marc-hb","display_login":"marc-hb","gravatar_id":"","url":"https://api.github.com/users/marc-hb","avatar_url":"https://avatars.githubusercontent.com/u/46978960?"},"repo":{"id":4542716,"name":"NixOS/nixpkgs","url":"https://api.github.com/repos/NixOS/nixpkgs"},"payload":{"action":"created","issue":{"url":"https://api.github.com/repos/NixOS/nixpkgs/issues/8567","repository_url":"https://api.github.com/repos/NixOS/nixpkgs","labels_url":"https://api.github.com/repos/NixOS/nixpkgs/issues/8567/labels{/name}","comments_url":"https://api.github.com/repos/NixOS/nixpkgs/issues/8567/comments","events_url":"https://api.github.com/repos/NixOS/nixpkgs/issues/8567/events","html_url":"https://github.com/NixOS/nixpkgs/issues/8567","id":91945224,"node_id":"MDU6SXNzdWU5MTk0NTIyNA==","number":8567,"title":"`fetchgit` with `leaveDotGit = true` is still not completely deterministic","user":{"login":"wizeman","id":168610,"node_id":"MDQ6VXNlcjE2ODYxMA==","avatar_url":"https://avatars.githubusercontent.com/u/168610?v=4","gravatar_id":"","url":"https://api.github.com/users/wizeman","html_url":"https://github.com/wizeman","followers_url":"https://api.github.com/users/wizeman/followers","following_url":"https://api.github.com/users/wizeman/following{/other_user}","gists_url":"https://api.github.com/users/wizeman/gists{/gist_id}","starred_url":"https://api.github.com/users/wizeman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wizeman/subscriptions","organizations_url":"https://api.github.com/users/wizeman/orgs","repos_url":"https://api.github.com/users/wizeman/repos","events_url":"https://api.github.com/users/wizeman/events{/privacy}","received_events_url":"https://api.github.com/users/wizeman/received_events","type":"User","site_admin":false},"labels":[{"id":290143264,"node_id":"MDU6TGFiZWwyOTAxNDMyNjQ=","url":"https://api.github.com/repos/NixOS/nixpkgs/labels/6.topic:%20reproducible%20builds","name":"6.topic: reproducible builds","color":"fef2c0","default":false,"description":null},{"id":786406134,"node_id":"MDU6TGFiZWw3ODY0MDYxMzQ=","url":"https://api.github.com/repos/NixOS/nixpkgs/labels/6.topic:%20fetch","name":"6.topic: fetch","color":"fef2c0","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":63,"created_at":"2015-06-30T00:50:50Z","updated_at":"2024-04-27T19:01:34Z","closed_at":null,"author_association":"MEMBER","active_lock_reason":null,"body":"The hash of the `cargo` git repository returned by `fetchgit` has changed twice already, even though the git revision didn't change (see de322b48b7006cf72d6adc37a833f2e045950536 and now #8566).\n\nSee also: #4752 and #4767\n\ncc @bjornfor and @madjar (due to #4767).\n","reactions":{"url":"https://api.github.com/repos/NixOS/nixpkgs/issues/8567/reactions","total_count":3,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/NixOS/nixpkgs/issues/8567/timeline","performed_via_github_app":null,"state_reason":null},"comment":{"url":"https://api.github.com/repos/NixOS/nixpkgs/issues/comments/2081152014","html_url":"https://github.com/NixOS/nixpkgs/issues/8567#issuecomment-2081152014","issue_url":"https://api.github.com/repos/NixOS/nixpkgs/issues/8567","id":2081152014,"node_id":"IC_kwDOAEVQ_M58C9wO","user":{"login":"marc-hb","id":46978960,"node_id":"MDQ6VXNlcjQ2OTc4OTYw","avatar_url":"https://avatars.githubusercontent.com/u/46978960?v=4","gravatar_id":"","url":"https://api.github.com/users/marc-hb","html_url":"https://github.com/marc-hb","followers_url":"https://api.github.com/users/marc-hb/followers","following_url":"https://api.github.com/users/marc-hb/following{/other_user}","gists_url":"https://api.github.com/users/marc-hb/gists{/gist_id}","starred_url":"https://api.github.com/users/marc-hb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marc-hb/subscriptions","organizations_url":"https://api.github.com/users/marc-hb/orgs","repos_url":"https://api.github.com/users/marc-hb/repos","events_url":"https://api.github.com/users/marc-hb/events{/privacy}","received_events_url":"https://api.github.com/users/marc-hb/received_events","type":"User","site_admin":false},"created_at":"2024-04-27T19:01:33Z","updated_at":"2024-04-27T19:01:33Z","author_association":"NONE","body":"> It could be fun if nix derivations could accept a different checksumming method. Even if the folder checksum differs I trust git to always give me the same checked-out content. Having to provide both the git ref and the folder checksum feels redundant.\r\n\r\n...\r\n\r\n> 1. Compute the hash of the whole directory, excluding .git.\r\n> 2. Get the checked-out commit (in git terms, that's what makes a repo \"reproducible\").\r\n> 3. Combine both previous points to get the final hash.\r\n\r\n> Obviously it's not 100% pure, but it would be OK for most projects that rely on the availability of the .git folder.\r\n\r\nThis looks like the only sustainable solution: TRUSTING git and delegating to git some of nix' work.\r\n\r\nAll other solutions are conceptually flawed and hackish  because git and nix do more or less the same job so they will always keep stepping on each other toes.\r\n\r\nWith the infamous autotools finally dying, the number of projects that fail to build when .git is missing will only go up and up. From the perspective of a  maintainer who has never heard about nix or similar (= most maintainers), abandoning tarballs simplifies the source release process greatly which (the irony) helps ensuring build reproducibility. Dropping the tarball layer of indirection also reduces the attack surface: see for instance the recent jiaT75 attack on XZ.\r\n\r\n\r\n> Excluding .git from the hash and \"trusting\" it to be deterministic for any (reasonable) interacton isn't a terrible idea IMO but would need to add complexity and special cases to Nix itself which I don't think we should do.\r\n\r\nYes this the price to pay: trusting git requires special cases in nix code and some \"impurity\". But it does not seem avoidable.\r\n\r\nChecksumming .git/ seems futile. However it should be practical to checksum's git _outputs_ and use that instead: `git describe`, `git tag` etc. Git's user interface is obviously much more stable than its internals.\r\n","reactions":{"url":"https://api.github.com/repos/NixOS/nixpkgs/issues/comments/2081152014/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null}},"public":true,"created_at":"2024-04-27T19:01:35Z","org":{"id":487568,"login":"NixOS","gravatar_id":"","url":"https://api.github.com/orgs/NixOS","avatar_url":"https://avatars.githubusercontent.com/u/487568?"}}
