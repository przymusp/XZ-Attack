{"id":"36083836011","type":"IssueCommentEvent","actor":{"id":120408189,"login":"Larhzu","display_login":"Larhzu","gravatar_id":"","url":"https://api.github.com/users/Larhzu","avatar_url":"https://avatars.githubusercontent.com/u/120408189?"},"repo":{"id":553665726,"name":"tukaani-project/xz","url":"https://api.github.com/repos/tukaani-project/xz"},"payload":{"action":"created","issue":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/89","repository_url":"https://api.github.com/repos/tukaani-project/xz","labels_url":"https://api.github.com/repos/tukaani-project/xz/issues/89/labels{/name}","comments_url":"https://api.github.com/repos/tukaani-project/xz/issues/89/comments","events_url":"https://api.github.com/repos/tukaani-project/xz/issues/89/events","html_url":"https://github.com/tukaani-project/xz/issues/89","id":2156864527,"node_id":"I_kwDOIQBEvs6AjyQP","number":89,"title":"[Bug]: xz: Reduced the number of threads from ... to not exceed the memory usage limit of ... MiB","user":{"login":"asarubbo","id":4741819,"node_id":"MDQ6VXNlcjQ3NDE4MTk=","avatar_url":"https://avatars.githubusercontent.com/u/4741819?v=4","gravatar_id":"","url":"https://api.github.com/users/asarubbo","html_url":"https://github.com/asarubbo","followers_url":"https://api.github.com/users/asarubbo/followers","following_url":"https://api.github.com/users/asarubbo/following{/other_user}","gists_url":"https://api.github.com/users/asarubbo/gists{/gist_id}","starred_url":"https://api.github.com/users/asarubbo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/asarubbo/subscriptions","organizations_url":"https://api.github.com/users/asarubbo/orgs","repos_url":"https://api.github.com/users/asarubbo/repos","events_url":"https://api.github.com/users/asarubbo/events{/privacy}","received_events_url":"https://api.github.com/users/asarubbo/received_events","type":"User","site_admin":false},"labels":[{"id":4687621022,"node_id":"LA_kwDOIQBEvs8AAAABF2drng","url":"https://api.github.com/repos/tukaani-project/xz/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2024-02-27T15:16:41Z","updated_at":"2024-02-28T10:59:52Z","closed_at":"2024-02-28T08:21:38Z","author_association":"NONE","active_lock_reason":null,"body":"### Describe the bug\r\n\r\nSince few days I updated to 5.6.0.\r\n\r\nWhen I try to compress text I always get:\r\n\r\n```\r\nxz: Reduced the number of threads from 64 to X to not exceed the memory usage limit of .. MiB\r\n```\r\n\r\nSo to use threads I increased the memory limit around 3GB but still I get the message.\r\n\r\nAs a POC I did:\r\n```\r\necho \"a\" > file\r\nfor i in {1..64} ; do echo $i ; xz -k -f -z -9 -T $i -M 3000000000 file ; done\r\n```\r\nAnd I discovered that with `i=3` it reduces threads from `i` to 2\r\n\r\n`xz -H` says that `-M` accepts the LIMIT in bytes, so 3000000000 are 3GB of ram.\r\n\r\nIs there anything wrong with it or how much ram I'm supposing to give to the process? \r\n\r\n\r\n\r\n\r\n### Version\r\n\r\n5.6.0\r\n\r\n### Operating System\r\n\r\nGentoo Linux\r\n\r\n### Relevant log output\r\n\r\n_No response_","reactions":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/89/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/tukaani-project/xz/issues/89/timeline","performed_via_github_app":null,"state_reason":"completed"},"comment":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/comments/1968736930","html_url":"https://github.com/tukaani-project/xz/issues/89#issuecomment-1968736930","issue_url":"https://api.github.com/repos/tukaani-project/xz/issues/89","id":1968736930,"node_id":"IC_kwDOIQBEvs51WIqi","user":{"login":"Larhzu","id":120408189,"node_id":"U_kgDOBy1IfQ","avatar_url":"https://avatars.githubusercontent.com/u/120408189?v=4","gravatar_id":"","url":"https://api.github.com/users/Larhzu","html_url":"https://github.com/Larhzu","followers_url":"https://api.github.com/users/Larhzu/followers","following_url":"https://api.github.com/users/Larhzu/following{/other_user}","gists_url":"https://api.github.com/users/Larhzu/gists{/gist_id}","starred_url":"https://api.github.com/users/Larhzu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Larhzu/subscriptions","organizations_url":"https://api.github.com/users/Larhzu/orgs","repos_url":"https://api.github.com/users/Larhzu/repos","events_url":"https://api.github.com/users/Larhzu/events{/privacy}","received_events_url":"https://api.github.com/users/Larhzu/received_events","type":"User","site_admin":false},"created_at":"2024-02-28T10:59:52Z","updated_at":"2024-02-28T10:59:52Z","author_association":"MEMBER","body":"> Is there anything wrong with it or how much ram I'm supposing to\n> give to the process?\n\nI realized only now what made you ask this question. :-( At the default\nverbosity level, the message only tells what the limit is but not how\nmuch is needed. One needs -vv to see what would actually be required\nbut there is no hint about the need for -vv.\n\n> As a user I would not like to see that by default, but in verbose\n> mode or debug mode. But it is a matter of fact that putting that in\n> verbose/debug mode means that a lot of users won't discover that, and\n> then not increase the memory limit if they need it.\n> \n> So for me is fine as-is.\n\nYou summarized the problem well. The on-going thread on xz-devel might\nbe worth reading too about the identified pros and cons of different\noptions, including the problems with the current behavior:\n\n***@***.***/msg00655.html\n\nThreaded compression has been supported in for nine years but only now\nis the threaded mode enabled by default. Thus more people are seeing\nthese messages now.\n\nHistorically, memory usage limits in xz have been a controversial\ntopic. Threaded compression with automatic number of threads and\nthreaded decompression with automatic or user-defined number of threads\nrequire a memory limit, otherwise the memory usage could become\nridiculous in some cases. That could cause security issues (denial of\nservice).\n\nThe current automatic limit is 25 % of total RAM (in 32-bit xz\nexecutables also at most 1400 MiB). Some people think it's a bit too\nlow, some think it's a bit too high.\n\nThere is also a Linux-specific suggestion of using MemAvailable from\n/proc/meminfo to determine how much memory could be used. For example,\nusing 80 % of MemAvailable. That could often allow more than 25 % of\nRAM. This idea wasn't discussed and polished for XZ Utils 5.6.0 though\nbut it likely should be revisited later. And if done on Linux, a\nsimilar thing likely should be done on a few other OSes too.\n\n> I opened the issue because in my opinion the required memory is\n> too high. \n\nWhile I don't know about your use case, in general it can be worth\nconsidering if -9 is the best compression preset to use. -9 uses 64 MiB\ndictionary and 192 MiB block size. Perhaps --block-size=96MiB would\ngive good enough compression while allowing more threads and thus more\nspeed if the file size isn't huge (gigabytes).\n\nOr using the default -6 (8 MiB dict, 24 MiB blocks) or a bit higher -7\n(16 MiB dict, 48 MiB blocks) to get better parallelization with\nmedium-sized files at the expense of worse compression.\n\nThe default block_size = 3 * dict_size is somewhat arbitrary. It's a\ncompromise between compression ratio and memory usage. If memory usage\ndoesn't matter, block_size = dict_size is the best. Multiplier in the\nrange 1-4 is likely a good choice in typical cases.\n\nxz --help includes a warning about memory usage with presets 7-9. When\nit was written, computers with 256-512 MiB RAM weren't obsolete. With\nthreading that warning has some point again.\n\nNote that -9 and its 64 MiB dictionary isn't the maximum possible\ncompression setting. It's just the highest preset level. The encoder\nsupports up to 1536 MiB. Some use 256 MiB together with a fast preset\nbecause *with some types of data* it can be both faster than -9 and\ncompress the same (or even better):\n\n    xz --lzma2=preset=1,dict=256MiB\n\nSo it's about understanding the use case and doing some experimenting.\n\n> I'd suggest to put a link or an explanation about why the provided\n> memory limit is not enough. That would avoid a lot of tickets here, I\n> think.\n\nI recognize that there is a problem and it could be documented\nsomewhere and perhaps the message from xz should be clearer too. If the\nthread count reduction was shown at only -vv then it likely would be\nclearer already except that fewer people would be aware of the reduced\nthread count. Right now I don't know what is the best solution. It\nmight be that in the short term the message is put behind -v or -vv to\nsolve one set of problems and the solution is tweaked later.\n\nThanks!\n","reactions":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/comments/1968736930/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null}},"public":true,"created_at":"2024-02-28T10:59:53Z","org":{"id":116083088,"login":"tukaani-project","gravatar_id":"","url":"https://api.github.com/orgs/tukaani-project","avatar_url":"https://avatars.githubusercontent.com/u/116083088?"}}
