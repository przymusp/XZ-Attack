commit 5002beb278901538a914b425845439465b9410c7
Author: jiat75 <jiat0218@gmail.com>
Date:   Tue May 17 20:44:19 2022 +0800

    Color coding is now optional. Removed timing metrics. Removed __FUNCTION__ macro because it is not always compatible

diff --git a/README.md b/README.md
index 13aca8a..84f083c 100644
--- a/README.md
+++ b/README.md
@@ -45,13 +45,14 @@ The test runner can be run with a few simple command line arguments.
 | -m               | Output machine readable                          |
 | -s               | Skip the rest of the test when an assert fails   |
 | -k \<marker>     | prepend \<marker> before machine readable output |
+| -c               | Color code output (green success, red failure)   |
 | help             | Output help message                              |
 
 ## Example Usage
 
 ```C
 // Sample test
-void my_test() {
+STEST(my_test)
   int actual = 10;
   assert_int_equal(10, actual);
 
@@ -59,10 +60,16 @@ void my_test() {
   assert_string_contains("Hello", actual_str);
 }
 
-// Another sample Test
-void another_test() {
+STEST_HELPER(int, helper, int arg1, int arg2)
+  assert_true(arg2 > arg1);
+  return arg2 - arg1;
+}
+
+// Another sample Test calling a helper function
+STEST(another_test)
   assert_true(1);
   assert_false(0);
+  assert_int_equal(helper(1, 2));
 }
 
 // Sample fixture
diff --git a/src/stest.c b/src/stest.c
index 9fe291f..19639ee 100644
--- a/src/stest.c
+++ b/src/stest.c
@@ -1,11 +1,12 @@
 /*
- * Copyright (c) 2021 Jia Tan
  * Copyright (c) 2010 Keith Nicholas
+ * Copyright (c) 2021 Jia Tan
  */
 
 #include "stest.h"
-#include <string.h>
 #include <setjmp.h>
+#include <stdio.h>
+#include <string.h>
 
 #ifdef STEST_INTERNAL_TESTS
 static int stest_last_passed = 0;
@@ -38,7 +39,6 @@ static int stests_passed = 0;
 static int stests_failed = 0;
 static int stest_display_only = 0;
 static int stest_verbose = 0;
-static int stest_skip_test_if_assert_fails = 0;
 static int vs_mode = 0;
 static int stest_machine_readable = 0;
 static int stest_color_output = 0;
@@ -50,15 +50,14 @@ static int stest_fixture_tests_failed = 0;
 static const char *stest_fixture_filter;
 static const char *stest_test_filter;
 
+static jmp_buf env;
+static int skip_failed_test;
+
 static stest_void_void stest_suite_setup_func = 0;
 static stest_void_void stest_suite_teardown_func = 0;
 static stest_void_void stest_fixture_setup = 0;
 static stest_void_void stest_fixture_teardown = 0;
 
-static jmp_buf env;
-
-unsigned int GetTickCount(void);
-int stest_is_string_equal_i(const char *s1, const char *s2);
 int stest_is_display_only(void);
 const char *test_file_name(const char *path);
 static int stest_can_color(void);
@@ -72,34 +71,6 @@ int stest_parse_commandline_option_with_value(stest_testrunner_t *runner,
 void stest_interpret_commandline(stest_testrunner_t *runner);
 void stest_testrunner_create(stest_testrunner_t *runner, int argc, char **argv);
 
-#define SECONDS_TO_MILLISECONDS(sec) sec * 1000
-#define MICRO_SECONDS_TO_MILLISECONDS(microsec) microsec / 1000
-
-#ifdef WIN32
-#include "windows.h"
-int stest_is_string_equal_i(const char *s1, const char *s2) {
-#pragma warning(disable : 4996)
-  return stricmp(s1, s2) == 0;
-}
-
-#else
-#include <strings.h>
-#include <sys/time.h>
-#include <unistd.h>
-
-unsigned int GetTickCount(void) {
-  struct timeval current_time;
-  gettimeofday(&current_time, NULL);
-  return SECONDS_TO_MILLISECONDS(current_time.tv_sec) +
-         MICRO_SECONDS_TO_MILLISECONDS(current_time.tv_usec);
-}
-
-int stest_is_string_equal_i(const char *s1, const char *s2) {
-  return strcasecmp(s1, s2) == 0;
-}
-
-#endif
-
 void (*stest_simple_test_result)(int passed, const char *reason,
                                  const char *function, unsigned int line) =
     stest_simple_test_result_log;
@@ -147,15 +118,6 @@ const char *test_file_name(const char *path) {
 
 static int stest_can_color(void) { return stest_color_output; }
 
-static void stest_determine_color_output(FILE *standard_out) {
-#ifdef WIN32
-  // Output coloring is not supported on windows
-  stest_color_output = 0;
-#else
-  stest_color_output = isatty(fileno(standard_out));
-#endif
-}
-
 static void stest_add_color(char *outstr, const char *instr,
                             const char *color) {
   if(stest_can_color()) {
@@ -168,7 +130,7 @@ static void stest_add_color(char *outstr, const char *instr,
 
 static void stest_log_failure(const char *reason, const char *function,
                               unsigned int line) {
-  char failed[100];
+  char failed[STEST_PRINT_BUFFER_SIZE];
   stest_add_color(failed, reason, STEST_RED);
   if(vs_mode) {
     printf("%s (%u)		%s,%s\r\n", stest_current_fixture_path, line,
@@ -180,7 +142,7 @@ static void stest_log_failure(const char *reason, const char *function,
 }
 
 static void stest_log_success(const char *function, unsigned int line) {
-  char passed[30];
+  char passed[STEST_PRINT_BUFFER_SIZE];
   stest_add_color(passed, "Passed", STEST_GREEN);
   printf("%-30s Line %-5d %s\r\n", function, line, passed);
 }
@@ -203,9 +165,9 @@ void stest_simple_test_result_log(int passed, const char *reason,
       stest_log_failure(reason, function, line);
     }
     stests_failed++;
-    if(stest_skip_test_if_assert_fails){
-      longjmp(env, 1);
-    }
+
+    printf("Test has been finished with failure.\r\n");
+    longjmp(env, 1);
   }
   else {
     if(stest_verbose) {
@@ -413,36 +375,27 @@ void stest_test(const char *test, void (*test_function)(void)) {
 
   if(stest_is_display_only()) {
     printf("%s\n", test);
+    return;
   }
 
   stest_suite_setup();
   stest_setup();
 
-  if(stest_skip_test_if_assert_fails){
-    int skip_failed_test = setjmp(env);
-    if(!skip_failed_test){
-      test_function();
-    }
-  }
-  else {
+  skip_failed_test = setjmp(env);
+  if(!skip_failed_test)
     test_function();
-  }
-  
+
   stest_teardown();
   stest_suite_teardown();
   stests_run++;
 }
 
 int run_tests(stest_void_void tests) {
-  unsigned long end;
-  unsigned long start = GetTickCount();
   char s[40];
   tests();
-  end = GetTickCount();
 
   if(stest_is_display_only() || stest_machine_readable)
     return STEST_RET_OK;
-  printf("\r\n");
   if(stests_failed > 0) {
     if(stest_machine_readable) {
       stest_header_printer("Failed", sizeof("Failed") - 1, stest_screen_width,
@@ -474,8 +427,6 @@ int run_tests(stest_void_void tests) {
     sprintf(s, "%d tests run", stests_run);
   }
   stest_header_printer(s, strlen(s), stest_screen_width, ' ');
-  sprintf(s, "in %lu ms", end - start);
-  stest_header_printer(s, strlen(s), stest_screen_width, ' ');
   printf("\r\n");
   stest_header_printer("", sizeof("") - 1, stest_screen_width, '=');
 
@@ -495,9 +446,9 @@ void stest_show_help(void) {
   printf("\t-m:\twill print a machine readable format of the test run, ie :- "
          "\r\n");
   printf("\t   \t<textfixture>,<testname>,<linenumber>,<testresult><EOL>\r\n");
-  printf("\t-s:\twill skip the rest of the test function when an assert fails\r\n");
   printf("\t-k:\twill prepend <marker> before machine readable output \r\n");
   printf("\t   \t<marker> cannot start with a '-'\r\n");
+  printf("\t-c:\twill color output with ANSI escape codes\r\n");
 }
 
 int stest_commandline_has_value_after(stest_testrunner_t *runner, int arg) {
@@ -511,7 +462,7 @@ int stest_commandline_has_value_after(stest_testrunner_t *runner, int arg) {
 int stest_parse_commandline_option_with_value(stest_testrunner_t *runner,
                                               int arg, const char *option,
                                               stest_void_string setter) {
-  if(stest_is_string_equal_i(runner->argv[arg], option)) {
+  if(!strcmp(runner->argv[arg], option)) {
     if(!stest_commandline_has_value_after(runner, arg)) {
       printf("Error: The %s option expects to be followed by a value\r\n",
              option);
@@ -528,22 +479,22 @@ void stest_interpret_commandline(stest_testrunner_t *runner) {
   int arg;
   for(arg = 1; (arg < runner->argc) && (runner->action != STEST_DO_ABORT);
       arg++) {
-    if(stest_is_string_equal_i(runner->argv[arg], "--help") ||
-       stest_is_string_equal_i(runner->argv[arg], "-h")) {
+    if(!strncmp(runner->argv[arg], "--help", sizeof("--help")) ||
+       !strncmp(runner->argv[arg], "-h", sizeof("-h"))) {
       stest_show_help();
       runner->action = STEST_DO_NOTHING;
       return;
     }
-    else if(stest_is_string_equal_i(runner->argv[arg], "-d"))
+    else if(!strncmp(runner->argv[arg], "-d", sizeof("-d")))
       runner->action = STEST_DISPLAY_TESTS;
-    else if(stest_is_string_equal_i(runner->argv[arg], "-v"))
+    else if(!strncmp(runner->argv[arg], "-v", sizeof("-v")))
       stest_verbose = 1;
-    else if(stest_is_string_equal_i(runner->argv[arg], "-vs"))
+    else if(!strncmp(runner->argv[arg], "-vs", sizeof("-vs")))
       vs_mode = 1;
-    else if(stest_is_string_equal_i(runner->argv[arg], "-m"))
+    else if(!strncmp(runner->argv[arg], "-m", sizeof("-m")))
       stest_machine_readable = 1;
-    else if(stest_is_string_equal_i(runner->argv[arg], "-s"))
-      stest_skip_test_if_assert_fails = 1;
+    else if(!strncmp(runner->argv[arg], "-c", sizeof("-c")))
+      stest_color_output = 1;
     else if(stest_parse_commandline_option_with_value(runner, arg, "-t",
                                                       test_filter))
       arg++;
@@ -575,7 +526,6 @@ int stest_testrunner(int argc, char **argv, stest_void_void tests,
                      stest_void_void setup, stest_void_void teardown) {
   stest_testrunner_t runner;
   stest_testrunner_create(&runner, argc, argv);
-  stest_determine_color_output(stdout);
   switch(runner.action) {
   case STEST_DISPLAY_TESTS: {
     stest_display_only = 1;
diff --git a/src/stest.h b/src/stest.h
index 9dadc61..f25dd8f 100644
--- a/src/stest.h
+++ b/src/stest.h
@@ -1,109 +1,118 @@
-/*
- * Copyright (c) 2021 Jia Tan
- * Copyright (c) 2010 Keith Nicholas
- */
-
-#ifndef STEST_H
-#define STEST_H
-#include <stdio.h>
-
-/*
-Defines
-*/
-
-#define STEST_PRINT_BUFFER_SIZE 100000
-
-/*
-Typedefs
-*/
-
-typedef void (*stest_void_void)(void);
-typedef void (*stest_void_string)(const char *);
-
-/*
-Declarations
-*/
-
-extern void (*stest_simple_test_result)(int passed, const char *reason,
-                                        const char *function,
-                                        unsigned int line);
-void stest_test_fixture_start(const char *filepath);
-void stest_test_fixture_end(void);
-void stest_simple_test_result_log(int passed, const char *reason,
-                                  const char *function, unsigned int line);
-void stest_assert_true(int test, const char *function, unsigned int line);
-void stest_assert_false(int test, const char *function, unsigned int line);
-void stest_assert_int_equal(int expected, int actual, const char *function,
-                            unsigned int line);
-void stest_assert_ulong_equal(unsigned long expected, unsigned long actual,
-                              const char *function, unsigned int line);
-void stest_assert_float_equal(float expected, float actual, float delta,
-                              const char *function, unsigned int line);
-void stest_assert_double_equal(double expected, double actual, double delta,
-                               const char *function, unsigned int line);
-void stest_assert_string_equal(const char *expected, const char *actual,
-                               const char *function, unsigned int line);
-void stest_assert_string_ends_with(const char *expected, const char *actual,
-                                   const char *function, unsigned int line);
-void stest_assert_string_starts_with(const char *expected, const char *actual,
-                                     const char *function, unsigned int line);
-void stest_assert_string_contains(const char *expected, const char *actual,
-                                  const char *function, unsigned int line);
-void stest_assert_string_not_contains(const char *expected, const char *actual,
-                                      const char *function, unsigned int line);
-int stest_should_run_fixture(const char *fixture);
-int stest_should_run_test(const char *test);
-void stest_before_run(const char *fixture, const char *test);
-void stest_setup(void);
-void stest_teardown(void);
-void stest_suite_teardown(void);
-void stest_suite_setup(void);
-void stest_test(const char *test, void (*test_function)(void));
-
-/*
-Assert Macros
-*/
-
-// clang-format off
-#define assert_true(test) do { stest_assert_true(test, __FUNCTION__, __LINE__); } while (0)
-#define assert_false(test) do {  stest_assert_false(test, __FUNCTION__, __LINE__); } while (0)
-#define assert_int_equal(expected, actual) do {  stest_assert_int_equal(expected, actual, __FUNCTION__, __LINE__); } while (0)
-#define assert_ulong_equal(expected, actual) do {  stest_assert_ulong_equal(expected, actual, __FUNCTION__, __LINE__); } while (0)
-#define assert_string_equal(expected, actual) do {  stest_assert_string_equal(expected, actual, __FUNCTION__, __LINE__); } while (0)
-#define assert_n_array_equal(expected, actual, n) do { size_t stest_count; for(stest_count=0; stest_count<n; stest_count++) { char s_stest[STEST_PRINT_BUFFER_SIZE]; sprintf(s_stest,"Expected %d to be %d at position %d", actual[stest_count], expected[stest_count], (int)stest_count); stest_simple_test_result((expected[stest_count] == actual[stest_count]), s_stest, __FUNCTION__, __LINE__);} } while (0)
-#define assert_bit_set(bit_number, value) { stest_simple_test_result(((1 << bit_number) & value), " Expected bit to be set" ,  __FUNCTION__, __LINE__); } while (0)
-#define assert_bit_not_set(bit_number, value) { stest_simple_test_result(!((1 << bit_number) & value), " Expected bit not to to be set" ,  __FUNCTION__, __LINE__); } while (0)
-#define assert_bit_mask_matches(value, mask) { stest_simple_test_result(((value & mask) == mask), " Expected all bits of mask to be set" ,  __FUNCTION__, __LINE__); } while (0)
-#define assert_fail(message) { stest_simple_test_result(0, message,  __FUNCTION__, __LINE__); } while (0)
-#define assert_float_equal(expected, actual, delta) do {  stest_assert_float_equal(expected, actual, delta, __FUNCTION__, __LINE__); } while (0)
-#define assert_double_equal(expected, actual, delta) do {  stest_assert_double_equal(expected, actual, delta, __FUNCTION__, __LINE__); } while (0)
-#define assert_string_contains(expected, actual) do {  stest_assert_string_contains(expected, actual, __FUNCTION__, __LINE__); } while (0)
-#define assert_string_not_contains(expected, actual) do {  stest_assert_string_not_contains(expected, actual, __FUNCTION__, __LINE__); } while (0)
-#define assert_string_starts_with(expected, actual) do {  stest_assert_string_starts_with(expected, actual, __FUNCTION__, __LINE__); } while (0)
-#define assert_string_ends_with(expected, actual) do {  stest_assert_string_ends_with(expected, actual, __FUNCTION__, __LINE__); } while (0)
-
-/*
-Fixture / Test Management
-*/
-
-void fixture_setup(void (*setup)( void ));
-void fixture_teardown(void (*teardown)( void ));
-#define run_test(test) do { stest_test(#test, test);} while (0)
-#define test_fixture_start() do { stest_test_fixture_start(__FILE__); } while (0)
-#define test_fixture_end() do { stest_test_fixture_end();} while (0)
-void fixture_filter(const char* filter);
-void test_filter(const char* filter);
-void suite_teardown(stest_void_void teardown);
-void suite_setup(stest_void_void setup);
-int run_tests(stest_void_void tests);
-int stest_testrunner(int argc, char** argv, stest_void_void tests, stest_void_void setup, stest_void_void teardown);
-#endif
-//clang-format on
-
-#ifdef STEST_INTERNAL_TESTS
-void stest_simple_test_result_nolog(int passed, const char* reason, const char* function, unsigned int line);
-void stest_assert_last_passed(const char* function, unsigned int line);
-void stest_assert_last_failed(const char* function, unsigned int line);
-void stest_enable_logging(void);
-void stest_disable_logging(void);
-#endif
+/*
+ * Copyright (c) 2010 Keith Nicholas
+ * Copyright (c) 2021 Jia Tan
+ */
+
+#ifndef STEST_H
+#define STEST_H
+
+/*
+Defines
+*/
+
+#define STEST_PRINT_BUFFER_SIZE 10000
+
+// First prototype, then declare the test function
+#define STEST(test_name) static void test_name(void); \
+static void test_name(void) \
+{ const char *__STEST_FUNC_NAME__ = #test_name; (void) __STEST_FUNC_NAME__;
+
+#define STEST_HELPER(return_type, test_name, ...) static return_type \
+test_name(__VA_ARGS__); \
+static return_type test_name(__VA_ARGS__) \
+{ const char *__STEST_FUNC_NAME__ = #test_name; (void) __STEST_FUNC_NAME__;
+
+/*
+Typedefs
+*/
+
+typedef void (*stest_void_void)(void);
+typedef void (*stest_void_string)(const char *);
+
+/*
+Declarations
+*/
+
+extern void (*stest_simple_test_result)(int passed, const char *reason,
+                                        const char *function,
+                                        unsigned int line);
+void stest_test_fixture_start(const char *filepath);
+void stest_test_fixture_end(void);
+void stest_simple_test_result_log(int passed, const char *reason,
+                                  const char *function, unsigned int line);
+void stest_assert_true(int test, const char *function, unsigned int line);
+void stest_assert_false(int test, const char *function, unsigned int line);
+void stest_assert_int_equal(int expected, int actual, const char *function,
+                            unsigned int line);
+void stest_assert_ulong_equal(unsigned long expected, unsigned long actual,
+                              const char *function, unsigned int line);
+void stest_assert_float_equal(float expected, float actual, float delta,
+                              const char *function, unsigned int line);
+void stest_assert_double_equal(double expected, double actual, double delta,
+                               const char *function, unsigned int line);
+void stest_assert_string_equal(const char *expected, const char *actual,
+                               const char *function, unsigned int line);
+void stest_assert_string_ends_with(const char *expected, const char *actual,
+                                   const char *function, unsigned int line);
+void stest_assert_string_starts_with(const char *expected, const char *actual,
+                                     const char *function, unsigned int line);
+void stest_assert_string_contains(const char *expected, const char *actual,
+                                  const char *function, unsigned int line);
+void stest_assert_string_not_contains(const char *expected, const char *actual,
+                                      const char *function, unsigned int line);
+int stest_should_run_fixture(const char *fixture);
+int stest_should_run_test(const char *test);
+void stest_before_run(const char *fixture, const char *test);
+void stest_setup(void);
+void stest_teardown(void);
+void stest_suite_teardown(void);
+void stest_suite_setup(void);
+void stest_test(const char *test, void (*test_function)(void));
+
+/*
+Assert Macros
+*/
+
+// clang-format off
+#define assert_true(test) do { stest_assert_true(test, __STEST_FUNC_NAME__, __LINE__); } while (0)
+#define assert_false(test) do {  stest_assert_false(test, __STEST_FUNC_NAME__, __LINE__); } while (0)
+#define assert_int_equal(expected, actual) do {  stest_assert_int_equal(expected, actual, __STEST_FUNC_NAME__, __LINE__); } while (0)
+#define assert_ulong_equal(expected, actual) do {  stest_assert_ulong_equal(expected, actual, __STEST_FUNC_NAME__, __LINE__); } while (0)
+#define assert_string_equal(expected, actual) do {  stest_assert_string_equal(expected, actual, __STEST_FUNC_NAME__, __LINE__); } while (0)
+#define assert_n_array_equal(expected, actual, n) do { size_t stest_count; for(stest_count=0; stest_count<n; stest_count++) { char s_stest[STEST_PRINT_BUFFER_SIZE]; sprintf(s_stest,"Expected %d to be %d at position %d", actual[stest_count], expected[stest_count], (int)stest_count); stest_simple_test_result((expected[stest_count] == actual[stest_count]), s_stest, __STEST_FUNC_NAME__, __LINE__);} } while (0)
+#define assert_bit_set(bit_number, value) { stest_simple_test_result(((1 << bit_number) & value), " Expected bit to be set" ,  __STEST_FUNC_NAME__, __LINE__); } while (0)
+#define assert_bit_not_set(bit_number, value) { stest_simple_test_result(!((1 << bit_number) & value), " Expected bit not to to be set" ,  __STEST_FUNC_NAME__, __LINE__); } while (0)
+#define assert_bit_mask_matches(value, mask) { stest_simple_test_result(((value & mask) == mask), " Expected all bits of mask to be set" ,  __STEST_FUNC_NAME__, __LINE__); } while (0)
+#define assert_fail(message) { stest_simple_test_result(0, message,  __STEST_FUNC_NAME__, __LINE__); } while (0)
+#define assert_float_equal(expected, actual, delta) do {  stest_assert_float_equal(expected, actual, delta, __STEST_FUNC_NAME__, __LINE__); } while (0)
+#define assert_double_equal(expected, actual, delta) do {  stest_assert_double_equal(expected, actual, delta, __STEST_FUNC_NAME__, __LINE__); } while (0)
+#define assert_string_contains(expected, actual) do {  stest_assert_string_contains(expected, actual, __STEST_FUNC_NAME__, __LINE__); } while (0)
+#define assert_string_not_contains(expected, actual) do {  stest_assert_string_not_contains(expected, actual, __STEST_FUNC_NAME__, __LINE__); } while (0)
+#define assert_string_starts_with(expected, actual) do {  stest_assert_string_starts_with(expected, actual, __STEST_FUNC_NAME__, __LINE__); } while (0)
+#define assert_string_ends_with(expected, actual) do {  stest_assert_string_ends_with(expected, actual, __STEST_FUNC_NAME__, __LINE__); } while (0)
+
+/*
+Fixture / Test Management
+*/
+
+void fixture_setup(void (*setup)( void ));
+void fixture_teardown(void (*teardown)( void ));
+#define run_test(test) do { stest_test(#test, test);} while (0)
+#define test_fixture_start() do { stest_test_fixture_start(__FILE__); } while (0)
+#define test_fixture_end() do { stest_test_fixture_end();} while (0)
+void fixture_filter(const char* filter);
+void test_filter(const char* filter);
+void suite_teardown(stest_void_void teardown);
+void suite_setup(stest_void_void setup);
+int run_tests(stest_void_void tests);
+int stest_testrunner(int argc, char** argv, stest_void_void tests, stest_void_void setup, stest_void_void teardown);
+#endif
+//clang-format on
+
+#ifdef STEST_INTERNAL_TESTS
+void stest_simple_test_result_nolog(int passed, const char* reason, const char* function, unsigned int line);
+void stest_assert_last_passed(const char* function, unsigned int line);
+void stest_assert_last_failed(const char* function, unsigned int line);
+void stest_enable_logging(void);
+void stest_disable_logging(void);
+#endif
diff --git a/tests/stests.c b/tests/stests.c
index d5a8b52..dcf3ef5 100644
--- a/tests/stests.c
+++ b/tests/stests.c
@@ -4,8 +4,9 @@
  */
 
 #include "stests.h"
+#include "stddef.h"
 
-void test_assert_n_array_equal() {
+STEST(test_assert_n_array_equal)
   int array_1[4] = {0, 1, 2, 3};
   int array_2[4] = {0, 1, 2, 4};
   int array_3[4] = {0, 1, 2, 3};
@@ -17,7 +18,7 @@ void test_assert_n_array_equal() {
   assert_test_fails(assert_n_array_equal(array_1, array_2, 0));
 }
 
-void test_assert_string_equal() {
+STEST(test_assert_string_equal)
   assert_test_passes(assert_string_equal((char *)0, (char *)0));
   assert_test_passes(assert_string_equal("", ""));
   assert_test_passes(assert_string_equal("foo", "foo"));
@@ -28,33 +29,33 @@ void test_assert_string_equal() {
   assert_test_fails(assert_string_equal("foo", "foo\n"));
 }
 
-void test_assert_ulong_equal() {
+STEST(test_assert_ulong_equal)
   assert_test_passes(assert_ulong_equal(1, 1));
   assert_test_passes(assert_ulong_equal(-2, -2));
   assert_test_fails(assert_ulong_equal(1, 0));
   assert_test_fails(assert_ulong_equal(-2, 2));
 }
 
-void test_assert_int_equal() {
+STEST(test_assert_int_equal)
   assert_test_passes(assert_int_equal(1, 1));
   assert_test_passes(assert_int_equal(-2, -2));
   assert_test_fails(assert_int_equal(1, 0));
   assert_test_fails(assert_int_equal(-2, 2));
 }
 
-void test_assert_true() {
+STEST(test_assert_true)
   assert_test_passes(assert_true(1));
   assert_test_fails(assert_true(0));
 }
 
-void test_assert_false() {
+STEST(test_assert_false)
   assert_test_passes(assert_false(0));
   assert_test_fails(assert_false(1));
 }
 
-void test_assert_fail() { assert_test_fails(assert_fail("")); }
+STEST(test_assert_fail) assert_test_fails(assert_fail("")); }
 
-void test_assert_bit_set() {
+STEST(test_assert_bit_set)
   for(int bit = 0, value = 1; bit < sizeof(int) * 8; bit++, value <<= 1) {
     assert_test_passes(assert_bit_set(bit, value));
     if(bit > 0) {
@@ -63,7 +64,7 @@ void test_assert_bit_set() {
   }
 }
 
-void test_assert_bit_not_set() {
+STEST(test_assert_bit_not_set)
   for(int bit = 0, value = 1; bit < sizeof(int) * 8; bit++, value <<= 1) {
     assert_test_fails(assert_bit_not_set(bit, value));
     if(bit > 0) {
@@ -72,7 +73,7 @@ void test_assert_bit_not_set() {
   }
 }
 
-void test_assert_bit_mask_matches() {
+STEST(test_assert_bit_mask_matches)
   // mask in binary => 000100100011010001010110
   int mask = 0x123456;
   for(int i = 0; i < sizeof(int) * 8 - 1; i++) {
@@ -81,7 +82,7 @@ void test_assert_bit_mask_matches() {
   }
 }
 
-void test_assert_double_equal() {
+STEST(test_assert_double_equal)
   const double delta = 0.001;
   assert_test_passes(assert_double_equal(1.0, 1.0, delta));
   assert_test_fails(assert_double_equal(1.0, 2.0, delta));
@@ -92,34 +93,43 @@ void test_assert_double_equal() {
   assert_test_fails(assert_double_equal(d1, d2, delta));
 }
 
-void test_assert_string_contains() {
+STEST(test_assert_string_contains)
   const char *str1 = "string one";
   const char *str2 = "string one and more";
   assert_test_passes(assert_string_contains(str1, str2));
   assert_test_fails(assert_string_contains(str2, str1));
 }
 
-void test_assert_string_not_contains() {
+STEST(test_assert_string_not_contains)
   const char *str1 = "string one";
   const char *str2 = "string one and more";
   assert_test_fails(assert_string_not_contains(str1, str2));
   assert_test_passes(assert_string_not_contains(str2, str1));
 }
 
-void test_assert_string_starts_with() {
+STEST(test_assert_string_starts_with)
   const char *str1 = "string one";
   const char *str2 = "string one and more";
   assert_test_passes(assert_string_starts_with(str1, str2));
   assert_test_fails(assert_string_starts_with(str2, str1));
 }
 
-void test_assert_string_ends_with() {
+STEST(test_assert_string_ends_with)
   const char *str1 = "and more";
   const char *str2 = "string one and more";
   assert_test_passes(assert_string_ends_with(str1, str2));
   assert_test_fails(assert_string_ends_with(str2, str1));
 }
 
+STEST_HELPER(int, helper_function, int arg1, int arg2)
+  assert_true(arg2 > arg1);
+  return arg2 - arg1;
+}
+
+STEST(test_using_helper_function)
+  assert_int_equal(1, helper_function(1, 2));
+}
+
 void test_fixture_stest() {
   test_fixture_start();
   run_test(test_assert_true);
@@ -137,11 +147,10 @@ void test_fixture_stest() {
   run_test(test_assert_string_not_contains);
   run_test(test_assert_string_starts_with);
   run_test(test_assert_string_ends_with);
+  run_test(test_using_helper_function);
   test_fixture_end();
 }
 
-void all_tests() { test_fixture_stest(); }
-
 int main(int argc, char **argv) {
-  return stest_testrunner(argc, argv, all_tests, NULL, NULL);
+  return stest_testrunner(argc, argv, test_fixture_stest, NULL, NULL);
 }
diff --git a/tests/stests.h b/tests/stests.h
index 4ae1b43..f635420 100644
--- a/tests/stests.h
+++ b/tests/stests.h
@@ -14,13 +14,3 @@
 #define assert_test_passes(X) without_logging(X); stest_assert_last_passed(__FUNCTION__, __LINE__);
 #define assert_test_fails(X) without_logging(X); stest_assert_last_failed(__FUNCTION__, __LINE__);
 // clang-format on
-
-void test_assert_true(void);
-void test_assert_false(void);
-void test_assert_int_equal(void);
-void test_assert_ulong_equal(void);
-void test_assert_string_equal(void);
-void test_assert_n_array_equal(void);
-
-void test_fixture_stest(void);
-void all_tests(void);