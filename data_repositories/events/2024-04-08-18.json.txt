{"id":"37275692821","type":"IssueCommentEvent","actor":{"id":46978960,"login":"marc-hb","display_login":"marc-hb","gravatar_id":"","url":"https://api.github.com/users/marc-hb","avatar_url":"https://avatars.githubusercontent.com/u/46978960?"},"repo":{"id":59771425,"name":"zephyrproject-rtos/zephyr","url":"https://api.github.com/repos/zephyrproject-rtos/zephyr"},"payload":{"action":"created","issue":{"url":"https://api.github.com/repos/zephyrproject-rtos/zephyr/issues/70215","repository_url":"https://api.github.com/repos/zephyrproject-rtos/zephyr","labels_url":"https://api.github.com/repos/zephyrproject-rtos/zephyr/issues/70215/labels{/name}","comments_url":"https://api.github.com/repos/zephyrproject-rtos/zephyr/issues/70215/comments","events_url":"https://api.github.com/repos/zephyrproject-rtos/zephyr/issues/70215/events","html_url":"https://github.com/zephyrproject-rtos/zephyr/issues/70215","id":2185958398,"node_id":"I_kwDOA5AKIc6CSxP-","number":70215,"title":"TFM build modifies platform files in TFM module","user":{"login":"rettichschnidi","id":920644,"node_id":"MDQ6VXNlcjkyMDY0NA==","avatar_url":"https://avatars.githubusercontent.com/u/920644?v=4","gravatar_id":"","url":"https://api.github.com/users/rettichschnidi","html_url":"https://github.com/rettichschnidi","followers_url":"https://api.github.com/users/rettichschnidi/followers","following_url":"https://api.github.com/users/rettichschnidi/following{/other_user}","gists_url":"https://api.github.com/users/rettichschnidi/gists{/gist_id}","starred_url":"https://api.github.com/users/rettichschnidi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rettichschnidi/subscriptions","organizations_url":"https://api.github.com/users/rettichschnidi/orgs","repos_url":"https://api.github.com/users/rettichschnidi/repos","events_url":"https://api.github.com/users/rettichschnidi/events{/privacy}","received_events_url":"https://api.github.com/users/rettichschnidi/received_events","type":"User","site_admin":false},"labels":[{"id":383053976,"node_id":"MDU6TGFiZWwzODMwNTM5NzY=","url":"https://api.github.com/repos/zephyrproject-rtos/zephyr/labels/bug","name":"bug","color":"e99695","default":true,"description":"The issue is a bug, or the PR is fixing a bug"},{"id":700751207,"node_id":"MDU6TGFiZWw3MDA3NTEyMDc=","url":"https://api.github.com/repos/zephyrproject-rtos/zephyr/labels/priority:%20high","name":"priority: high","color":"ff0000","default":false,"description":"High impact/importance bug"},{"id":700752411,"node_id":"MDU6TGFiZWw3MDA3NTI0MTE=","url":"https://api.github.com/repos/zephyrproject-rtos/zephyr/labels/area:%20Build%20System","name":"area: Build System","color":"ededed","default":false,"description":null},{"id":1372215310,"node_id":"MDU6TGFiZWwxMzcyMjE1MzEw","url":"https://api.github.com/repos/zephyrproject-rtos/zephyr/labels/area:%20Modules","name":"area: Modules","color":"ededed","default":false,"description":""},{"id":2642286351,"node_id":"MDU6TGFiZWwyNjQyMjg2MzUx","url":"https://api.github.com/repos/zephyrproject-rtos/zephyr/labels/area:%20TF-M","name":"area: TF-M","color":"ededed","default":false,"description":"ARM Trusted Firmware-M (TF-M)"}],"state":"open","locked":false,"assignee":{"login":"d3zd3z","id":90349,"node_id":"MDQ6VXNlcjkwMzQ5","avatar_url":"https://avatars.githubusercontent.com/u/90349?v=4","gravatar_id":"","url":"https://api.github.com/users/d3zd3z","html_url":"https://github.com/d3zd3z","followers_url":"https://api.github.com/users/d3zd3z/followers","following_url":"https://api.github.com/users/d3zd3z/following{/other_user}","gists_url":"https://api.github.com/users/d3zd3z/gists{/gist_id}","starred_url":"https://api.github.com/users/d3zd3z/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/d3zd3z/subscriptions","organizations_url":"https://api.github.com/users/d3zd3z/orgs","repos_url":"https://api.github.com/users/d3zd3z/repos","events_url":"https://api.github.com/users/d3zd3z/events{/privacy}","received_events_url":"https://api.github.com/users/d3zd3z/received_events","type":"User","site_admin":false},"assignees":[{"login":"d3zd3z","id":90349,"node_id":"MDQ6VXNlcjkwMzQ5","avatar_url":"https://avatars.githubusercontent.com/u/90349?v=4","gravatar_id":"","url":"https://api.github.com/users/d3zd3z","html_url":"https://github.com/d3zd3z","followers_url":"https://api.github.com/users/d3zd3z/followers","following_url":"https://api.github.com/users/d3zd3z/following{/other_user}","gists_url":"https://api.github.com/users/d3zd3z/gists{/gist_id}","starred_url":"https://api.github.com/users/d3zd3z/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/d3zd3z/subscriptions","organizations_url":"https://api.github.com/users/d3zd3z/orgs","repos_url":"https://api.github.com/users/d3zd3z/repos","events_url":"https://api.github.com/users/d3zd3z/events{/privacy}","received_events_url":"https://api.github.com/users/d3zd3z/received_events","type":"User","site_admin":false}],"milestone":null,"comments":17,"created_at":"2024-03-14T10:10:46Z","updated_at":"2024-04-08T18:38:46Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Problem**\r\n\r\nRunning Twister on tests in tests/kernel/common, targeting platform lpcxpresso55s69/lpc55s69/cpu0/ns, results in build errors.\r\n\r\n**To Reproduce**\r\n\r\nSteps to reproduce the behavior:\r\n\r\n1. `cd zephyr`\r\n2. `twister -p lpcxpresso55s69/lpc55s69/cpu0/ns --inline-logs -s tests/kernel/common/kernel.common -s tests/kernel/common/kernel.common.misra` (rarely works)\r\n\r\nThis however works always:\r\n - Run just one build: `twister -p lpcxpresso55s69/lpc55s69/cpu0/ns --inline-logs -s tests/kernel/common/kernel.common`\r\n - Run twister a 2nd time with `--no-clean`.\r\n\r\n**Expected behavior**\r\n\r\n1. Build works reliable, independent of other targets getting built at the same time.\r\n2. <del>HALs must not modify their code during build.</del> [I got this wrong](https://github.com/zephyrproject-rtos/zephyr/issues/70215#issuecomment-1998549826), it is the trusted-firmware-m\r\n3. Targets which violate 2), must not be part of CI\r\n\r\n**Impact**\r\n\r\nIt prevents my PRs from passing CI.\r\n\r\n**Logs and console output**\r\n\r\n[Failing build](https://github.com/zephyrproject-rtos/zephyr/actions/runs/8276908980/job/22646396015?pr=70176#step:11:1689)\r\n\r\n**Environment (please complete the following information):**\r\n - OS: Linux\r\n - Toolchain is Zephyr SDK\r\n - Commit: main as of today (v3.6.0-923-g85b503e23b1)\r\n\r\n**Hints**\r\n- Building for this platform seems to modify the files stored in the HAL module. The timestamps of all files stored in `modules/tee/tf-m/trusted-firmware-m/platform/ext/target/nxp/common/Native_Driver/drivers/` get modified after each run.\r\n- Running cmake in the `tfm` subfolder within the build directory has the same effect - it touches the files in the HAL:\r\n ```\r\n$ cmake .\r\nCMake Warning at cmake/version.cmake:22 (message):\r\n  Actual TF-M version is not available from Git repository.  Settled to\r\n  v2.0.0\r\nCall Stack (most recent call first):\r\n  CMakeLists.txt:22 (include)\r\n\r\n\r\n-- [Crypto service] Using P256M software driver in PSA Crypto backend\r\n-- Pulling MCUxpresso NXP SDK drivers from https://github.com/NXPmicro/mcux-sdk\r\n-- Configuring done\r\n-- Generating done\r\n-- Build files have been written to: /home/reto/code/3rd-party/zephyrproject/zephyr/twister-out/lpcxpresso55s69_lpc55s69_cpu0_ns/tests/kernel/common/kernel.common/tfm\r\n ```","reactions":{"url":"https://api.github.com/repos/zephyrproject-rtos/zephyr/issues/70215/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/zephyrproject-rtos/zephyr/issues/70215/timeline","performed_via_github_app":null,"state_reason":"reopened"},"comment":{"url":"https://api.github.com/repos/zephyrproject-rtos/zephyr/issues/comments/2043425011","html_url":"https://github.com/zephyrproject-rtos/zephyr/issues/70215#issuecomment-2043425011","issue_url":"https://api.github.com/repos/zephyrproject-rtos/zephyr/issues/70215","id":2043425011,"node_id":"IC_kwDOA5AKIc55zDDz","user":{"login":"marc-hb","id":46978960,"node_id":"MDQ6VXNlcjQ2OTc4OTYw","avatar_url":"https://avatars.githubusercontent.com/u/46978960?v=4","gravatar_id":"","url":"https://api.github.com/users/marc-hb","html_url":"https://github.com/marc-hb","followers_url":"https://api.github.com/users/marc-hb/followers","following_url":"https://api.github.com/users/marc-hb/following{/other_user}","gists_url":"https://api.github.com/users/marc-hb/gists{/gist_id}","starred_url":"https://api.github.com/users/marc-hb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marc-hb/subscriptions","organizations_url":"https://api.github.com/users/marc-hb/orgs","repos_url":"https://api.github.com/users/marc-hb/repos","events_url":"https://api.github.com/users/marc-hb/events{/privacy}","received_events_url":"https://api.github.com/users/marc-hb/received_events","type":"User","site_admin":false},"created_at":"2024-04-08T18:38:44Z","updated_at":"2024-04-08T18:38:44Z","author_association":"COLLABORATOR","body":"> Just checked again. I cannot see any modified repository files after building TFM examples.\r\n\r\nYes, but only thanks to super fragile, one-line `if(CONFIG_...)` line. This is not good enough. If you think it is, just search the internet for \"JiaT75\".\r\n\r\nAlso, I raised a number of other, different but related \"build robustness issues\" in my comment https://github.com/zephyrproject-rtos/zephyr/issues/70215#issuecomment-1998121524\r\n\r\nHere's a very quick reproduction of the issue; much simpler than what was shared previously:\r\n\r\n```\r\ncd zephyr; git checkout d9fd292f4b9a # today's main branch\r\nwest update\r\nwest diff\r\n```\r\n\r\n```diff\r\n--- zephyr/modules/trusted-firmware-m/CMakeLists.txt\r\n+++ zephyr/modules/trusted-firmware-m/CMakeLists.txt\r\n@@ -226,7 +226,7 @@ if (CONFIG_BUILD_WITH_TFM)\r\n \r\n   string(REPLACE \"toolchain\" \"toolchain_ns\" TFM_TOOLCHAIN_NS_FILE ${TFM_TOOLCHAIN_FILE})\r\n \r\n-  if(CONFIG_BOARD_LPCXPRESSO55S69_LPC55S69_CPU0_NS)\r\n+  if(xxxCONFIG_BOARD_LPCXPRESSO55S69_LPC55S69_CPU0_NS)\r\n     # Supply path to NXP HAL sources used for TF-M build\r\n     set(TFM_PLATFORM_NXP_HAL_FILE_PATH ${ZEPHYR_TRUSTED_FIRMWARE_M_MODULE_DIR}/platform/ext/target/nxp/)\r\n     list(APPEND TFM_CMAKE_ARGS -DTFM_PLATFORM_NXP_HAL_FILE_PATH=${TFM_PLATFORM_NXP_HAL_FILE_PATH})\r\n\r\n=== diff for trusted-firmware-m (modules/tee/tf-m/trusted-firmware-m):\r\ndiff --git modules/tee/tf-m/trusted-firmware-m/platform/ext/target/nxp/lpcxpresso55s69/pull_drivers.cmake modules/tee/tf-m/trusted-firmware-m/platform/ext/target/nxp/lpcxpresso55s69/pull_drivers.cmake\r\nindex fbb84a699e7d..6160f5df982b 100644\r\n--- modules/tee/tf-m/trusted-firmware-m/platform/ext/target/nxp/lpcxpresso55s69/pull_drivers.cmake\r\n+++ modules/tee/tf-m/trusted-firmware-m/platform/ext/target/nxp/lpcxpresso55s69/pull_drivers.cmake\r\n@@ -6,6 +6,10 @@\r\n #\r\n #-------------------------------------------------------------------------------\r\n \r\n+# \"Trusted\" firmware? Except for supply chain attacks.\r\n+# Even \"better\": CMake silently ignores failed DOWNLOAD\r\n+message(FATAL_ERROR \"Very sneaky and unreliable, build-time overwrite of sources should never happen for the default build target\")\r\n+\r\n #========================= Pull MCUxpresso NXP SDK drivers from https://github.com/NXPmicro/mcux-sdk =========================#\r\n file(DOWNLOAD https://raw.githubusercontent.com/NXPmicro/mcux-sdk/${NXP_SDK_GIT_TAG}/drivers/casper/fsl_casper.c  ${NXP_HAL_FILE_PATH}/common/Native_Driver/drivers/fsl_casper.c)\r\n file(DOWNLOAD https://raw.githubusercontent.com/NXPmicro/mcux-sdk/${NXP_SDK_GIT_TAG}/drivers/casper/fsl_casper.h  ${NXP_HAL_FILE_PATH}/common/Native_Driver/drivers/fsl_casper.h)\r\n```\r\n\r\n```\r\nwest build --board lpcxpresso55s69/lpc55s69/cpu0/ns samples/hello_world/\r\n\r\nCMake Warning at cmake/version.cmake:22 (message):\r\n  Actual TF-M version is not available from Git repository.  Settled to\r\n  v2.0.0\r\nCall Stack (most recent call first):\r\n  CMakeLists.txt:22 (include)\r\n\r\n\r\n-- [Crypto service] Using P256M software driver in PSA Crypto backend\r\n-- Pulling MCUxpresso NXP SDK drivers from https://github.com/NXPmicro/mcux-sdk\r\nCMake Error at platform/ext/target/nxp/lpcxpresso55s69/pull_drivers.cmake:11 (message):\r\n  Very sneaky and unreliable, build-time overwrite of sources should never\r\n  happen for the default build target\r\nCall Stack (most recent call first):\r\n  platform/ext/target/nxp/lpcxpresso55s69/CMakeLists.txt:18 (include)\r\n\r\n```","reactions":{"url":"https://api.github.com/repos/zephyrproject-rtos/zephyr/issues/comments/2043425011/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null}},"public":true,"created_at":"2024-04-08T18:38:46Z","org":{"id":19595895,"login":"zephyrproject-rtos","gravatar_id":"","url":"https://api.github.com/orgs/zephyrproject-rtos","avatar_url":"https://avatars.githubusercontent.com/u/19595895?"}}
