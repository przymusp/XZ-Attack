{"id":"30715970377","type":"IssueCommentEvent","actor":{"id":78042786,"login":"JiaT75","display_login":"JiaT75","gravatar_id":"","url":"https://api.github.com/users/JiaT75","avatar_url":"https://avatars.githubusercontent.com/u/78042786?"},"repo":{"id":553665726,"name":"tukaani-project/xz","url":"https://api.github.com/repos/tukaani-project/xz"},"payload":{"action":"created","issue":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/57","repository_url":"https://api.github.com/repos/tukaani-project/xz","labels_url":"https://api.github.com/repos/tukaani-project/xz/issues/57/labels{/name}","comments_url":"https://api.github.com/repos/tukaani-project/xz/issues/57/comments","events_url":"https://api.github.com/repos/tukaani-project/xz/issues/57/events","html_url":"https://github.com/tukaani-project/xz/pull/57","id":1824261922,"node_id":"PR_kwDOIQBEvs5Wiko1","number":57,"title":"Support build target `wasm32-unknown-unknown` in clang when `ENABLE_THREADS=OFF`","user":{"login":"ChanTsune","id":41658782,"node_id":"MDQ6VXNlcjQxNjU4Nzgy","avatar_url":"https://avatars.githubusercontent.com/u/41658782?v=4","gravatar_id":"","url":"https://api.github.com/users/ChanTsune","html_url":"https://github.com/ChanTsune","followers_url":"https://api.github.com/users/ChanTsune/followers","following_url":"https://api.github.com/users/ChanTsune/following{/other_user}","gists_url":"https://api.github.com/users/ChanTsune/gists{/gist_id}","starred_url":"https://api.github.com/users/ChanTsune/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChanTsune/subscriptions","organizations_url":"https://api.github.com/users/ChanTsune/orgs","repos_url":"https://api.github.com/users/ChanTsune/repos","events_url":"https://api.github.com/users/ChanTsune/events{/privacy}","received_events_url":"https://api.github.com/users/ChanTsune/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2023-07-27T12:23:12Z","updated_at":"2023-07-27T13:03:32Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"draft":false,"pull_request":{"url":"https://api.github.com/repos/tukaani-project/xz/pulls/57","html_url":"https://github.com/tukaani-project/xz/pull/57","diff_url":"https://github.com/tukaani-project/xz/pull/57.diff","patch_url":"https://github.com/tukaani-project/xz/pull/57.patch","merged_at":null},"body":"Thanks for the review #56 yesterday!\r\n\r\nI tried another approach, could you please review this one?\r\n\r\n## Pull request checklist\r\n\r\nPlease check if your PR fulfills the following requirements:\r\n- [x] Tests for the changes have been added (for bug fixes / features)\r\n- [x] Docs have been reviewed and added / updated if needed (for bug fixes / features)\r\n- [x] Build was run locally and without warnings or errors\r\n- [x] All previous and new tests pass\r\n\r\n\r\n## Pull request type\r\n\r\n<!-- Please try to limit your pull request to one type, submit multiple\r\npull requests if needed. --> \r\n\r\nPlease check the type of change your PR introduces:\r\n- [ ] Bugfix\r\n- [ ] Feature\r\n- [ ] Code style update (formatting, renaming, typo fix)\r\n- [x] Refactoring (no functional changes, no api changes)\r\n- [x] Build related changes\r\n- [ ] Documentation content changes\r\n- [ ] Other (please describe): \r\n\r\n\r\n## What is the current behavior?\r\n<!-- Please describe the current behavior that you are modifying. -->\r\n```\r\n$ mkdir build && cd build\r\n$ cmake .. -DENABLE_THREADS=OFF\r\n$ make liblzma\r\n[  0%] Building C object CMakeFiles/liblzma.dir/src/common/tuklib_physmem.c.obj                                       \r\n[  1%] Building C object CMakeFiles/liblzma.dir/src/liblzma/check/check.c.obj                                         \r\nIn file included from /xz/src/liblzma/check/check.c:13:                                                               \r\nIn file included from /xz/src/liblzma/check/check.h:16:                                                               \r\nIn file included from /xz/src/liblzma/common/common.h:17:\r\nIn file included from /xz/src/common/mythread.h:84:\r\n/wasi-sysroot/include/signal.h:2:2: error: \"wasm lacks signal support; to enable minimal signal emulation, compile with -D_WASI_EMULATED_SIGNAL and link with -lwasi-emulated-signal\"\r\n#error \"wasm lacks signal support; to enable minimal signal emulation, \\\r\n ^\r\nIn file included from /xz/src/liblzma/check/check.c:13:\r\nIn file included from /xz/src/liblzma/check/check.h:16:\r\nIn file included from /xz/src/liblzma/common/common.h:17:\r\n/xz/src/common/mythread.h:87:33: error: unknown type name 'sigset_t'\r\nmythread_sigmask(int how, const sigset_t *restrict set,\r\n                                ^\r\n/xz/src/common/mythread.h:88:3: error: unknown type name 'sigset_t'\r\n                sigset_t *restrict oset)\r\n                ^\r\n/xz/src/common/mythread.h:90:12: error: call to undeclared function 'sigprocmask'; ISO C99 and later do not support implicit function declarations [-Wimplicit-function-declaration]\r\n        int ret = sigprocmask(how, set, oset);\r\n                  ^\r\n4 errors generated.\r\nmake[3]: *** [CMakeFiles/liblzma.dir/build.make:90: CMakeFiles/liblzma.dir/src/liblzma/check/check.c.obj] Error 1\r\nmake[2]: *** [CMakeFiles/Makefile2:139: CMakeFiles/liblzma.dir/all] Error 2\r\nmake[1]: *** [CMakeFiles/Makefile2:146: CMakeFiles/liblzma.dir/rule] Error 2\r\nmake: *** [Makefile:179: liblzma] Error 2\r\n```\r\n\r\n<!-- Related issue this PR addresses, if applicable -->\r\nRelated Issue URL: \r\n#56 \r\n\r\n## What is the new behavior?\r\n<!-- Please describe the behavior or changes that are being added by this\r\nPR. -->\r\n\r\n- Changed to exclude signal functions not supported by WebAssembly, using the predefined `__wasm__` macro when the build target is set to wasm32 with clang.\r\nThis change allows `liblzma` to be built with the platform-independent `wasm32-uknown-unknown` target.\r\nI believe this exclusion will work in the same way as the build when targeting Windows, so it will minimize unexpected changes.\r\n\r\n## Does this introduce a breaking change?\r\n\r\n- [ ] Yes\r\n- [x] No\r\n\r\n<!-- If this introduces a breaking change, please describe the impact and\r\nmigration path for existing applications below. -->\r\n\r\n\r\n## Other information\r\n\r\nBuild tested on docker\r\n\r\n`Dockerfile`\r\n```docker\r\nFROM ghcr.io/webassembly/wasi-sdk:latest\r\n\r\nRUN apt update && apt install -y git\r\n\r\nRUN git clone https://github.com/ChanTsune/xz.git\r\n\r\nRUN mkdir -p ./xz/build\r\n\r\nRUN cd xz && git fetch && git switch feature/liblzma/wasm\r\n\r\nWORKDIR /xz/build\r\n\r\nRUN cmake .. -DENABLE_THREADS=OFF\r\n\r\nRUN CFLAGS=\"-target wasm32-unknown-unknown\" make liblzma\r\n```\r\n\r\n```sh\r\n$ docker build -t xz .\r\n```\r\n\r\nIf you need, you can see the predefined macros when targeting wasm32 in clang by following commands\r\n```\r\n$ clang -E -dM -target wasm32-unknown-unknown -x c /dev/null\r\n```\r\nor if you want to check with the latest wasi-sdk clang\r\n```sh\r\n$ docker image pull ghcr.io/webassembly/wasi-sdk\r\n$ docker run --rm -i ghcr.io/webassembly/wasi-sdk clang-16 -E -dM -target wasm32-unknown-unknown -x c /dev/null\r\n```\r\n","reactions":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/57/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/tukaani-project/xz/issues/57/timeline","performed_via_github_app":null,"state_reason":null},"comment":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/comments/1653583605","html_url":"https://github.com/tukaani-project/xz/pull/57#issuecomment-1653583605","issue_url":"https://api.github.com/repos/tukaani-project/xz/issues/57","id":1653583605,"node_id":"IC_kwDOIQBEvs5ij671","user":{"login":"JiaT75","id":78042786,"node_id":"MDQ6VXNlcjc4MDQyNzg2","avatar_url":"https://avatars.githubusercontent.com/u/78042786?v=4","gravatar_id":"","url":"https://api.github.com/users/JiaT75","html_url":"https://github.com/JiaT75","followers_url":"https://api.github.com/users/JiaT75/followers","following_url":"https://api.github.com/users/JiaT75/following{/other_user}","gists_url":"https://api.github.com/users/JiaT75/gists{/gist_id}","starred_url":"https://api.github.com/users/JiaT75/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JiaT75/subscriptions","organizations_url":"https://api.github.com/users/JiaT75/orgs","repos_url":"https://api.github.com/users/JiaT75/repos","events_url":"https://api.github.com/users/JiaT75/events{/privacy}","received_events_url":"https://api.github.com/users/JiaT75/received_events","type":"User","site_admin":false},"created_at":"2023-07-27T13:03:32Z","updated_at":"2023-07-27T13:03:32Z","author_association":"MEMBER","body":"Hi! Thanks again for the very detailed PR. I looked more into wasm signal support since at first I thought it was some sort of bug that the signal emulation did not define `sigset_t` or `sigprocmask()`. This seems intentional however so your PR is certainly needed for a successful port to web assembly.\r\n\r\nWhat you have so far seems like it is enough for liblzma to build, but we also should support an xz port. This should be easy to add just by following the example of VMS in src/xz/signal.*. Since the only functions in xz that use `mythread_sigmask()` it should be enough to define signals_block() and signals_unblock() as no-ops in signal.h (and remove implementation from signal.c).\r\n\r\nLet me know if you have questions or if something else is preventing us from building xz with wasi-sdk","reactions":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/comments/1653583605/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null}},"public":true,"created_at":"2023-07-27T13:03:32Z","org":{"id":116083088,"login":"tukaani-project","gravatar_id":"","url":"https://api.github.com/orgs/tukaani-project","avatar_url":"https://avatars.githubusercontent.com/u/116083088?"}}
{"id":"30716395465","type":"IssueCommentEvent","actor":{"id":78042786,"login":"JiaT75","display_login":"JiaT75","gravatar_id":"","url":"https://api.github.com/users/JiaT75","avatar_url":"https://avatars.githubusercontent.com/u/78042786?"},"repo":{"id":553665726,"name":"tukaani-project/xz","url":"https://api.github.com/repos/tukaani-project/xz"},"payload":{"action":"created","issue":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/57","repository_url":"https://api.github.com/repos/tukaani-project/xz","labels_url":"https://api.github.com/repos/tukaani-project/xz/issues/57/labels{/name}","comments_url":"https://api.github.com/repos/tukaani-project/xz/issues/57/comments","events_url":"https://api.github.com/repos/tukaani-project/xz/issues/57/events","html_url":"https://github.com/tukaani-project/xz/pull/57","id":1824261922,"node_id":"PR_kwDOIQBEvs5Wiko1","number":57,"title":"Support build target `wasm32-unknown-unknown` in clang when `ENABLE_THREADS=OFF`","user":{"login":"ChanTsune","id":41658782,"node_id":"MDQ6VXNlcjQxNjU4Nzgy","avatar_url":"https://avatars.githubusercontent.com/u/41658782?v=4","gravatar_id":"","url":"https://api.github.com/users/ChanTsune","html_url":"https://github.com/ChanTsune","followers_url":"https://api.github.com/users/ChanTsune/followers","following_url":"https://api.github.com/users/ChanTsune/following{/other_user}","gists_url":"https://api.github.com/users/ChanTsune/gists{/gist_id}","starred_url":"https://api.github.com/users/ChanTsune/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChanTsune/subscriptions","organizations_url":"https://api.github.com/users/ChanTsune/orgs","repos_url":"https://api.github.com/users/ChanTsune/repos","events_url":"https://api.github.com/users/ChanTsune/events{/privacy}","received_events_url":"https://api.github.com/users/ChanTsune/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2023-07-27T12:23:12Z","updated_at":"2023-07-27T13:18:08Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"draft":false,"pull_request":{"url":"https://api.github.com/repos/tukaani-project/xz/pulls/57","html_url":"https://github.com/tukaani-project/xz/pull/57","diff_url":"https://github.com/tukaani-project/xz/pull/57.diff","patch_url":"https://github.com/tukaani-project/xz/pull/57.patch","merged_at":null},"body":"Thanks for the review #56 yesterday!\r\n\r\nI tried another approach, could you please review this one?\r\n\r\n## Pull request checklist\r\n\r\nPlease check if your PR fulfills the following requirements:\r\n- [x] Tests for the changes have been added (for bug fixes / features)\r\n- [x] Docs have been reviewed and added / updated if needed (for bug fixes / features)\r\n- [x] Build was run locally and without warnings or errors\r\n- [x] All previous and new tests pass\r\n\r\n\r\n## Pull request type\r\n\r\n<!-- Please try to limit your pull request to one type, submit multiple\r\npull requests if needed. --> \r\n\r\nPlease check the type of change your PR introduces:\r\n- [ ] Bugfix\r\n- [ ] Feature\r\n- [ ] Code style update (formatting, renaming, typo fix)\r\n- [x] Refactoring (no functional changes, no api changes)\r\n- [x] Build related changes\r\n- [ ] Documentation content changes\r\n- [ ] Other (please describe): \r\n\r\n\r\n## What is the current behavior?\r\n<!-- Please describe the current behavior that you are modifying. -->\r\n```\r\n$ mkdir build && cd build\r\n$ cmake .. -DENABLE_THREADS=OFF\r\n$ make liblzma\r\n[  0%] Building C object CMakeFiles/liblzma.dir/src/common/tuklib_physmem.c.obj                                       \r\n[  1%] Building C object CMakeFiles/liblzma.dir/src/liblzma/check/check.c.obj                                         \r\nIn file included from /xz/src/liblzma/check/check.c:13:                                                               \r\nIn file included from /xz/src/liblzma/check/check.h:16:                                                               \r\nIn file included from /xz/src/liblzma/common/common.h:17:\r\nIn file included from /xz/src/common/mythread.h:84:\r\n/wasi-sysroot/include/signal.h:2:2: error: \"wasm lacks signal support; to enable minimal signal emulation, compile with -D_WASI_EMULATED_SIGNAL and link with -lwasi-emulated-signal\"\r\n#error \"wasm lacks signal support; to enable minimal signal emulation, \\\r\n ^\r\nIn file included from /xz/src/liblzma/check/check.c:13:\r\nIn file included from /xz/src/liblzma/check/check.h:16:\r\nIn file included from /xz/src/liblzma/common/common.h:17:\r\n/xz/src/common/mythread.h:87:33: error: unknown type name 'sigset_t'\r\nmythread_sigmask(int how, const sigset_t *restrict set,\r\n                                ^\r\n/xz/src/common/mythread.h:88:3: error: unknown type name 'sigset_t'\r\n                sigset_t *restrict oset)\r\n                ^\r\n/xz/src/common/mythread.h:90:12: error: call to undeclared function 'sigprocmask'; ISO C99 and later do not support implicit function declarations [-Wimplicit-function-declaration]\r\n        int ret = sigprocmask(how, set, oset);\r\n                  ^\r\n4 errors generated.\r\nmake[3]: *** [CMakeFiles/liblzma.dir/build.make:90: CMakeFiles/liblzma.dir/src/liblzma/check/check.c.obj] Error 1\r\nmake[2]: *** [CMakeFiles/Makefile2:139: CMakeFiles/liblzma.dir/all] Error 2\r\nmake[1]: *** [CMakeFiles/Makefile2:146: CMakeFiles/liblzma.dir/rule] Error 2\r\nmake: *** [Makefile:179: liblzma] Error 2\r\n```\r\n\r\n<!-- Related issue this PR addresses, if applicable -->\r\nRelated Issue URL: \r\n#56 \r\n\r\n## What is the new behavior?\r\n<!-- Please describe the behavior or changes that are being added by this\r\nPR. -->\r\n\r\n- Changed to exclude signal functions not supported by WebAssembly, using the predefined `__wasm__` macro when the build target is set to wasm32 with clang.\r\nThis change allows `liblzma` to be built with the platform-independent `wasm32-uknown-unknown` target.\r\nI believe this exclusion will work in the same way as the build when targeting Windows, so it will minimize unexpected changes.\r\n\r\n## Does this introduce a breaking change?\r\n\r\n- [ ] Yes\r\n- [x] No\r\n\r\n<!-- If this introduces a breaking change, please describe the impact and\r\nmigration path for existing applications below. -->\r\n\r\n\r\n## Other information\r\n\r\nBuild tested on docker\r\n\r\n`Dockerfile`\r\n```docker\r\nFROM ghcr.io/webassembly/wasi-sdk:latest\r\n\r\nRUN apt update && apt install -y git\r\n\r\nRUN git clone https://github.com/ChanTsune/xz.git\r\n\r\nRUN mkdir -p ./xz/build\r\n\r\nRUN cd xz && git fetch && git switch feature/liblzma/wasm\r\n\r\nWORKDIR /xz/build\r\n\r\nRUN cmake .. -DENABLE_THREADS=OFF\r\n\r\nRUN CFLAGS=\"-target wasm32-unknown-unknown\" make liblzma\r\n```\r\n\r\n```sh\r\n$ docker build -t xz .\r\n```\r\n\r\nIf you need, you can see the predefined macros when targeting wasm32 in clang by following commands\r\n```\r\n$ clang -E -dM -target wasm32-unknown-unknown -x c /dev/null\r\n```\r\nor if you want to check with the latest wasi-sdk clang\r\n```sh\r\n$ docker image pull ghcr.io/webassembly/wasi-sdk\r\n$ docker run --rm -i ghcr.io/webassembly/wasi-sdk clang-16 -E -dM -target wasm32-unknown-unknown -x c /dev/null\r\n```\r\n","reactions":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/57/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/tukaani-project/xz/issues/57/timeline","performed_via_github_app":null,"state_reason":null},"comment":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/comments/1653613611","html_url":"https://github.com/tukaani-project/xz/pull/57#issuecomment-1653613611","issue_url":"https://api.github.com/repos/tukaani-project/xz/issues/57","id":1653613611,"node_id":"IC_kwDOIQBEvs5ikCQr","user":{"login":"JiaT75","id":78042786,"node_id":"MDQ6VXNlcjc4MDQyNzg2","avatar_url":"https://avatars.githubusercontent.com/u/78042786?v=4","gravatar_id":"","url":"https://api.github.com/users/JiaT75","html_url":"https://github.com/JiaT75","followers_url":"https://api.github.com/users/JiaT75/followers","following_url":"https://api.github.com/users/JiaT75/following{/other_user}","gists_url":"https://api.github.com/users/JiaT75/gists{/gist_id}","starred_url":"https://api.github.com/users/JiaT75/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JiaT75/subscriptions","organizations_url":"https://api.github.com/users/JiaT75/orgs","repos_url":"https://api.github.com/users/JiaT75/repos","events_url":"https://api.github.com/users/JiaT75/events{/privacy}","received_events_url":"https://api.github.com/users/JiaT75/received_events","type":"User","site_admin":false},"created_at":"2023-07-27T13:18:08Z","updated_at":"2023-07-27T13:18:08Z","author_association":"MEMBER","body":"On second thought, will be more complicated that I initially thought since `signals_init()` needs to be disabled too. I will merge what you have once I make a fix for the xz side. Thanks for you contributions!","reactions":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/comments/1653613611/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null}},"public":true,"created_at":"2023-07-27T13:18:08Z","org":{"id":116083088,"login":"tukaani-project","gravatar_id":"","url":"https://api.github.com/orgs/tukaani-project","avatar_url":"https://avatars.githubusercontent.com/u/116083088?"}}
{"id":"30717058968","type":"IssueCommentEvent","actor":{"id":41658782,"login":"ChanTsune","display_login":"ChanTsune","gravatar_id":"","url":"https://api.github.com/users/ChanTsune","avatar_url":"https://avatars.githubusercontent.com/u/41658782?"},"repo":{"id":553665726,"name":"tukaani-project/xz","url":"https://api.github.com/repos/tukaani-project/xz"},"payload":{"action":"created","issue":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/57","repository_url":"https://api.github.com/repos/tukaani-project/xz","labels_url":"https://api.github.com/repos/tukaani-project/xz/issues/57/labels{/name}","comments_url":"https://api.github.com/repos/tukaani-project/xz/issues/57/comments","events_url":"https://api.github.com/repos/tukaani-project/xz/issues/57/events","html_url":"https://github.com/tukaani-project/xz/pull/57","id":1824261922,"node_id":"PR_kwDOIQBEvs5Wiko1","number":57,"title":"Support build target `wasm32-unknown-unknown` in clang when `ENABLE_THREADS=OFF`","user":{"login":"ChanTsune","id":41658782,"node_id":"MDQ6VXNlcjQxNjU4Nzgy","avatar_url":"https://avatars.githubusercontent.com/u/41658782?v=4","gravatar_id":"","url":"https://api.github.com/users/ChanTsune","html_url":"https://github.com/ChanTsune","followers_url":"https://api.github.com/users/ChanTsune/followers","following_url":"https://api.github.com/users/ChanTsune/following{/other_user}","gists_url":"https://api.github.com/users/ChanTsune/gists{/gist_id}","starred_url":"https://api.github.com/users/ChanTsune/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChanTsune/subscriptions","organizations_url":"https://api.github.com/users/ChanTsune/orgs","repos_url":"https://api.github.com/users/ChanTsune/repos","events_url":"https://api.github.com/users/ChanTsune/events{/privacy}","received_events_url":"https://api.github.com/users/ChanTsune/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2023-07-27T12:23:12Z","updated_at":"2023-07-27T13:40:30Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"draft":false,"pull_request":{"url":"https://api.github.com/repos/tukaani-project/xz/pulls/57","html_url":"https://github.com/tukaani-project/xz/pull/57","diff_url":"https://github.com/tukaani-project/xz/pull/57.diff","patch_url":"https://github.com/tukaani-project/xz/pull/57.patch","merged_at":null},"body":"Thanks for the review #56 yesterday!\r\n\r\nI tried another approach, could you please review this one?\r\n\r\n## Pull request checklist\r\n\r\nPlease check if your PR fulfills the following requirements:\r\n- [x] Tests for the changes have been added (for bug fixes / features)\r\n- [x] Docs have been reviewed and added / updated if needed (for bug fixes / features)\r\n- [x] Build was run locally and without warnings or errors\r\n- [x] All previous and new tests pass\r\n\r\n\r\n## Pull request type\r\n\r\n<!-- Please try to limit your pull request to one type, submit multiple\r\npull requests if needed. --> \r\n\r\nPlease check the type of change your PR introduces:\r\n- [ ] Bugfix\r\n- [ ] Feature\r\n- [ ] Code style update (formatting, renaming, typo fix)\r\n- [x] Refactoring (no functional changes, no api changes)\r\n- [x] Build related changes\r\n- [ ] Documentation content changes\r\n- [ ] Other (please describe): \r\n\r\n\r\n## What is the current behavior?\r\n<!-- Please describe the current behavior that you are modifying. -->\r\n```\r\n$ mkdir build && cd build\r\n$ cmake .. -DENABLE_THREADS=OFF\r\n$ make liblzma\r\n[  0%] Building C object CMakeFiles/liblzma.dir/src/common/tuklib_physmem.c.obj                                       \r\n[  1%] Building C object CMakeFiles/liblzma.dir/src/liblzma/check/check.c.obj                                         \r\nIn file included from /xz/src/liblzma/check/check.c:13:                                                               \r\nIn file included from /xz/src/liblzma/check/check.h:16:                                                               \r\nIn file included from /xz/src/liblzma/common/common.h:17:\r\nIn file included from /xz/src/common/mythread.h:84:\r\n/wasi-sysroot/include/signal.h:2:2: error: \"wasm lacks signal support; to enable minimal signal emulation, compile with -D_WASI_EMULATED_SIGNAL and link with -lwasi-emulated-signal\"\r\n#error \"wasm lacks signal support; to enable minimal signal emulation, \\\r\n ^\r\nIn file included from /xz/src/liblzma/check/check.c:13:\r\nIn file included from /xz/src/liblzma/check/check.h:16:\r\nIn file included from /xz/src/liblzma/common/common.h:17:\r\n/xz/src/common/mythread.h:87:33: error: unknown type name 'sigset_t'\r\nmythread_sigmask(int how, const sigset_t *restrict set,\r\n                                ^\r\n/xz/src/common/mythread.h:88:3: error: unknown type name 'sigset_t'\r\n                sigset_t *restrict oset)\r\n                ^\r\n/xz/src/common/mythread.h:90:12: error: call to undeclared function 'sigprocmask'; ISO C99 and later do not support implicit function declarations [-Wimplicit-function-declaration]\r\n        int ret = sigprocmask(how, set, oset);\r\n                  ^\r\n4 errors generated.\r\nmake[3]: *** [CMakeFiles/liblzma.dir/build.make:90: CMakeFiles/liblzma.dir/src/liblzma/check/check.c.obj] Error 1\r\nmake[2]: *** [CMakeFiles/Makefile2:139: CMakeFiles/liblzma.dir/all] Error 2\r\nmake[1]: *** [CMakeFiles/Makefile2:146: CMakeFiles/liblzma.dir/rule] Error 2\r\nmake: *** [Makefile:179: liblzma] Error 2\r\n```\r\n\r\n<!-- Related issue this PR addresses, if applicable -->\r\nRelated Issue URL: \r\n#56 \r\n\r\n## What is the new behavior?\r\n<!-- Please describe the behavior or changes that are being added by this\r\nPR. -->\r\n\r\n- Changed to exclude signal functions not supported by WebAssembly, using the predefined `__wasm__` macro when the build target is set to wasm32 with clang.\r\nThis change allows `liblzma` to be built with the platform-independent `wasm32-uknown-unknown` target.\r\nI believe this exclusion will work in the same way as the build when targeting Windows, so it will minimize unexpected changes.\r\n\r\n## Does this introduce a breaking change?\r\n\r\n- [ ] Yes\r\n- [x] No\r\n\r\n<!-- If this introduces a breaking change, please describe the impact and\r\nmigration path for existing applications below. -->\r\n\r\n\r\n## Other information\r\n\r\nBuild tested on docker\r\n\r\n`Dockerfile`\r\n```docker\r\nFROM ghcr.io/webassembly/wasi-sdk:latest\r\n\r\nRUN apt update && apt install -y git\r\n\r\nRUN git clone https://github.com/ChanTsune/xz.git\r\n\r\nRUN mkdir -p ./xz/build\r\n\r\nRUN cd xz && git fetch && git switch feature/liblzma/wasm\r\n\r\nWORKDIR /xz/build\r\n\r\nRUN cmake .. -DENABLE_THREADS=OFF\r\n\r\nRUN CFLAGS=\"-target wasm32-unknown-unknown\" make liblzma\r\n```\r\n\r\n```sh\r\n$ docker build -t xz .\r\n```\r\n\r\nIf you need, you can see the predefined macros when targeting wasm32 in clang by following commands\r\n```\r\n$ clang -E -dM -target wasm32-unknown-unknown -x c /dev/null\r\n```\r\nor if you want to check with the latest wasi-sdk clang\r\n```sh\r\n$ docker image pull ghcr.io/webassembly/wasi-sdk\r\n$ docker run --rm -i ghcr.io/webassembly/wasi-sdk clang-16 -E -dM -target wasm32-unknown-unknown -x c /dev/null\r\n```\r\n","reactions":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/57/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/tukaani-project/xz/issues/57/timeline","performed_via_github_app":null,"state_reason":null},"comment":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/comments/1653651980","html_url":"https://github.com/tukaani-project/xz/pull/57#issuecomment-1653651980","issue_url":"https://api.github.com/repos/tukaani-project/xz/issues/57","id":1653651980,"node_id":"IC_kwDOIQBEvs5ikLoM","user":{"login":"ChanTsune","id":41658782,"node_id":"MDQ6VXNlcjQxNjU4Nzgy","avatar_url":"https://avatars.githubusercontent.com/u/41658782?v=4","gravatar_id":"","url":"https://api.github.com/users/ChanTsune","html_url":"https://github.com/ChanTsune","followers_url":"https://api.github.com/users/ChanTsune/followers","following_url":"https://api.github.com/users/ChanTsune/following{/other_user}","gists_url":"https://api.github.com/users/ChanTsune/gists{/gist_id}","starred_url":"https://api.github.com/users/ChanTsune/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChanTsune/subscriptions","organizations_url":"https://api.github.com/users/ChanTsune/orgs","repos_url":"https://api.github.com/users/ChanTsune/repos","events_url":"https://api.github.com/users/ChanTsune/events{/privacy}","received_events_url":"https://api.github.com/users/ChanTsune/received_events","type":"User","site_admin":false},"created_at":"2023-07-27T13:40:29Z","updated_at":"2023-07-27T13:40:29Z","author_association":"NONE","body":"Thank you for your kind review!\r\n\r\nI am honored to contribute to your project!","reactions":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/comments/1653651980/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null}},"public":true,"created_at":"2023-07-27T13:40:30Z","org":{"id":116083088,"login":"tukaani-project","gravatar_id":"","url":"https://api.github.com/orgs/tukaani-project","avatar_url":"https://avatars.githubusercontent.com/u/116083088?"}}
