{"id":"31490516227","type":"IssueCommentEvent","actor":{"id":69727,"login":"mstorsjo","display_login":"mstorsjo","gravatar_id":"","url":"https://api.github.com/users/mstorsjo","avatar_url":"https://avatars.githubusercontent.com/u/69727?"},"repo":{"id":112254496,"name":"mstorsjo/llvm-mingw","url":"https://api.github.com/repos/mstorsjo/llvm-mingw"},"payload":{"action":"created","issue":{"url":"https://api.github.com/repos/mstorsjo/llvm-mingw/issues/363","repository_url":"https://api.github.com/repos/mstorsjo/llvm-mingw","labels_url":"https://api.github.com/repos/mstorsjo/llvm-mingw/issues/363/labels{/name}","comments_url":"https://api.github.com/repos/mstorsjo/llvm-mingw/issues/363/comments","events_url":"https://api.github.com/repos/mstorsjo/llvm-mingw/issues/363/events","html_url":"https://github.com/mstorsjo/llvm-mingw/issues/363","id":1857901647,"node_id":"I_kwDOBrDeIM5uvVRP","number":363,"title":"Issue with windres/rc","user":{"login":"DeadSix27","id":1492505,"node_id":"MDQ6VXNlcjE0OTI1MDU=","avatar_url":"https://avatars.githubusercontent.com/u/1492505?v=4","gravatar_id":"","url":"https://api.github.com/users/DeadSix27","html_url":"https://github.com/DeadSix27","followers_url":"https://api.github.com/users/DeadSix27/followers","following_url":"https://api.github.com/users/DeadSix27/following{/other_user}","gists_url":"https://api.github.com/users/DeadSix27/gists{/gist_id}","starred_url":"https://api.github.com/users/DeadSix27/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DeadSix27/subscriptions","organizations_url":"https://api.github.com/users/DeadSix27/orgs","repos_url":"https://api.github.com/users/DeadSix27/repos","events_url":"https://api.github.com/users/DeadSix27/events{/privacy}","received_events_url":"https://api.github.com/users/DeadSix27/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2023-08-19T23:50:46Z","updated_at":"2023-08-30T20:12:33Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"I'm not quite sure what's happening here, but I was trying to compile lzma with the llvm-mingw toolchain and got into this issue: \r\nllvm-rc: Error parsing file: Invalid token found at position 635\r\nLooked into the resource file:\r\n```\r\n/*\r\n * Author: Lasse Collin\r\n *\r\n * This file has been put into the public domain.\r\n * You can do whatever you want with this file.\r\n */\r\n\r\n#define MY_TYPE VFT_APP\r\n#define MY_NAME \"xzdec\"\r\n#define MY_SUFFIX \".exe\"\r\n#define MY_DESC \"xzdec decompression tool for .xz files\"\r\n#include \"common_w32res.rc\"\r\n```\r\n(check the git for the other rc files here: https://github.com/tukaani-project/xz/tree/master/src/xzdec\r\n\r\nLooked for position 635, couldn't really figure out the issue here.. any advice?\r\n\r\nThe lzma cmake script runs windres via this command line:\r\n\r\n`x86_64-w64-mingw32-windres -O coff -DHAVE_CHECK_CRC32 -DHAVE_CHECK_CRC64 -DHAVE_CHECK_SHA256 -DHAVE_DECODERS -DHAVE_DECODER_ARM -DHAVE_DECODER_ARM64 -DHAVE_DECODER_ARMTHUMB -DHAVE_DECODER_DELTA -DHAVE_DECODER_IA64 -DHAVE_DECODER_LZMA1 -DHAVE_DECODER_LZMA2 -DHAVE_DECODER_POWERPC -DHAVE_DECODER_SPARC -DHAVE_DECODER_X86 -DHAVE_ENCODERS -DHAVE_ENCODER_ARM -DHAVE_ENCODER_ARM64 -DHAVE_ENCODER_ARMTHUMB -DHAVE_ENCODER_DELTA -DHAVE_ENCODER_IA64 -DHAVE_ENCODER_LZMA1 -DHAVE_ENCODER_LZMA2 -DHAVE_ENCODER_POWERPC -DHAVE_ENCODER_SPARC -DHAVE_ENCODER_X86 -DHAVE_INTTYPES_H -DHAVE_LZIP_DECODER -DHAVE_MF_BT2 -DHAVE_MF_BT3 -DHAVE_MF_BT4 -DHAVE_MF_HC3 -DHAVE_MF_HC4 -DHAVE_STDBOOL_H -DHAVE_STDINT_H -DHAVE__BOOL -DHAVE___BUILTIN_ASSUME_ALIGNED -DHAVE___BUILTIN_BSWAPXX -DLZMA_API_STATIC -DMYTHREAD_VISTA -DPACKAGE_BUGREPORT=\\\"xz@tukaani.org\\\" -DPACKAGE_NAME=\"\\\"XZ Utils\\\"\" -DPACKAGE_URL=\\\"https://tukaani.org/xz/\\\" -DTUKLIB_FAST_UNALIGNED_ACCESS -I /sources/lzma/src/common -I /sources/lzma/src/liblzma/api  /sources/lzma/src/xzdec/xzdec_w32res.rc CMakeFiles/xzdec.dir/src/xzdec/xzdec_w32res.rc.res\r\nllvm-rc: Error parsing file: Invalid token found at position 635`","reactions":{"url":"https://api.github.com/repos/mstorsjo/llvm-mingw/issues/363/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mstorsjo/llvm-mingw/issues/363/timeline","performed_via_github_app":null,"state_reason":null},"comment":{"url":"https://api.github.com/repos/mstorsjo/llvm-mingw/issues/comments/1699774061","html_url":"https://github.com/mstorsjo/llvm-mingw/issues/363#issuecomment-1699774061","issue_url":"https://api.github.com/repos/mstorsjo/llvm-mingw/issues/363","id":1699774061,"node_id":"IC_kwDOBrDeIM5lUH5t","user":{"login":"mstorsjo","id":69727,"node_id":"MDQ6VXNlcjY5NzI3","avatar_url":"https://avatars.githubusercontent.com/u/69727?v=4","gravatar_id":"","url":"https://api.github.com/users/mstorsjo","html_url":"https://github.com/mstorsjo","followers_url":"https://api.github.com/users/mstorsjo/followers","following_url":"https://api.github.com/users/mstorsjo/following{/other_user}","gists_url":"https://api.github.com/users/mstorsjo/gists{/gist_id}","starred_url":"https://api.github.com/users/mstorsjo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstorsjo/subscriptions","organizations_url":"https://api.github.com/users/mstorsjo/orgs","repos_url":"https://api.github.com/users/mstorsjo/repos","events_url":"https://api.github.com/users/mstorsjo/events{/privacy}","received_events_url":"https://api.github.com/users/mstorsjo/received_events","type":"User","site_admin":false},"created_at":"2023-08-30T20:12:33Z","updated_at":"2023-08-30T20:12:33Z","author_association":"OWNER","body":"Thanks for reporting, and sorry for the slow response on this one.\r\n\r\nThis one is a surprisingly tricky case. Actually, things worked fine with the older releases based on LLVM 15 and 16 - upstream xz even seems to have done some manual workarounds specifically for llvm-windres - see https://github.com/tukaani-project/xz/commit/6b117d3b1fe91eb26d533ab16a2e552f84148d47.\r\n\r\nHowever a recent change in llvm-rc, https://github.com/llvm/llvm-project/commit/0f4c6b120f21d582ab7c5c4f2b2a475086c34938, which made one detail in llvm-windres match GNU windres better (fixing a discrepancy noted in https://github.com/llvm/llvm-project/issues/57334), actually turned out to break the llvm-windres specific handling used in xz.\r\n\r\nSo far, the canonical way of passing such strings to windres, that works both with GNU windres and LLVM windres, would be to invoke it with e.g. `-DPACKAGE_NAME=\\\\\\\"XZUtils\\\\\\\"` - as the default use of `popen()` in GNU windres eats one layer of quoting so things need to be doubly escaped. That works fine across both tools. But if xz would use that in their CMakeLists.txt in `add_compile_definitions`, it would also be passed in that doubly escaped form to the compiler when compiling regular C files, and that breaks things.\r\n\r\nI hadn't realized that the `--use-temp-file` flag to GNU windres actually removes this extra layer of escaping/unescaping by not using `popen()` but a function that preserves these special characters correctly. This isn't yet implemented in llvm-windres, but I'll try to get that implemented soon. With that implemented, the llvm-windres specific handling in https://github.com/tukaani-project/xz/blob/6b117d3b1fe91eb26d533ab16a2e552f84148d47/CMakeLists.txt#L96-L106 could be removed and the codepath used for the GNU tools could be used for both.\r\n","reactions":{"url":"https://api.github.com/repos/mstorsjo/llvm-mingw/issues/comments/1699774061/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null}},"public":true,"created_at":"2023-08-30T20:12:34Z"}
{"id":"31491267720","type":"IssuesEvent","actor":{"id":69727,"login":"mstorsjo","display_login":"mstorsjo","gravatar_id":"","url":"https://api.github.com/users/mstorsjo","avatar_url":"https://avatars.githubusercontent.com/u/69727?"},"repo":{"id":75821432,"name":"llvm/llvm-project","url":"https://api.github.com/repos/llvm/llvm-project"},"payload":{"action":"opened","issue":{"url":"https://api.github.com/repos/llvm/llvm-project/issues/65122","repository_url":"https://api.github.com/repos/llvm/llvm-project","labels_url":"https://api.github.com/repos/llvm/llvm-project/issues/65122/labels{/name}","comments_url":"https://api.github.com/repos/llvm/llvm-project/issues/65122/comments","events_url":"https://api.github.com/repos/llvm/llvm-project/issues/65122/events","html_url":"https://github.com/llvm/llvm-project/issues/65122","id":1874345015,"node_id":"I_kwDOBITxeM5vuDw3","number":65122,"title":"llvm-windres handling of unescaped quotes broke building xz","user":{"login":"mstorsjo","id":69727,"node_id":"MDQ6VXNlcjY5NzI3","avatar_url":"https://avatars.githubusercontent.com/u/69727?v=4","gravatar_id":"","url":"https://api.github.com/users/mstorsjo","html_url":"https://github.com/mstorsjo","followers_url":"https://api.github.com/users/mstorsjo/followers","following_url":"https://api.github.com/users/mstorsjo/following{/other_user}","gists_url":"https://api.github.com/users/mstorsjo/gists{/gist_id}","starred_url":"https://api.github.com/users/mstorsjo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstorsjo/subscriptions","organizations_url":"https://api.github.com/users/mstorsjo/orgs","repos_url":"https://api.github.com/users/mstorsjo/repos","events_url":"https://api.github.com/users/mstorsjo/events{/privacy}","received_events_url":"https://api.github.com/users/mstorsjo/received_events","type":"User","site_admin":false},"labels":[{"id":1958991186,"node_id":"MDU6TGFiZWwxOTU4OTkxMTg2","url":"https://api.github.com/repos/llvm/llvm-project/labels/llvm-tools","name":"llvm-tools","color":"b3aefc","default":false,"description":"All llvm tools that do not have corresponding tag"},{"id":3609292726,"node_id":"LA_kwDOBITxeM7XIW-2","url":"https://api.github.com/repos/llvm/llvm-project/labels/regression","name":"regression","color":"6699cc","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/llvm/llvm-project/milestones/25","html_url":"https://github.com/llvm/llvm-project/milestone/25","labels_url":"https://api.github.com/repos/llvm/llvm-project/milestones/25/labels","id":9286598,"node_id":"MI_kwDOBITxeM4AjbPG","number":25,"title":"LLVM 17.0.X Release","description":"branch: release/17.x","creator":{"login":"tbaederr","id":49720664,"node_id":"MDQ6VXNlcjQ5NzIwNjY0","avatar_url":"https://avatars.githubusercontent.com/u/49720664?v=4","gravatar_id":"","url":"https://api.github.com/users/tbaederr","html_url":"https://github.com/tbaederr","followers_url":"https://api.github.com/users/tbaederr/followers","following_url":"https://api.github.com/users/tbaederr/following{/other_user}","gists_url":"https://api.github.com/users/tbaederr/gists{/gist_id}","starred_url":"https://api.github.com/users/tbaederr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tbaederr/subscriptions","organizations_url":"https://api.github.com/users/tbaederr/orgs","repos_url":"https://api.github.com/users/tbaederr/repos","events_url":"https://api.github.com/users/tbaederr/events{/privacy}","received_events_url":"https://api.github.com/users/tbaederr/received_events","type":"User","site_admin":false},"open_issues":29,"closed_issues":186,"state":"open","created_at":"2023-04-15T06:56:51Z","updated_at":"2023-08-30T20:48:53Z","due_on":null,"closed_at":null},"comments":0,"created_at":"2023-08-30T20:48:53Z","updated_at":"2023-08-30T20:48:53Z","closed_at":null,"author_association":"MEMBER","active_lock_reason":null,"body":"The recent change (in 17.x) for llvm-windres handling of unescaped quotes in 0f4c6b120f21d582ab7c5c4f2b2a475086c34938 (which in itself fixed one aspect of https://github.com/llvm/llvm-project/issues/57334) instead broke use of llvm-windres in building xz (an llvm-windres specific workaround in https://github.com/tukaani-project/xz/commit/6b117d3b1fe91eb26d533ab16a2e552f84148d47, which worked before no longer works with the current llvm-windres).\r\n\r\nWe shouldn't be trading one bug for another, as the change from 0f4c6b120f21d582ab7c5c4f2b2a475086c34938 is correct in itself (making llvm-windres behaviour closer to GNU windres), we can implement the GNU windres flag `--use-temp-file` properly, which should allow the GNU windres codepath in xz to work for llvm-windres as well.\r\n\r\nA \"fix\" for this issue is up at https://reviews.llvm.org/D159223 - but to properly take that fix into use, xz will need to remove its llvm-windres specific handling.","reactions":{"url":"https://api.github.com/repos/llvm/llvm-project/issues/65122/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/llvm/llvm-project/issues/65122/timeline","performed_via_github_app":null,"state_reason":null}},"public":true,"created_at":"2023-08-30T20:48:54Z","org":{"id":17149993,"login":"llvm","gravatar_id":"","url":"https://api.github.com/orgs/llvm","avatar_url":"https://avatars.githubusercontent.com/u/17149993?"}}
