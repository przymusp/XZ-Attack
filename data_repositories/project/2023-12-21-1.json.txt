{"id":"34325650518","type":"IssueCommentEvent","actor":{"id":3759678,"login":"parheliamm","display_login":"parheliamm","gravatar_id":"","url":"https://api.github.com/users/parheliamm","avatar_url":"https://avatars.githubusercontent.com/u/3759678?"},"repo":{"id":553665726,"name":"tukaani-project/xz","url":"https://api.github.com/repos/tukaani-project/xz"},"payload":{"action":"created","issue":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/75","repository_url":"https://api.github.com/repos/tukaani-project/xz","labels_url":"https://api.github.com/repos/tukaani-project/xz/issues/75/labels{/name}","comments_url":"https://api.github.com/repos/tukaani-project/xz/issues/75/comments","events_url":"https://api.github.com/repos/tukaani-project/xz/issues/75/events","html_url":"https://github.com/tukaani-project/xz/pull/75","id":2047757718,"node_id":"PR_kwDOIQBEvs5iUo5o","number":75,"title":"Performance improvements on ARM64","user":{"login":"parheliamm","id":3759678,"node_id":"MDQ6VXNlcjM3NTk2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/3759678?v=4","gravatar_id":"","url":"https://api.github.com/users/parheliamm","html_url":"https://github.com/parheliamm","followers_url":"https://api.github.com/users/parheliamm/followers","following_url":"https://api.github.com/users/parheliamm/following{/other_user}","gists_url":"https://api.github.com/users/parheliamm/gists{/gist_id}","starred_url":"https://api.github.com/users/parheliamm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/parheliamm/subscriptions","organizations_url":"https://api.github.com/users/parheliamm/orgs","repos_url":"https://api.github.com/users/parheliamm/repos","events_url":"https://api.github.com/users/parheliamm/events{/privacy}","received_events_url":"https://api.github.com/users/parheliamm/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2023-12-19T01:29:31Z","updated_at":"2023-12-21T01:20:13Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"draft":false,"pull_request":{"url":"https://api.github.com/repos/tukaani-project/xz/pulls/75","html_url":"https://github.com/tukaani-project/xz/pull/75","diff_url":"https://github.com/tukaani-project/xz/pull/75.diff","patch_url":"https://github.com/tukaani-project/xz/pull/75.patch","merged_at":null},"body":"## Pull request checklist\r\n\r\nPlease check if your PR fulfills the following requirements:\r\n\r\n- [ ] Tests for the changes have been added (for bug fixes / features)\r\n- [ ] Docs have been reviewed and added / updated if needed (for bug fixes / features)\r\n- [x] Build was run locally and without warnings or errors\r\n- [x] All previous and new tests pass\r\n\r\n\r\n## Pull request type\r\n\r\n<!-- Please try to limit your pull request to one type, submit multiple\r\npull requests if needed. --> \r\n\r\nPlease check the type of change your PR introduces:\r\n\r\n- [ ] Bugfix\r\n- [ ] Feature\r\n- [ ] Code style update (formatting, renaming, typo fix)\r\n- [ ] Refactoring (no functional changes, no api changes)\r\n- [x] Build related changes\r\n- [ ] Documentation content changes\r\n- [x] Other (please describe): \r\n\r\n\r\n## What is the current behavior?\r\n\r\n<!-- Please describe the current behavior that you are modifying. -->\r\n\r\n\r\n<!-- Related issue this PR addresses, if applicable -->\r\nRelated Issue URL: \r\n\r\n\r\n## What is the new behavior?\r\n\r\n<!-- Please describe the behavior or changes that are being added by this\r\nPR. -->\r\n\r\n- Change LZMA_MEMCMPLEN_EXTRA to 8 on ARM64\r\n- select enable-unsafe-type-punning if enable_unaligned_access enabled\r\n  -\r\n\r\n## Does this introduce a breaking change?\r\n\r\n- [ ] Yes\r\n- [ ] No\r\n\r\n<!-- If this introduces a breaking change, please describe the impact and\r\nmigration path for existing applications below. -->\r\n\r\n\r\n## Other information\r\n\r\n<!-- Any other information that is important to this PR. -->\r\n\r\nPerformance improvements on ARM64 with 2 commits:\r\n\r\n    vanilla:\r\n    Compressor name         Compress. Decompress. Compr. size  Ratio Filename\r\n    memcpy                   5102 MB/s  5183 MB/s   211957760 100.00 silesia.tar\r\n    xz 5.2.5 -0              15.9 MB/s  51.6 MB/s    62579868  29.52 silesia.tar\r\n    xz 5.2.5 -1              11.8 MB/s  57.5 MB/s    58408297  27.56 silesia.tar\r\n    xz 5.2.5 -2              7.53 MB/s  59.9 MB/s    56708167  26.75 silesia.tar\r\n    xz 5.2.5 -3              5.02 MB/s  61.6 MB/s    55745576  26.30 silesia.tar\r\n    xz 5.2.5 -4              3.15 MB/s  62.7 MB/s    52106950  24.58 silesia.tar\r\n    xz 5.2.5 -5              2.29 MB/s  65.1 MB/s    49960648  23.57 silesia.tar\r\n    xz 5.2.5 -6              1.94 MB/s  65.5 MB/s    49196155  23.21 silesia.tar\r\n    xz 5.2.5 -7              1.83 MB/s  65.7 MB/s    48926731  23.08 silesia.tar\r\n    xz 5.2.5 -8              1.87 MB/s  66.4 MB/s    48768992  23.01 silesia.tar\r\n    xz 5.2.5 -9              1.85 MB/s  66.5 MB/s    48747544  23.00 silesia.tar\r\n\r\n\r\n\r\nPatched:\r\n\r\n```\r\nCompressor name         Compress. Decompress. Compr. size  Ratio Filename\r\nmemcpy                   5209 MB/s  5265 MB/s   211957760 100.00 silesia.tar\r\nxz 5.2.5 -0              16.4 MB/s  51.9 MB/s    62579868  29.52 silesia.tar\r\nxz 5.2.5 -1              12.0 MB/s  57.8 MB/s    58408297  27.56 silesia.tar\r\nxz 5.2.5 -2              8.26 MB/s  60.2 MB/s    56708167  26.75 silesia.tar\r\nxz 5.2.5 -3              5.14 MB/s  61.6 MB/s    55745576  26.30 silesia.tar\r\nxz 5.2.5 -4              3.29 MB/s  62.7 MB/s    52106950  24.58 silesia.tar\r\nxz 5.2.5 -5              2.42 MB/s  64.9 MB/s    49960648  23.57 silesia.tar\r\nxz 5.2.5 -6              2.03 MB/s  65.6 MB/s    49196155  23.21 silesia.tar\r\nxz 5.2.5 -7              1.93 MB/s  65.6 MB/s    48926731  23.08 silesia.tar\r\nxz 5.2.5 -8              1.94 MB/s  66.3 MB/s    48768992  23.01 silesia.tar\r\nxz 5.2.5 -9              1.91 MB/s  66.4 MB/s    48747544  23.00 silesia.tar\r\ndone... (cIters=1 dIters=1 cTime=1.0 dTime=2.0 chunkSize=1706MB cSpeed=0MB)\r\n```\r\n\r\n","reactions":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/75/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/tukaani-project/xz/issues/75/timeline","performed_via_github_app":null,"state_reason":null},"comment":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/comments/1865344776","html_url":"https://github.com/tukaani-project/xz/pull/75#issuecomment-1865344776","issue_url":"https://api.github.com/repos/tukaani-project/xz/issues/75","id":1865344776,"node_id":"IC_kwDOIQBEvs5vLucI","user":{"login":"parheliamm","id":3759678,"node_id":"MDQ6VXNlcjM3NTk2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/3759678?v=4","gravatar_id":"","url":"https://api.github.com/users/parheliamm","html_url":"https://github.com/parheliamm","followers_url":"https://api.github.com/users/parheliamm/followers","following_url":"https://api.github.com/users/parheliamm/following{/other_user}","gists_url":"https://api.github.com/users/parheliamm/gists{/gist_id}","starred_url":"https://api.github.com/users/parheliamm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/parheliamm/subscriptions","organizations_url":"https://api.github.com/users/parheliamm/orgs","repos_url":"https://api.github.com/users/parheliamm/repos","events_url":"https://api.github.com/users/parheliamm/events{/privacy}","received_events_url":"https://api.github.com/users/parheliamm/received_events","type":"User","site_admin":false},"created_at":"2023-12-21T01:20:12Z","updated_at":"2023-12-21T01:20:12Z","author_association":"NONE","body":"> I created a branch memcmplen_arm64 which should do the same as your first commit and also adds MSVC support on ARM64 (untested).\r\n> \r\n> The commit message of your second commit has significantly higher numbers on the memcpy line. I'm not familiar with lzbench but I wonder if 10 % difference in memcpy could indicate that there was something different on the test computer and thus the benchmark results could be slightly different too. The difference in compression speed is small so it would be good to be sure that it's not due to noise.\r\n> \r\n> In any case, the second patch cannot be accepted. Unfortunately you have misunderstood the problem with type punning. It's about the C programming language and how modern compilers optimize while still staying within the exact requirements of the C standard. Unsafe use of type punning breaks strict aliasing rules and might result in broken executables. The instruction set being used doesn't matter; even if unaligned access wasn't supported by the hardware, type punning would be problematic with modern compilers when accessing aligned data.\r\n> \r\n> The memcpy method used by tuklib_integer.h should compile to a single instruction with modern GCC and Clang/LLVM versions when building for a target that supports fast unaligned access. Thus the use of type punning shouldn't make a difference on ARM64. However, it's possible that compilers do something slightly differently still and thus there could be a difference in practice, or the violation of aliasing rules allows compilers to do something that happens to work but could cause problems some day. It's a bit annoying situation but I don't know any better way.\r\n>\r\n\r\nYes, you are correct, I disassemble the code, not only memcpy but also UNSAFE_TYPE_PUNNING are all interpreted as below:\r\n```\r\n 640:\tf9400000 \tldr\tx0, [x0]\r\n 644:\td65f03c0 \tret\r\n```\r\n\r\nSo the 2nd patch is useless, we can keep the 1st patch only.\r\n\r\n> Thanks!\r\n\r\n","reactions":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/comments/1865344776/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null}},"public":true,"created_at":"2023-12-21T01:20:14Z","org":{"id":116083088,"login":"tukaani-project","gravatar_id":"","url":"https://api.github.com/orgs/tukaani-project","avatar_url":"https://avatars.githubusercontent.com/u/116083088?"}}
