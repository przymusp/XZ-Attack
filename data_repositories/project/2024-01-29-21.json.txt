{"id":"35219171432","type":"IssueCommentEvent","actor":{"id":133907478,"login":"hansjans162","display_login":"hansjans162","gravatar_id":"","url":"https://api.github.com/users/hansjans162","avatar_url":"https://avatars.githubusercontent.com/u/133907478?"},"repo":{"id":553665726,"name":"tukaani-project/xz","url":"https://api.github.com/repos/tukaani-project/xz"},"payload":{"action":"created","issue":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/77","repository_url":"https://api.github.com/repos/tukaani-project/xz","labels_url":"https://api.github.com/repos/tukaani-project/xz/issues/77/labels{/name}","comments_url":"https://api.github.com/repos/tukaani-project/xz/issues/77/comments","events_url":"https://api.github.com/repos/tukaani-project/xz/issues/77/events","html_url":"https://github.com/tukaani-project/xz/pull/77","id":2071987912,"node_id":"PR_kwDOIQBEvs5jjrrh","number":77,"title":"Speed up CRC32 calculation on ARM64","user":{"login":"parheliamm","id":3759678,"node_id":"MDQ6VXNlcjM3NTk2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/3759678?v=4","gravatar_id":"","url":"https://api.github.com/users/parheliamm","html_url":"https://github.com/parheliamm","followers_url":"https://api.github.com/users/parheliamm/followers","following_url":"https://api.github.com/users/parheliamm/following{/other_user}","gists_url":"https://api.github.com/users/parheliamm/gists{/gist_id}","starred_url":"https://api.github.com/users/parheliamm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/parheliamm/subscriptions","organizations_url":"https://api.github.com/users/parheliamm/orgs","repos_url":"https://api.github.com/users/parheliamm/repos","events_url":"https://api.github.com/users/parheliamm/events{/privacy}","received_events_url":"https://api.github.com/users/parheliamm/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":16,"created_at":"2024-01-09T09:38:00Z","updated_at":"2024-01-29T21:19:32Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"draft":false,"pull_request":{"url":"https://api.github.com/repos/tukaani-project/xz/pulls/77","html_url":"https://github.com/tukaani-project/xz/pull/77","diff_url":"https://github.com/tukaani-project/xz/pull/77.diff","patch_url":"https://github.com/tukaani-project/xz/pull/77.patch","merged_at":null},"body":"The CRC32 instructions in ARM64 can calculate the CRC32 result for 8 bytes in a single operation, making the use of ARM64 instructions much faster compared to the general CRC32 algorithm.\r\n\r\nOptimized CRC32 will be enabled if ARM64 has CRC extension running on Linux.\r\n\r\n## Pull request checklist\r\n\r\nPlease check if your PR fulfills the following requirements:\r\n\r\n- [ ] Tests for the changes have been added (for bug fixes / features)\r\n- [ ] Docs have been reviewed and added / updated if needed (for bug fixes / features)\r\n- [x] Build was run locally and without warnings or errors\r\n- [ ] All previous and new tests pass\r\n\r\n\r\n## Pull request type\r\n\r\n<!-- Please try to limit your pull request to one type, submit multiple\r\npull requests if needed. --> \r\n\r\nPlease check the type of change your PR introduces:\r\n\r\n- [ ] Bugfix\r\n- [x] Feature\r\n- [ ] Code style update (formatting, renaming, typo fix)\r\n- [ ] Refactoring (no functional changes, no api changes)\r\n- [ ] Build related changes\r\n- [ ] Documentation content changes\r\n- [ ] Other (please describe): \r\n\r\n\r\n## What is the current behavior?\r\n\r\n<!-- Please describe the current behavior that you are modifying. -->\r\n\r\n\r\n<!-- Related issue this PR addresses, if applicable -->\r\nRelated Issue URL: \r\n\r\n\r\n## What is the new behavior?\r\n\r\n<!-- Please describe the behavior or changes that are being added by this\r\nPR. -->\r\n\r\n- Enable optimized CRC32 algorithm if ARM64 support CRC extension.\r\n  -\r\n  -\r\n\r\n## Does this introduce a breaking change?\r\n\r\n- [ ] Yes\r\n- [ ] No\r\n\r\n<!-- If this introduces a breaking change, please describe the impact and\r\nmigration path for existing applications below. -->\r\n\r\n\r\n## Other information\r\n\r\nBenchmark data will be updated soon","reactions":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/77/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/tukaani-project/xz/issues/77/timeline","performed_via_github_app":null,"state_reason":null},"comment":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/comments/1915590564","html_url":"https://github.com/tukaani-project/xz/pull/77#issuecomment-1915590564","issue_url":"https://api.github.com/repos/tukaani-project/xz/issues/77","id":1915590564,"node_id":"IC_kwDOIQBEvs5yLZek","user":{"login":"hansjans162","id":133907478,"node_id":"U_kgDOB_tEFg","avatar_url":"https://avatars.githubusercontent.com/u/133907478?v=4","gravatar_id":"","url":"https://api.github.com/users/hansjans162","html_url":"https://github.com/hansjans162","followers_url":"https://api.github.com/users/hansjans162/followers","following_url":"https://api.github.com/users/hansjans162/following{/other_user}","gists_url":"https://api.github.com/users/hansjans162/gists{/gist_id}","starred_url":"https://api.github.com/users/hansjans162/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hansjans162/subscriptions","organizations_url":"https://api.github.com/users/hansjans162/orgs","repos_url":"https://api.github.com/users/hansjans162/repos","events_url":"https://api.github.com/users/hansjans162/events{/privacy}","received_events_url":"https://api.github.com/users/hansjans162/received_events","type":"User","site_admin":false},"created_at":"2024-01-29T21:19:31Z","updated_at":"2024-01-29T21:19:31Z","author_association":"CONTRIBUTOR","body":"> @parheliamm @hansjans162 Thank you for your patience on this review. We had a few other things we were focusing on (new website, release, etc.). I promise I did not forget about this :)\r\n> \r\n> I created a [branch](https://github.com/tukaani-project/xz/tree/arm64_crc32) with some additions to this PR that will also be helpful for the CRC64 CLMUL. The extent of the edits should be clear from the commit messages and code changes, but let me know if you have questions about the changes.\r\n> \r\n> Can you both test this on your hardware to be sure it works correctly (and is still fast)? I was able to cross-compile it with GCC, Clang, and MSVC but I do not have an ARM64 device so I have not run the code. Thanks!\r\n\r\nI tested your code and found a problem with the crc32_arch_optimized function. the updated function below should fix this.\r\n\r\nI made two changes to this function. First was making align_amount the difference from 8 instead of just the remainder. I also xor this with 8 so buf_end does not change if it is already properly aligned. The second thing was changing __crc32w to __crc32d.\r\n```c\r\ncrc_attr_target\r\nstatic uint32_t\r\ncrc32_arch_optimized(const uint8_t *buf, size_t size, uint32_t crc)\r\n{\r\n\tcrc = ~crc;\r\n\r\n\t// Align the input buffer because this was shown to be\r\n\t// significantly faster than unaligned accesses.\r\n\tconst size_t align_amount = my_min(size, ((8-((uintptr_t)(buf) & 7))^8));\r\n\tconst uint8_t *buf_end = buf + align_amount;\r\n\r\n\tfor (; buf < buf_end; ++buf)\r\n\t\tcrc = __crc32b(crc, *buf);\r\n\r\n\tfor (buf_end = ((size - align_amount) - 8) + buf; buf < buf_end;\r\n\t\t\tbuf += 8)\r\n\t\tcrc = __crc32d(crc, aligned_read64le(buf));\r\n\r\n\tfor (buf_end += 8; buf < buf_end; ++buf)\r\n\t\tcrc = __crc32b(crc, *buf);\r\n\r\n\treturn ~crc;\r\n}\r\n```","reactions":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/comments/1915590564/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null}},"public":true,"created_at":"2024-01-29T21:19:33Z","org":{"id":116083088,"login":"tukaani-project","gravatar_id":"","url":"https://api.github.com/orgs/tukaani-project","avatar_url":"https://avatars.githubusercontent.com/u/116083088?"}}
