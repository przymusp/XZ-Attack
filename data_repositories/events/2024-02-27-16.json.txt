{"id":"36058249070","type":"IssueCommentEvent","actor":{"id":78042786,"login":"JiaT75","display_login":"JiaT75","gravatar_id":"","url":"https://api.github.com/users/JiaT75","avatar_url":"https://avatars.githubusercontent.com/u/78042786?"},"repo":{"id":553665726,"name":"tukaani-project/xz","url":"https://api.github.com/repos/tukaani-project/xz"},"payload":{"action":"created","issue":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/89","repository_url":"https://api.github.com/repos/tukaani-project/xz","labels_url":"https://api.github.com/repos/tukaani-project/xz/issues/89/labels{/name}","comments_url":"https://api.github.com/repos/tukaani-project/xz/issues/89/comments","events_url":"https://api.github.com/repos/tukaani-project/xz/issues/89/events","html_url":"https://github.com/tukaani-project/xz/issues/89","id":2156864527,"node_id":"I_kwDOIQBEvs6AjyQP","number":89,"title":"[Bug]: xz: Reduced the number of threads from ... to not exceed the memory usage limit of ... MiB","user":{"login":"asarubbo","id":4741819,"node_id":"MDQ6VXNlcjQ3NDE4MTk=","avatar_url":"https://avatars.githubusercontent.com/u/4741819?v=4","gravatar_id":"","url":"https://api.github.com/users/asarubbo","html_url":"https://github.com/asarubbo","followers_url":"https://api.github.com/users/asarubbo/followers","following_url":"https://api.github.com/users/asarubbo/following{/other_user}","gists_url":"https://api.github.com/users/asarubbo/gists{/gist_id}","starred_url":"https://api.github.com/users/asarubbo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/asarubbo/subscriptions","organizations_url":"https://api.github.com/users/asarubbo/orgs","repos_url":"https://api.github.com/users/asarubbo/repos","events_url":"https://api.github.com/users/asarubbo/events{/privacy}","received_events_url":"https://api.github.com/users/asarubbo/received_events","type":"User","site_admin":false},"labels":[{"id":4687621022,"node_id":"LA_kwDOIQBEvs8AAAABF2drng","url":"https://api.github.com/repos/tukaani-project/xz/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2024-02-27T15:16:41Z","updated_at":"2024-02-27T16:53:48Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Describe the bug\r\n\r\nSince few days I updated to 5.6.0.\r\n\r\nWhen I try to compress text I always get:\r\n\r\n```\r\nxz: Reduced the number of threads from 64 to X to not exceed the memory usage limit of .. MiB\r\n```\r\n\r\nSo to use threads I increased the memory limit around 3GB but still I get the message.\r\n\r\nAs a POC I did:\r\n```\r\necho \"a\" > file\r\nfor i in {1..64} ; do echo $i ; xz -k -f -z -9 -T $i -M 3000000000 file ; done\r\n```\r\nAnd I discovered that with `i=3` it reduces threads from `i` to 2\r\n\r\n`xz -H` says that `-M` accepts the LIMIT in bytes, so 3000000000 are 3GB of ram.\r\n\r\nIs there anything wrong with it or how much ram I'm supposing to give to the process? \r\n\r\n\r\n\r\n\r\n### Version\r\n\r\n5.6.0\r\n\r\n### Operating System\r\n\r\nGentoo Linux\r\n\r\n### Relevant log output\r\n\r\n_No response_","reactions":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/89/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/tukaani-project/xz/issues/89/timeline","performed_via_github_app":null,"state_reason":null},"comment":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/comments/1967105982","html_url":"https://github.com/tukaani-project/xz/issues/89#issuecomment-1967105982","issue_url":"https://api.github.com/repos/tukaani-project/xz/issues/89","id":1967105982,"node_id":"IC_kwDOIQBEvs51P6e-","user":{"login":"JiaT75","id":78042786,"node_id":"MDQ6VXNlcjc4MDQyNzg2","avatar_url":"https://avatars.githubusercontent.com/u/78042786?v=4","gravatar_id":"","url":"https://api.github.com/users/JiaT75","html_url":"https://github.com/JiaT75","followers_url":"https://api.github.com/users/JiaT75/followers","following_url":"https://api.github.com/users/JiaT75/following{/other_user}","gists_url":"https://api.github.com/users/JiaT75/gists{/gist_id}","starred_url":"https://api.github.com/users/JiaT75/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JiaT75/subscriptions","organizations_url":"https://api.github.com/users/JiaT75/orgs","repos_url":"https://api.github.com/users/JiaT75/repos","events_url":"https://api.github.com/users/JiaT75/events{/privacy}","received_events_url":"https://api.github.com/users/JiaT75/received_events","type":"User","site_admin":false},"created_at":"2024-02-27T16:53:47Z","updated_at":"2024-02-27T16:53:47Z","author_association":"MEMBER","body":"Hello!\r\n\r\nThanks for the bug report. The cause of this is because in 5.6.0 we made the default compression mode multi threaded. By default, xz will try to use the number of cores to determine how many threads to use when compressing/decompressing. If there is not enough memory to support this many threads, it will reduce the number of threads. Showing this as a warning message made more sense before because multi threading was not the default.\r\n\r\nTo answer your question, the amount of memory required per thread with default options is the block size * 2 + LZMA2 dictionary size. Block size is determined by 3 * LZMA2 dictionary size or a minimum of 1 MiB. So the amount of memory you give to xz depends on how many threads you want to be used. More threads just means faster compression, not better compression ratio. For best compression ratio, use single threaded mode (`-T1`).\r\n\r\nAnother user reported this on the mailing list, so we already started considering different options. As a user, would you rather see the number of threads actually used in verbose mode (`-v`) or debug mode (`-vv`)? We are all in agreement that this message should not be displayed by default :)","reactions":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/comments/1967105982/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null}},"public":true,"created_at":"2024-02-27T16:53:48Z","org":{"id":116083088,"login":"tukaani-project","gravatar_id":"","url":"https://api.github.com/orgs/tukaani-project","avatar_url":"https://avatars.githubusercontent.com/u/116083088?"}}
