{"id":"30207089295","type":"IssuesEvent","actor":{"id":47400,"login":"rui314","display_login":"rui314","gravatar_id":"","url":"https://api.github.com/users/rui314","avatar_url":"https://avatars.githubusercontent.com/u/47400?"},"repo":{"id":299510783,"name":"rui314/mold","url":"https://api.github.com/repos/rui314/mold"},"payload":{"action":"closed","issue":{"url":"https://api.github.com/repos/rui314/mold/issues/1056","repository_url":"https://api.github.com/repos/rui314/mold","labels_url":"https://api.github.com/repos/rui314/mold/issues/1056/labels{/name}","comments_url":"https://api.github.com/repos/rui314/mold/issues/1056/comments","events_url":"https://api.github.com/repos/rui314/mold/issues/1056/events","html_url":"https://github.com/rui314/mold/issues/1056","id":1786153543,"node_id":"I_kwDOEdor_85qdopH","number":1056,"title":"Duplicate symbol suffix of libraries when building with LTO","user":{"login":"kostadinsh","id":46091994,"node_id":"MDQ6VXNlcjQ2MDkxOTk0","avatar_url":"https://avatars.githubusercontent.com/u/46091994?v=4","gravatar_id":"","url":"https://api.github.com/users/kostadinsh","html_url":"https://github.com/kostadinsh","followers_url":"https://api.github.com/users/kostadinsh/followers","following_url":"https://api.github.com/users/kostadinsh/following{/other_user}","gists_url":"https://api.github.com/users/kostadinsh/gists{/gist_id}","starred_url":"https://api.github.com/users/kostadinsh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kostadinsh/subscriptions","organizations_url":"https://api.github.com/users/kostadinsh/orgs","repos_url":"https://api.github.com/users/kostadinsh/repos","events_url":"https://api.github.com/users/kostadinsh/events{/privacy}","received_events_url":"https://api.github.com/users/kostadinsh/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2023-07-03T13:08:41Z","updated_at":"2023-07-05T10:09:25Z","closed_at":"2023-07-05T10:09:25Z","author_association":"NONE","active_lock_reason":null,"body":"When building [tukaani-project/xz](https://github.com/tukaani-project) with the mold linker and -flto added to CFLAGS, this package seems to have some issues in the linking phase regarding symbols not being found. I've turned mold's warnings into errors with -Wl,--fatal-warnings, so I can catch them more easily.\r\nGCC version used is gcc (Gentoo 13.1.1_p20230527 p3) 13.1.1 20230527\r\nMold is built from git at commit b04aba89d3a1931470983212925443e7aefca1e1\r\n\r\n```\r\nlibtool: link: gcc -shared  -fPIC -DPIC  .libs/liblzma_la-tuklib_physmem.o .libs/liblzma_la-tuklib_cpucores.o .libs/liblzma_la-common.o .libs/liblzma_la-block_util.o .libs/liblzma_la-easy_preset.o .libs/liblzma_la-filter_common.o .libs/liblzma_la-hardware_physmem.o .libs/liblzma_la-index.o .libs/liblzma_la-stream_flags_common.o .libs/liblzma_la-string_conversion.o .libs/liblzma_la-vli_size.o .libs/liblzma_la-hardware_cputhreads.o .libs/liblzma_la-outqueue.o .libs/liblzma_la-alone_encoder.o .libs/liblzma_la-block_buffer_encoder.o .libs/liblzma_la-block_encoder.o .libs/liblzma_la-block_header_encoder.o .libs/liblzma_la-easy_buffer_encoder.o .libs/liblzma_la-easy_encoder.o .libs/liblzma_la-easy_encoder_memusage.o .libs/liblzma_la-filter_buffer_encoder.o .libs/liblzma_la-filter_encoder.o .libs/liblzma_la-filter_flags_encoder.o .libs/liblzma_la-index_encoder.o .libs/liblzma_la-stream_buffer_encoder.o .libs/liblzma_la-stream_encoder.o .libs/liblzma_la-stream_flags_encoder.o .libs/liblzma_la-vli_encoder.o .libs/liblzma_la-stream_encoder_mt.o .libs/liblzma_la-microlzma_encoder.o .libs/liblzma_la-alone_decoder.o .libs/liblzma_la-auto_decoder.o .libs/liblzma_la-block_buffer_decoder.o .libs/liblzma_la-block_decoder.o .libs/liblzma_la-block_header_decoder.o .libs/liblzma_la-easy_decoder_memusage.o .libs/liblzma_la-file_info.o .libs/liblzma_la-filter_buffer_decoder.o .libs/liblzma_la-filter_decoder.o .libs/liblzma_la-filter_flags_decoder.o .libs/liblzma_la-index_decoder.o .libs/liblzma_la-index_hash.o .libs/liblzma_la-stream_buffer_decoder.o .libs/liblzma_la-stream_decoder.o .libs/liblzma_la-stream_flags_decoder.o .libs/liblzma_la-vli_decoder.o .libs/liblzma_la-stream_decoder_mt.o .libs/liblzma_la-microlzma_decoder.o .libs/liblzma_la-lzip_decoder.o .libs/liblzma_la-check.o .libs/liblzma_la-crc32_table.o .libs/liblzma_la-crc32_fast.o .libs/liblzma_la-crc64_table.o .libs/liblzma_la-crc64_fast.o .libs/liblzma_la-sha256.o .libs/liblzma_la-lz_encoder.o .libs/liblzma_la-lz_encoder_mf.o .libs/liblzma_la-lz_decoder.o .libs/liblzma_la-lzma_encoder_presets.o .libs/liblzma_la-lzma_encoder.o .libs/liblzma_la-lzma_encoder_optimum_fast.o .libs/liblzma_la-lzma_encoder_optimum_normal.o .libs/liblzma_la-fastpos_table.o .libs/liblzma_la-lzma_decoder.o .libs/liblzma_la-lzma2_encoder.o .libs/liblzma_la-lzma2_decoder.o .libs/liblzma_la-price_table.o .libs/liblzma_la-delta_common.o .libs/liblzma_la-delta_encoder.o .libs/liblzma_la-delta_decoder.o .libs/liblzma_la-simple_coder.o .libs/liblzma_la-simple_encoder.o .libs/liblzma_la-simple_decoder.o .libs/liblzma_la-x86.o .libs/liblzma_la-powerpc.o .libs/liblzma_la-ia64.o .libs/liblzma_la-arm.o .libs/liblzma_la-armthumb.o .libs/liblzma_la-arm64.o .libs/liblzma_la-sparc.o   -lpthread  -O2 -flto=auto -Wl,--version-script=../../../src/liblzma/liblzma_linux.map -fuse-ld=mold -Wl,--fatal-warnings   -pthread -Wl,-soname -Wl,liblzma.so.5 -o .libs/liblzma.so.5.5.99\r\nmold: error: ../../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2` to symbol `lzma_block_uncomp_encode`: symbol not found\r\nmold: error: ../../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2` to symbol `lzma_cputhreads`: symbol not found\r\nmold: error: ../../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2` to symbol `lzma_get_progress`: symbol not found\r\nmold: error: ../../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2` to symbol `lzma_stream_encoder_mt`: symbol not found\r\nmold: error: ../../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2` to symbol `lzma_stream_encoder_mt_memusage`: symbol not found\r\nmold: error: ../../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.1.2alpha` to symbol `lzma_stream_encoder_mt`: symbol not found\r\nmold: error: ../../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.1.2alpha` to symbol `lzma_stream_encoder_mt_memusage`: symbol not found\r\nmold: error: ../../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2.2` to symbol `lzma_block_uncomp_encode`: symbol not found\r\nmold: error: ../../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2.2` to symbol `lzma_cputhreads`: symbol not found\r\nmold: error: ../../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2.2` to symbol `lzma_get_progress`: symbol not found\r\nmold: error: ../../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2.2` to symbol `lzma_stream_encoder_mt`: symbol not found\r\nmold: error: ../../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2.2` to symbol `lzma_stream_encoder_mt_memusage`: symbol not found\r\ncollect2: error: ld returned 1 exit status\r\n```\r\n\r\nOne of the devs did some testing with different linkers and found out that using GCC with bfd and gold, and Clang with lld all build the program properly, but mold has an issue where it duplicates the symbols' suffix.\r\n\r\n\r\nExample with the \"default\" linkers:\r\n\r\n```\r\n$ readelf -W --dyn-syms src/liblzma/.libs/liblzma.so.5 \\\r\n    | grep lzma_stream_encoder_mt_memusage\r\n   127: 000000000000db90   222 FUNC    GLOBAL DEFAULT   13 lzma_stream_encoder_mt_memusage@@XZ_5.2\r\n   128: 000000000000db90   222 FUNC    GLOBAL DEFAULT   13 lzma_stream_encoder_mt_memusage@XZ_5.1.2alpha\r\n   129: 000000000000db90   222 FUNC    GLOBAL DEFAULT   13 lzma_stream_encoder_mt_memusage@XZ_5.2.2\r\n```\r\n\r\nExample with mold:\r\n\r\n```\r\n$ readelf -W --dyn-syms src/liblzma/.libs/liblzma.so.5 \\\r\n    | grep lzma_stream_encoder_mt_memusage\r\n    49: 000000000001c690   222 FUNC    GLOBAL DEFAULT   20 lzma_stream_encoder_mt_memusage@@XZ_5.2\r\n    56: 000000000001c690   222 FUNC    GLOBAL DEFAULT   20 lzma_stream_encoder_mt_memusage@XZ_5.2.2@XZ_5.2.2\r\n   104: 000000000001c690   222 FUNC    GLOBAL DEFAULT   20 lzma_stream_encoder_mt_memusage@XZ_5.1.2alpha@XZ_5.1.2alpha\r\n```\r\n\r\nOriginal bug report at the package's repo: https://github.com/tukaani-project/xz/issues/55\r\n\r\nThis is also reproducible with fuse: \r\nhttps://github.com/libfuse/libfuse/issues/810\r\n\r\n```\r\n[48/73] cc  -o lib/libfuse3.so.3.15.0 lib/libfuse3.so.3.15.0.p/fuse.c.o lib/libfuse3.so.3.15.0.p/fuse_loop.c.o lib/libfuse3.so.3.15.0.p/fuse_loop_mt.c.o lib/libfuse3.so.3.15.0.p/fuse_lowlevel.c.o lib/libfuse3.so.3.15.0.p/fuse_opt.c.o lib/libfuse3.so.3.15.0.p/fuse_signals.c.o lib/libfuse3.so.3.15.0.p/buffer.c.o lib/libfuse3.so.3.15.0.p/cuse_lowlevel.c.o lib/libfuse3.so.3.15.0.p/helper.c.o lib/libfuse3.so.3.15.0.p/modules_subdir.c.o lib/libfuse3.so.3.15.0.p/mount_util.c.o lib/libfuse3.so.3.15.0.p/fuse_log.c.o lib/libfuse3.so.3.15.0.p/compat.c.o lib/libfuse3.so.3.15.0.p/mount.c.o lib/libfuse3.so.3.15.0.p/modules_iconv.c.o -Wl,--as-needed -Wl,--no-undefined -shared -fPIC -Wl,--start-group -Wl,-soname,libfuse3.so.3 -fuse-ld=mold -O2 -flto -Wl,--version-script,/home/kostadin/libfuse/lib/fuse_versionscript -pthread -ldl -lrt -Wl,--end-group\r\nmold: warning: /home/kostadin/libfuse/lib/fuse_versionscript: cannot assign version `FUSE_3.0` to symbol `fuse_loop_mt`: symbol not found\r\nmold: warning: /home/kostadin/libfuse/lib/fuse_versionscript: cannot assign version `FUSE_3.0` to symbol `fuse_session_loop_mt`: symbol not found\r\nmold: warning: /home/kostadin/libfuse/lib/fuse_versionscript: cannot assign version `FUSE_3.0` to symbol `fuse_parse_cmdline`: symbol not found\r\nmold: warning: /home/kostadin/libfuse/lib/fuse_versionscript: cannot assign version `FUSE_3.0` to symbol `fuse_new`: symbol not found\r\nmold: warning: /home/kostadin/libfuse/lib/fuse_versionscript: cannot assign version `FUSE_3.0` to symbol `fuse_register_module`: symbol not found\r\nmold: warning: /home/kostadin/libfuse/lib/fuse_versionscript: cannot assign version `FUSE_3.1` to symbol `fuse_new`: symbol not found\r\nmold: warning: /home/kostadin/libfuse/lib/fuse_versionscript: cannot assign version `FUSE_3.2` to symbol `fuse_session_loop_mt`: symbol not found\r\nmold: warning: /home/kostadin/libfuse/lib/fuse_versionscript: cannot assign version `FUSE_3.2` to symbol `fuse_loop_mt`: symbol not found\r\nmold: warning: /home/kostadin/libfuse/lib/fuse_versionscript: cannot assign version `FUSE_3.4` to symbol `fuse_reply_copy_file_range`: symbol not found\r\nmold: warning: /home/kostadin/libfuse/lib/fuse_versionscript: cannot assign version `FUSE_3.12` to symbol `fuse_session_loop_mt`: symbol not found\r\nmold: warning: /home/kostadin/libfuse/lib/fuse_versionscript: cannot assign version `FUSE_3.12` to symbol `fuse_loop_mt`: symbol not found\r\nmold: warning: /home/kostadin/libfuse/lib/fuse_versionscript: cannot assign version `FUSE_3.12` to symbol `fuse_parse_cmdline`: symbol not found\r\nlto-wrapper: warning: using serial compilation of 2 LTRANS jobs\r\nlto-wrapper: note: see the ‘-flto’ option documentation for more information\r\nmold: warning: /home/kostadin/libfuse/lib/fuse_versionscript: cannot assign version `FUSE_3.0` to symbol `fuse_register_module`: symbol not found\r\nmold: warning: /home/kostadin/libfuse/lib/fuse_versionscript: cannot assign version `FUSE_3.4` to symbol `fuse_reply_copy_file_range`: symbol not found\r\n```\r\n\r\nmold linker: \r\n```\r\n$ readelf -W --dyn-syms lib/libfuse3.so.3 | grep fuse_loop_mt\r\n   142: 000000000001a220    71 FUNC    GLOBAL DEFAULT   19 fuse_loop_mt@@FUSE_3.12\r\n   154: 000000000001a2c0    76 FUNC    GLOBAL DEFAULT   19 fuse_loop_mt_31@@FUSE_3.2\r\n   158: 000000000001a2c0    76 FUNC    GLOBAL DEFAULT   19 fuse_loop_mt@FUSE_3.0@FUSE_3.0\r\n   164: 000000000001a270    76 FUNC    GLOBAL DEFAULT   19 fuse_loop_mt_32@@FUSE_3.12\r\n   177: 000000000001a270    76 FUNC    GLOBAL DEFAULT   19 fuse_loop_mt@FUSE_3.2@FUSE_3.2\r\n   248: 000000000001a220    71 FUNC    GLOBAL DEFAULT   19 fuse_loop_mt_312@@FUSE_3.12\r\n```\r\n\r\nld linker:\r\n```\r\n$ readelf -W --dyn-syms lib/libfuse3.so.3 | grep fuse_loop_mt\r\n180: 00000000000100a0    76 FUNC    GLOBAL DEFAULT   11 fuse_loop_mt@FUSE_3.0\r\n   181: 0000000000010050    76 FUNC    GLOBAL DEFAULT   11 fuse_loop_mt@FUSE_3.2\r\n   182: 0000000000010000    71 FUNC    GLOBAL DEFAULT   11 fuse_loop_mt@@FUSE_3.12\r\n   202: 0000000000010000    71 FUNC    GLOBAL DEFAULT   11 fuse_loop_mt_312@@FUSE_3.12\r\n   275: 00000000000100a0    76 FUNC    GLOBAL DEFAULT   11 fuse_loop_mt_31@@FUSE_3.2\r\n   277: 0000000000010050    76 FUNC    GLOBAL DEFAULT   11 fuse_loop_mt_32@@FUSE_3.12\r\n```\r\n\r\nAnd also with libbsd:\r\nhttps://gitlab.freedesktop.org/libbsd/libbsd/-/issues/18\r\n\r\n```\r\nlibtool: link: gcc -shared  -fPIC -DPIC  .libs/closefrom.o .libs/dehumanize_number.o .libs/err.o .libs/expand_number.o .libs/explicit_bzero.o .libs/fgetln.o .libs/fgetwln.o .libs/flopen.o .libs/fmtcheck.o .libs/fparseln.o .libs/freezero.o .libs/getbsize.o .libs/getpeereid.o .libs/heapsort.o .libs/humanize_number.o .libs/inet_net_pton.o .libs/merge.o .libs/pidfile.o .libs/progname.o .libs/pwcache.o .libs/radixsort.o .libs/readpassphrase.o .libs/reallocarray.o .libs/reallocf.o .libs/recallocarray.o .libs/setmode.o .libs/setproctitle.o .libs/stringlist.o .libs/strnstr.o .libs/strtoi.o .libs/strtonum.o .libs/strtou.o .libs/timeconv.o .libs/unvis.o .libs/vis.o .libs/bsd_getopt.o .libs/arc4random.o .libs/arc4random_uniform.o .libs/md5.o .libs/nlist.o .libs/strlcat.o .libs/strlcpy.o .libs/wcslcat.o .libs/wcslcpy.o .libs/strmode.o .libs/fpurge.o .libs/funopen.o   -lmd  -O2 -flto=auto -Wl,--version-script=./libbsd.map -fuse-ld=mold -Wl,--fatal-warnings   -Wl,-soname -Wl,libbsd.so.0 -o .libs/libbsd.so.0.11.7\r\nmold: error: ./libbsd.map: cannot assign version `LIBBSD_0.2` to symbol `strnvis`: symbol not found\r\nmold: error: ./libbsd.map: cannot assign version `LIBBSD_0.2` to symbol `strnunvis`: symbol not found\r\nmold: error: ./libbsd.map: cannot assign version `LIBBSD_0.5` to symbol `setproctitle`: symbol not found\r\n```\r\n\r\nld linker:\r\n```\r\n$ readelf -W --dyn-syms ./src/.libs/libbsd.so.0 | grep strnvis\r\n   126: 000000000000ca90   137 FUNC    GLOBAL DEFAULT   11 strnvis@LIBBSD_0.9.1\r\n   127: 000000000000ca00   137 FUNC    GLOBAL DEFAULT   11 strnvis@@LIBBSD_0.2\r\n   130: 000000000000ca90   137 FUNC    GLOBAL DEFAULT   11 strnvis_netbsd@@LIBBSD_0.9.1\r\n   159: 000000000000cbd0    96 FUNC    GLOBAL DEFAULT   11 strnvisx@@LIBBSD_0.11.0\r\n```\r\n\r\nmold linker:\r\n```\r\n$ readelf -W --dyn-syms ./src/.libs/libbsd.so.0 | grep strnvis\r\n120: 0000000000010570   137 FUNC    GLOBAL DEFAULT   20 strnvis@@LIBBSD_0.2\r\n   157: 0000000000010740    96 FUNC    GLOBAL DEFAULT   20 strnvisx@@LIBBSD_0.11.0\r\n   168: 0000000000010600   137 FUNC    GLOBAL DEFAULT   20 strnvis_netbsd@@LIBBSD_0.9.1\r\n   198: 0000000000010600   137 FUNC    GLOBAL DEFAULT   20 strnvis@LIBBSD_0.9.1@LIBBSD_0.9.1\r\n```\r\n\r\nI am also attaching the complete output of `readelf -W --dyn-syms` from each library with both ld and mold\r\n\r\n\r\n[readelf-xz-ld.txt](https://github.com/rui314/mold/files/11937064/readelf-xz-ld.txt)\r\n[readelf-xz-mold.txt](https://github.com/rui314/mold/files/11937066/readelf-xz-mold.txt)\r\n\r\n\r\n\r\n[readelf-fuse-ld.txt](https://github.com/rui314/mold/files/11937033/readelf-fuse-ld.txt)\r\n[readelf-fuse-mold.txt](https://github.com/rui314/mold/files/11937036/readelf-fuse-mold.txt)\r\n\r\n[readelf-libbsd-ld.txt](https://github.com/rui314/mold/files/11937037/readelf-libbsd-ld.txt)\r\n[readelf-libbsd-mold.txt](https://github.com/rui314/mold/files/11937038/readelf-libbsd-mold.txt)\r\n\r\n\r\n\r\n","reactions":{"url":"https://api.github.com/repos/rui314/mold/issues/1056/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rui314/mold/issues/1056/timeline","performed_via_github_app":null,"state_reason":"completed"}},"public":true,"created_at":"2023-07-05T10:09:26Z"}
{"id":"30207112499","type":"IssueCommentEvent","actor":{"id":47400,"login":"rui314","display_login":"rui314","gravatar_id":"","url":"https://api.github.com/users/rui314","avatar_url":"https://avatars.githubusercontent.com/u/47400?"},"repo":{"id":299510783,"name":"rui314/mold","url":"https://api.github.com/repos/rui314/mold"},"payload":{"action":"created","issue":{"url":"https://api.github.com/repos/rui314/mold/issues/1056","repository_url":"https://api.github.com/repos/rui314/mold","labels_url":"https://api.github.com/repos/rui314/mold/issues/1056/labels{/name}","comments_url":"https://api.github.com/repos/rui314/mold/issues/1056/comments","events_url":"https://api.github.com/repos/rui314/mold/issues/1056/events","html_url":"https://github.com/rui314/mold/issues/1056","id":1786153543,"node_id":"I_kwDOEdor_85qdopH","number":1056,"title":"Duplicate symbol suffix of libraries when building with LTO","user":{"login":"kostadinsh","id":46091994,"node_id":"MDQ6VXNlcjQ2MDkxOTk0","avatar_url":"https://avatars.githubusercontent.com/u/46091994?v=4","gravatar_id":"","url":"https://api.github.com/users/kostadinsh","html_url":"https://github.com/kostadinsh","followers_url":"https://api.github.com/users/kostadinsh/followers","following_url":"https://api.github.com/users/kostadinsh/following{/other_user}","gists_url":"https://api.github.com/users/kostadinsh/gists{/gist_id}","starred_url":"https://api.github.com/users/kostadinsh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kostadinsh/subscriptions","organizations_url":"https://api.github.com/users/kostadinsh/orgs","repos_url":"https://api.github.com/users/kostadinsh/repos","events_url":"https://api.github.com/users/kostadinsh/events{/privacy}","received_events_url":"https://api.github.com/users/kostadinsh/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2023-07-03T13:08:41Z","updated_at":"2023-07-05T10:10:19Z","closed_at":"2023-07-05T10:09:25Z","author_association":"NONE","active_lock_reason":null,"body":"When building [tukaani-project/xz](https://github.com/tukaani-project) with the mold linker and -flto added to CFLAGS, this package seems to have some issues in the linking phase regarding symbols not being found. I've turned mold's warnings into errors with -Wl,--fatal-warnings, so I can catch them more easily.\r\nGCC version used is gcc (Gentoo 13.1.1_p20230527 p3) 13.1.1 20230527\r\nMold is built from git at commit b04aba89d3a1931470983212925443e7aefca1e1\r\n\r\n```\r\nlibtool: link: gcc -shared  -fPIC -DPIC  .libs/liblzma_la-tuklib_physmem.o .libs/liblzma_la-tuklib_cpucores.o .libs/liblzma_la-common.o .libs/liblzma_la-block_util.o .libs/liblzma_la-easy_preset.o .libs/liblzma_la-filter_common.o .libs/liblzma_la-hardware_physmem.o .libs/liblzma_la-index.o .libs/liblzma_la-stream_flags_common.o .libs/liblzma_la-string_conversion.o .libs/liblzma_la-vli_size.o .libs/liblzma_la-hardware_cputhreads.o .libs/liblzma_la-outqueue.o .libs/liblzma_la-alone_encoder.o .libs/liblzma_la-block_buffer_encoder.o .libs/liblzma_la-block_encoder.o .libs/liblzma_la-block_header_encoder.o .libs/liblzma_la-easy_buffer_encoder.o .libs/liblzma_la-easy_encoder.o .libs/liblzma_la-easy_encoder_memusage.o .libs/liblzma_la-filter_buffer_encoder.o .libs/liblzma_la-filter_encoder.o .libs/liblzma_la-filter_flags_encoder.o .libs/liblzma_la-index_encoder.o .libs/liblzma_la-stream_buffer_encoder.o .libs/liblzma_la-stream_encoder.o .libs/liblzma_la-stream_flags_encoder.o .libs/liblzma_la-vli_encoder.o .libs/liblzma_la-stream_encoder_mt.o .libs/liblzma_la-microlzma_encoder.o .libs/liblzma_la-alone_decoder.o .libs/liblzma_la-auto_decoder.o .libs/liblzma_la-block_buffer_decoder.o .libs/liblzma_la-block_decoder.o .libs/liblzma_la-block_header_decoder.o .libs/liblzma_la-easy_decoder_memusage.o .libs/liblzma_la-file_info.o .libs/liblzma_la-filter_buffer_decoder.o .libs/liblzma_la-filter_decoder.o .libs/liblzma_la-filter_flags_decoder.o .libs/liblzma_la-index_decoder.o .libs/liblzma_la-index_hash.o .libs/liblzma_la-stream_buffer_decoder.o .libs/liblzma_la-stream_decoder.o .libs/liblzma_la-stream_flags_decoder.o .libs/liblzma_la-vli_decoder.o .libs/liblzma_la-stream_decoder_mt.o .libs/liblzma_la-microlzma_decoder.o .libs/liblzma_la-lzip_decoder.o .libs/liblzma_la-check.o .libs/liblzma_la-crc32_table.o .libs/liblzma_la-crc32_fast.o .libs/liblzma_la-crc64_table.o .libs/liblzma_la-crc64_fast.o .libs/liblzma_la-sha256.o .libs/liblzma_la-lz_encoder.o .libs/liblzma_la-lz_encoder_mf.o .libs/liblzma_la-lz_decoder.o .libs/liblzma_la-lzma_encoder_presets.o .libs/liblzma_la-lzma_encoder.o .libs/liblzma_la-lzma_encoder_optimum_fast.o .libs/liblzma_la-lzma_encoder_optimum_normal.o .libs/liblzma_la-fastpos_table.o .libs/liblzma_la-lzma_decoder.o .libs/liblzma_la-lzma2_encoder.o .libs/liblzma_la-lzma2_decoder.o .libs/liblzma_la-price_table.o .libs/liblzma_la-delta_common.o .libs/liblzma_la-delta_encoder.o .libs/liblzma_la-delta_decoder.o .libs/liblzma_la-simple_coder.o .libs/liblzma_la-simple_encoder.o .libs/liblzma_la-simple_decoder.o .libs/liblzma_la-x86.o .libs/liblzma_la-powerpc.o .libs/liblzma_la-ia64.o .libs/liblzma_la-arm.o .libs/liblzma_la-armthumb.o .libs/liblzma_la-arm64.o .libs/liblzma_la-sparc.o   -lpthread  -O2 -flto=auto -Wl,--version-script=../../../src/liblzma/liblzma_linux.map -fuse-ld=mold -Wl,--fatal-warnings   -pthread -Wl,-soname -Wl,liblzma.so.5 -o .libs/liblzma.so.5.5.99\r\nmold: error: ../../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2` to symbol `lzma_block_uncomp_encode`: symbol not found\r\nmold: error: ../../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2` to symbol `lzma_cputhreads`: symbol not found\r\nmold: error: ../../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2` to symbol `lzma_get_progress`: symbol not found\r\nmold: error: ../../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2` to symbol `lzma_stream_encoder_mt`: symbol not found\r\nmold: error: ../../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2` to symbol `lzma_stream_encoder_mt_memusage`: symbol not found\r\nmold: error: ../../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.1.2alpha` to symbol `lzma_stream_encoder_mt`: symbol not found\r\nmold: error: ../../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.1.2alpha` to symbol `lzma_stream_encoder_mt_memusage`: symbol not found\r\nmold: error: ../../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2.2` to symbol `lzma_block_uncomp_encode`: symbol not found\r\nmold: error: ../../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2.2` to symbol `lzma_cputhreads`: symbol not found\r\nmold: error: ../../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2.2` to symbol `lzma_get_progress`: symbol not found\r\nmold: error: ../../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2.2` to symbol `lzma_stream_encoder_mt`: symbol not found\r\nmold: error: ../../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2.2` to symbol `lzma_stream_encoder_mt_memusage`: symbol not found\r\ncollect2: error: ld returned 1 exit status\r\n```\r\n\r\nOne of the devs did some testing with different linkers and found out that using GCC with bfd and gold, and Clang with lld all build the program properly, but mold has an issue where it duplicates the symbols' suffix.\r\n\r\n\r\nExample with the \"default\" linkers:\r\n\r\n```\r\n$ readelf -W --dyn-syms src/liblzma/.libs/liblzma.so.5 \\\r\n    | grep lzma_stream_encoder_mt_memusage\r\n   127: 000000000000db90   222 FUNC    GLOBAL DEFAULT   13 lzma_stream_encoder_mt_memusage@@XZ_5.2\r\n   128: 000000000000db90   222 FUNC    GLOBAL DEFAULT   13 lzma_stream_encoder_mt_memusage@XZ_5.1.2alpha\r\n   129: 000000000000db90   222 FUNC    GLOBAL DEFAULT   13 lzma_stream_encoder_mt_memusage@XZ_5.2.2\r\n```\r\n\r\nExample with mold:\r\n\r\n```\r\n$ readelf -W --dyn-syms src/liblzma/.libs/liblzma.so.5 \\\r\n    | grep lzma_stream_encoder_mt_memusage\r\n    49: 000000000001c690   222 FUNC    GLOBAL DEFAULT   20 lzma_stream_encoder_mt_memusage@@XZ_5.2\r\n    56: 000000000001c690   222 FUNC    GLOBAL DEFAULT   20 lzma_stream_encoder_mt_memusage@XZ_5.2.2@XZ_5.2.2\r\n   104: 000000000001c690   222 FUNC    GLOBAL DEFAULT   20 lzma_stream_encoder_mt_memusage@XZ_5.1.2alpha@XZ_5.1.2alpha\r\n```\r\n\r\nOriginal bug report at the package's repo: https://github.com/tukaani-project/xz/issues/55\r\n\r\nThis is also reproducible with fuse: \r\nhttps://github.com/libfuse/libfuse/issues/810\r\n\r\n```\r\n[48/73] cc  -o lib/libfuse3.so.3.15.0 lib/libfuse3.so.3.15.0.p/fuse.c.o lib/libfuse3.so.3.15.0.p/fuse_loop.c.o lib/libfuse3.so.3.15.0.p/fuse_loop_mt.c.o lib/libfuse3.so.3.15.0.p/fuse_lowlevel.c.o lib/libfuse3.so.3.15.0.p/fuse_opt.c.o lib/libfuse3.so.3.15.0.p/fuse_signals.c.o lib/libfuse3.so.3.15.0.p/buffer.c.o lib/libfuse3.so.3.15.0.p/cuse_lowlevel.c.o lib/libfuse3.so.3.15.0.p/helper.c.o lib/libfuse3.so.3.15.0.p/modules_subdir.c.o lib/libfuse3.so.3.15.0.p/mount_util.c.o lib/libfuse3.so.3.15.0.p/fuse_log.c.o lib/libfuse3.so.3.15.0.p/compat.c.o lib/libfuse3.so.3.15.0.p/mount.c.o lib/libfuse3.so.3.15.0.p/modules_iconv.c.o -Wl,--as-needed -Wl,--no-undefined -shared -fPIC -Wl,--start-group -Wl,-soname,libfuse3.so.3 -fuse-ld=mold -O2 -flto -Wl,--version-script,/home/kostadin/libfuse/lib/fuse_versionscript -pthread -ldl -lrt -Wl,--end-group\r\nmold: warning: /home/kostadin/libfuse/lib/fuse_versionscript: cannot assign version `FUSE_3.0` to symbol `fuse_loop_mt`: symbol not found\r\nmold: warning: /home/kostadin/libfuse/lib/fuse_versionscript: cannot assign version `FUSE_3.0` to symbol `fuse_session_loop_mt`: symbol not found\r\nmold: warning: /home/kostadin/libfuse/lib/fuse_versionscript: cannot assign version `FUSE_3.0` to symbol `fuse_parse_cmdline`: symbol not found\r\nmold: warning: /home/kostadin/libfuse/lib/fuse_versionscript: cannot assign version `FUSE_3.0` to symbol `fuse_new`: symbol not found\r\nmold: warning: /home/kostadin/libfuse/lib/fuse_versionscript: cannot assign version `FUSE_3.0` to symbol `fuse_register_module`: symbol not found\r\nmold: warning: /home/kostadin/libfuse/lib/fuse_versionscript: cannot assign version `FUSE_3.1` to symbol `fuse_new`: symbol not found\r\nmold: warning: /home/kostadin/libfuse/lib/fuse_versionscript: cannot assign version `FUSE_3.2` to symbol `fuse_session_loop_mt`: symbol not found\r\nmold: warning: /home/kostadin/libfuse/lib/fuse_versionscript: cannot assign version `FUSE_3.2` to symbol `fuse_loop_mt`: symbol not found\r\nmold: warning: /home/kostadin/libfuse/lib/fuse_versionscript: cannot assign version `FUSE_3.4` to symbol `fuse_reply_copy_file_range`: symbol not found\r\nmold: warning: /home/kostadin/libfuse/lib/fuse_versionscript: cannot assign version `FUSE_3.12` to symbol `fuse_session_loop_mt`: symbol not found\r\nmold: warning: /home/kostadin/libfuse/lib/fuse_versionscript: cannot assign version `FUSE_3.12` to symbol `fuse_loop_mt`: symbol not found\r\nmold: warning: /home/kostadin/libfuse/lib/fuse_versionscript: cannot assign version `FUSE_3.12` to symbol `fuse_parse_cmdline`: symbol not found\r\nlto-wrapper: warning: using serial compilation of 2 LTRANS jobs\r\nlto-wrapper: note: see the ‘-flto’ option documentation for more information\r\nmold: warning: /home/kostadin/libfuse/lib/fuse_versionscript: cannot assign version `FUSE_3.0` to symbol `fuse_register_module`: symbol not found\r\nmold: warning: /home/kostadin/libfuse/lib/fuse_versionscript: cannot assign version `FUSE_3.4` to symbol `fuse_reply_copy_file_range`: symbol not found\r\n```\r\n\r\nmold linker: \r\n```\r\n$ readelf -W --dyn-syms lib/libfuse3.so.3 | grep fuse_loop_mt\r\n   142: 000000000001a220    71 FUNC    GLOBAL DEFAULT   19 fuse_loop_mt@@FUSE_3.12\r\n   154: 000000000001a2c0    76 FUNC    GLOBAL DEFAULT   19 fuse_loop_mt_31@@FUSE_3.2\r\n   158: 000000000001a2c0    76 FUNC    GLOBAL DEFAULT   19 fuse_loop_mt@FUSE_3.0@FUSE_3.0\r\n   164: 000000000001a270    76 FUNC    GLOBAL DEFAULT   19 fuse_loop_mt_32@@FUSE_3.12\r\n   177: 000000000001a270    76 FUNC    GLOBAL DEFAULT   19 fuse_loop_mt@FUSE_3.2@FUSE_3.2\r\n   248: 000000000001a220    71 FUNC    GLOBAL DEFAULT   19 fuse_loop_mt_312@@FUSE_3.12\r\n```\r\n\r\nld linker:\r\n```\r\n$ readelf -W --dyn-syms lib/libfuse3.so.3 | grep fuse_loop_mt\r\n180: 00000000000100a0    76 FUNC    GLOBAL DEFAULT   11 fuse_loop_mt@FUSE_3.0\r\n   181: 0000000000010050    76 FUNC    GLOBAL DEFAULT   11 fuse_loop_mt@FUSE_3.2\r\n   182: 0000000000010000    71 FUNC    GLOBAL DEFAULT   11 fuse_loop_mt@@FUSE_3.12\r\n   202: 0000000000010000    71 FUNC    GLOBAL DEFAULT   11 fuse_loop_mt_312@@FUSE_3.12\r\n   275: 00000000000100a0    76 FUNC    GLOBAL DEFAULT   11 fuse_loop_mt_31@@FUSE_3.2\r\n   277: 0000000000010050    76 FUNC    GLOBAL DEFAULT   11 fuse_loop_mt_32@@FUSE_3.12\r\n```\r\n\r\nAnd also with libbsd:\r\nhttps://gitlab.freedesktop.org/libbsd/libbsd/-/issues/18\r\n\r\n```\r\nlibtool: link: gcc -shared  -fPIC -DPIC  .libs/closefrom.o .libs/dehumanize_number.o .libs/err.o .libs/expand_number.o .libs/explicit_bzero.o .libs/fgetln.o .libs/fgetwln.o .libs/flopen.o .libs/fmtcheck.o .libs/fparseln.o .libs/freezero.o .libs/getbsize.o .libs/getpeereid.o .libs/heapsort.o .libs/humanize_number.o .libs/inet_net_pton.o .libs/merge.o .libs/pidfile.o .libs/progname.o .libs/pwcache.o .libs/radixsort.o .libs/readpassphrase.o .libs/reallocarray.o .libs/reallocf.o .libs/recallocarray.o .libs/setmode.o .libs/setproctitle.o .libs/stringlist.o .libs/strnstr.o .libs/strtoi.o .libs/strtonum.o .libs/strtou.o .libs/timeconv.o .libs/unvis.o .libs/vis.o .libs/bsd_getopt.o .libs/arc4random.o .libs/arc4random_uniform.o .libs/md5.o .libs/nlist.o .libs/strlcat.o .libs/strlcpy.o .libs/wcslcat.o .libs/wcslcpy.o .libs/strmode.o .libs/fpurge.o .libs/funopen.o   -lmd  -O2 -flto=auto -Wl,--version-script=./libbsd.map -fuse-ld=mold -Wl,--fatal-warnings   -Wl,-soname -Wl,libbsd.so.0 -o .libs/libbsd.so.0.11.7\r\nmold: error: ./libbsd.map: cannot assign version `LIBBSD_0.2` to symbol `strnvis`: symbol not found\r\nmold: error: ./libbsd.map: cannot assign version `LIBBSD_0.2` to symbol `strnunvis`: symbol not found\r\nmold: error: ./libbsd.map: cannot assign version `LIBBSD_0.5` to symbol `setproctitle`: symbol not found\r\n```\r\n\r\nld linker:\r\n```\r\n$ readelf -W --dyn-syms ./src/.libs/libbsd.so.0 | grep strnvis\r\n   126: 000000000000ca90   137 FUNC    GLOBAL DEFAULT   11 strnvis@LIBBSD_0.9.1\r\n   127: 000000000000ca00   137 FUNC    GLOBAL DEFAULT   11 strnvis@@LIBBSD_0.2\r\n   130: 000000000000ca90   137 FUNC    GLOBAL DEFAULT   11 strnvis_netbsd@@LIBBSD_0.9.1\r\n   159: 000000000000cbd0    96 FUNC    GLOBAL DEFAULT   11 strnvisx@@LIBBSD_0.11.0\r\n```\r\n\r\nmold linker:\r\n```\r\n$ readelf -W --dyn-syms ./src/.libs/libbsd.so.0 | grep strnvis\r\n120: 0000000000010570   137 FUNC    GLOBAL DEFAULT   20 strnvis@@LIBBSD_0.2\r\n   157: 0000000000010740    96 FUNC    GLOBAL DEFAULT   20 strnvisx@@LIBBSD_0.11.0\r\n   168: 0000000000010600   137 FUNC    GLOBAL DEFAULT   20 strnvis_netbsd@@LIBBSD_0.9.1\r\n   198: 0000000000010600   137 FUNC    GLOBAL DEFAULT   20 strnvis@LIBBSD_0.9.1@LIBBSD_0.9.1\r\n```\r\n\r\nI am also attaching the complete output of `readelf -W --dyn-syms` from each library with both ld and mold\r\n\r\n\r\n[readelf-xz-ld.txt](https://github.com/rui314/mold/files/11937064/readelf-xz-ld.txt)\r\n[readelf-xz-mold.txt](https://github.com/rui314/mold/files/11937066/readelf-xz-mold.txt)\r\n\r\n\r\n\r\n[readelf-fuse-ld.txt](https://github.com/rui314/mold/files/11937033/readelf-fuse-ld.txt)\r\n[readelf-fuse-mold.txt](https://github.com/rui314/mold/files/11937036/readelf-fuse-mold.txt)\r\n\r\n[readelf-libbsd-ld.txt](https://github.com/rui314/mold/files/11937037/readelf-libbsd-ld.txt)\r\n[readelf-libbsd-mold.txt](https://github.com/rui314/mold/files/11937038/readelf-libbsd-mold.txt)\r\n\r\n\r\n\r\n","reactions":{"url":"https://api.github.com/repos/rui314/mold/issues/1056/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rui314/mold/issues/1056/timeline","performed_via_github_app":null,"state_reason":"completed"},"comment":{"url":"https://api.github.com/repos/rui314/mold/issues/comments/1621453741","html_url":"https://github.com/rui314/mold/issues/1056#issuecomment-1621453741","issue_url":"https://api.github.com/repos/rui314/mold/issues/1056","id":1621453741,"node_id":"IC_kwDOEdor_85gpWut","user":{"login":"rui314","id":47400,"node_id":"MDQ6VXNlcjQ3NDAw","avatar_url":"https://avatars.githubusercontent.com/u/47400?v=4","gravatar_id":"","url":"https://api.github.com/users/rui314","html_url":"https://github.com/rui314","followers_url":"https://api.github.com/users/rui314/followers","following_url":"https://api.github.com/users/rui314/following{/other_user}","gists_url":"https://api.github.com/users/rui314/gists{/gist_id}","starred_url":"https://api.github.com/users/rui314/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rui314/subscriptions","organizations_url":"https://api.github.com/users/rui314/orgs","repos_url":"https://api.github.com/users/rui314/repos","events_url":"https://api.github.com/users/rui314/events{/privacy}","received_events_url":"https://api.github.com/users/rui314/received_events","type":"User","site_admin":false},"created_at":"2023-07-05T10:10:19Z","updated_at":"2023-07-05T10:10:19Z","author_association":"OWNER","body":"This issue should be fixed in the above commit.","reactions":{"url":"https://api.github.com/repos/rui314/mold/issues/comments/1621453741/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null}},"public":true,"created_at":"2023-07-05T10:10:19Z"}
{"id":"30207443231","type":"IssueCommentEvent","actor":{"id":46091994,"login":"kostadinsh","display_login":"kostadinsh","gravatar_id":"","url":"https://api.github.com/users/kostadinsh","avatar_url":"https://avatars.githubusercontent.com/u/46091994?"},"repo":{"id":553665726,"name":"tukaani-project/xz","url":"https://api.github.com/repos/tukaani-project/xz"},"payload":{"action":"created","issue":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/55","repository_url":"https://api.github.com/repos/tukaani-project/xz","labels_url":"https://api.github.com/repos/tukaani-project/xz/issues/55/labels{/name}","comments_url":"https://api.github.com/repos/tukaani-project/xz/issues/55/comments","events_url":"https://api.github.com/repos/tukaani-project/xz/issues/55/events","html_url":"https://github.com/tukaani-project/xz/issues/55","id":1785719237,"node_id":"I_kwDOIQBEvs5qb-nF","number":55,"title":"[Bug]: warnings about missing symbols when building with the mold linker and lto","user":{"login":"kostadinsh","id":46091994,"node_id":"MDQ6VXNlcjQ2MDkxOTk0","avatar_url":"https://avatars.githubusercontent.com/u/46091994?v=4","gravatar_id":"","url":"https://api.github.com/users/kostadinsh","html_url":"https://github.com/kostadinsh","followers_url":"https://api.github.com/users/kostadinsh/followers","following_url":"https://api.github.com/users/kostadinsh/following{/other_user}","gists_url":"https://api.github.com/users/kostadinsh/gists{/gist_id}","starred_url":"https://api.github.com/users/kostadinsh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kostadinsh/subscriptions","organizations_url":"https://api.github.com/users/kostadinsh/orgs","repos_url":"https://api.github.com/users/kostadinsh/repos","events_url":"https://api.github.com/users/kostadinsh/events{/privacy}","received_events_url":"https://api.github.com/users/kostadinsh/received_events","type":"User","site_admin":false},"labels":[{"id":4687621022,"node_id":"LA_kwDOIQBEvs8AAAABF2drng","url":"https://api.github.com/repos/tukaani-project/xz/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2023-07-03T09:13:02Z","updated_at":"2023-07-05T10:23:43Z","closed_at":"2023-07-05T10:23:42Z","author_association":"NONE","active_lock_reason":null,"body":"### Describe the bug\n\nWhen building with the mold linker and -flto added to CFLAGS, this package seems to have some issues in the linking phase regarding symbols not being found. I've turned mold's warnings into errors with `-Wl,--fatal-warnings`, so I can catch them more easily.\r\n\r\nGCC version used is gcc (Gentoo 13.1.1_p20230527 p3) 13.1.1 20230527\r\nMold is built from git at commit `b04aba89d3a1931470983212925443e7aefca1e1`\r\n\r\nSteps to reproduce: \r\n1. Clone this repo and cd into the xz folder\r\n2. run `export CFLAGS=\"-O2 -pipe -flto=auto\"` and `export LDFLAGS=\"-fuse-ld=mold -Wl,--fatal-warnings\"`\r\n3. run `autoreconf -vfi`\r\n4. run `./configure --enable-threads --prefix=/usr`\r\n5. build the package with `make V=1`\r\n\r\nIn the log output I am only going to only add the last few lines of the log as I think the entire log would be way too much, and then add the full logs from `./configure` and `make` as an attachment\r\n\r\n[xz-configure.log](https://github.com/tukaani-project/xz/files/11935128/xz-configure.log)\r\n[xz-make.log](https://github.com/tukaani-project/xz/files/11935130/xz-make.log)\r\n\n\n### Version\n\ncommit 66bdcfa85fef2911cc80f5f30fed3f9610faccb4\n\n### Operating System\n\nGentoo Linux\n\n### Relevant log output\n\n```shell\nlibtool: link: gcc -shared  -fPIC -DPIC  .libs/liblzma_la-tuklib_physmem.o .libs/liblzma_la-tuklib_cpucores.o .libs/liblzma_la-common.o .libs/liblzma_la-block_util.o .libs/liblzma_la-easy_preset.o .libs/liblzma_la-filter_common.o .libs/liblzma_la-hardware_physmem.o .libs/liblzma_la-index.o .libs/liblzma_la-stream_flags_common.o .libs/liblzma_la-string_conversion.o .libs/liblzma_la-vli_size.o .libs/liblzma_la-hardware_cputhreads.o .libs/liblzma_la-outqueue.o .libs/liblzma_la-alone_encoder.o .libs/liblzma_la-block_buffer_encoder.o .libs/liblzma_la-block_encoder.o .libs/liblzma_la-block_header_encoder.o .libs/liblzma_la-easy_buffer_encoder.o .libs/liblzma_la-easy_encoder.o .libs/liblzma_la-easy_encoder_memusage.o .libs/liblzma_la-filter_buffer_encoder.o .libs/liblzma_la-filter_encoder.o .libs/liblzma_la-filter_flags_encoder.o .libs/liblzma_la-index_encoder.o .libs/liblzma_la-stream_buffer_encoder.o .libs/liblzma_la-stream_encoder.o .libs/liblzma_la-stream_flags_encoder.o .libs/liblzma_la-vli_encoder.o .libs/liblzma_la-stream_encoder_mt.o .libs/liblzma_la-microlzma_encoder.o .libs/liblzma_la-alone_decoder.o .libs/liblzma_la-auto_decoder.o .libs/liblzma_la-block_buffer_decoder.o .libs/liblzma_la-block_decoder.o .libs/liblzma_la-block_header_decoder.o .libs/liblzma_la-easy_decoder_memusage.o .libs/liblzma_la-file_info.o .libs/liblzma_la-filter_buffer_decoder.o .libs/liblzma_la-filter_decoder.o .libs/liblzma_la-filter_flags_decoder.o .libs/liblzma_la-index_decoder.o .libs/liblzma_la-index_hash.o .libs/liblzma_la-stream_buffer_decoder.o .libs/liblzma_la-stream_decoder.o .libs/liblzma_la-stream_flags_decoder.o .libs/liblzma_la-vli_decoder.o .libs/liblzma_la-stream_decoder_mt.o .libs/liblzma_la-microlzma_decoder.o .libs/liblzma_la-lzip_decoder.o .libs/liblzma_la-check.o .libs/liblzma_la-crc32_table.o .libs/liblzma_la-crc32_fast.o .libs/liblzma_la-crc64_table.o .libs/liblzma_la-crc64_fast.o .libs/liblzma_la-sha256.o .libs/liblzma_la-lz_encoder.o .libs/liblzma_la-lz_encoder_mf.o .libs/liblzma_la-lz_decoder.o .libs/liblzma_la-lzma_encoder_presets.o .libs/liblzma_la-lzma_encoder.o .libs/liblzma_la-lzma_encoder_optimum_fast.o .libs/liblzma_la-lzma_encoder_optimum_normal.o .libs/liblzma_la-fastpos_table.o .libs/liblzma_la-lzma_decoder.o .libs/liblzma_la-lzma2_encoder.o .libs/liblzma_la-lzma2_decoder.o .libs/liblzma_la-price_table.o .libs/liblzma_la-delta_common.o .libs/liblzma_la-delta_encoder.o .libs/liblzma_la-delta_decoder.o .libs/liblzma_la-simple_coder.o .libs/liblzma_la-simple_encoder.o .libs/liblzma_la-simple_decoder.o .libs/liblzma_la-x86.o .libs/liblzma_la-powerpc.o .libs/liblzma_la-ia64.o .libs/liblzma_la-arm.o .libs/liblzma_la-armthumb.o .libs/liblzma_la-arm64.o .libs/liblzma_la-sparc.o   -lpthread  -O2 -flto=auto -Wl,--version-script=../../src/liblzma/liblzma_linux.map -fuse-ld=mold -Wl,--fatal-warnings   -pthread -Wl,-soname -Wl,liblzma.so.5 -o .libs/liblzma.so.5.5.99\r\nmold: error: ../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2` to symbol `lzma_block_uncomp_encode`: symbol not found\r\nmold: error: ../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2` to symbol `lzma_cputhreads`: symbol not found\r\nmold: error: ../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2` to symbol `lzma_get_progress`: symbol not found\r\nmold: error: ../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2` to symbol `lzma_stream_encoder_mt`: symbol not found\r\nmold: error: ../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2` to symbol `lzma_stream_encoder_mt_memusage`: symbol not found\r\nmold: error: ../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.1.2alpha` to symbol `lzma_stream_encoder_mt`: symbol not found\r\nmold: error: ../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.1.2alpha` to symbol `lzma_stream_encoder_mt_memusage`: symbol not found\r\nmold: error: ../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2.2` to symbol `lzma_block_uncomp_encode`: symbol not found\r\nmold: error: ../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2.2` to symbol `lzma_cputhreads`: symbol not found\r\nmold: error: ../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2.2` to symbol `lzma_get_progress`: symbol not found\r\nmold: error: ../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2.2` to symbol `lzma_stream_encoder_mt`: symbol not found\r\nmold: error: ../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2.2` to symbol `lzma_stream_encoder_mt_memusage`: symbol not found\r\ncollect2: error: ld returned 1 exit status\r\nmake[4]: *** [Makefile:963: liblzma.la] Error 1\r\nmake[4]: Leaving directory '/home/kostadin/xz/src/liblzma'\r\nmake[3]: *** [Makefile:1747: all-recursive] Error 1\r\nmake[3]: Leaving directory '/home/kostadin/xz/src/liblzma'\r\nmake[2]: *** [Makefile:429: all-recursive] Error 1\r\nmake[2]: Leaving directory '/home/kostadin/xz/src'\r\nmake[1]: *** [Makefile:624: all-recursive] Error 1\r\nmake[1]: Leaving directory '/home/kostadin/xz'\r\nmake: *** [Makefile:493: all] Error 2\n```\n","reactions":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/55/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/tukaani-project/xz/issues/55/timeline","performed_via_github_app":null,"state_reason":"completed"},"comment":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/comments/1621472811","html_url":"https://github.com/tukaani-project/xz/issues/55#issuecomment-1621472811","issue_url":"https://api.github.com/repos/tukaani-project/xz/issues/55","id":1621472811,"node_id":"IC_kwDOIQBEvs5gpbYr","user":{"login":"kostadinsh","id":46091994,"node_id":"MDQ6VXNlcjQ2MDkxOTk0","avatar_url":"https://avatars.githubusercontent.com/u/46091994?v=4","gravatar_id":"","url":"https://api.github.com/users/kostadinsh","html_url":"https://github.com/kostadinsh","followers_url":"https://api.github.com/users/kostadinsh/followers","following_url":"https://api.github.com/users/kostadinsh/following{/other_user}","gists_url":"https://api.github.com/users/kostadinsh/gists{/gist_id}","starred_url":"https://api.github.com/users/kostadinsh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kostadinsh/subscriptions","organizations_url":"https://api.github.com/users/kostadinsh/orgs","repos_url":"https://api.github.com/users/kostadinsh/repos","events_url":"https://api.github.com/users/kostadinsh/events{/privacy}","received_events_url":"https://api.github.com/users/kostadinsh/received_events","type":"User","site_admin":false},"created_at":"2023-07-05T10:23:42Z","updated_at":"2023-07-05T10:23:42Z","author_association":"NONE","body":"Solved by https://github.com/rui314/mold/commit/4b42f38257068f2a3f0dbb102904519d85c9dcb2","reactions":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/comments/1621472811/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null}},"public":true,"created_at":"2023-07-05T10:23:43Z","org":{"id":116083088,"login":"tukaani-project","gravatar_id":"","url":"https://api.github.com/orgs/tukaani-project","avatar_url":"https://avatars.githubusercontent.com/u/116083088?"}}
{"id":"30207443410","type":"IssuesEvent","actor":{"id":46091994,"login":"kostadinsh","display_login":"kostadinsh","gravatar_id":"","url":"https://api.github.com/users/kostadinsh","avatar_url":"https://avatars.githubusercontent.com/u/46091994?"},"repo":{"id":553665726,"name":"tukaani-project/xz","url":"https://api.github.com/repos/tukaani-project/xz"},"payload":{"action":"closed","issue":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/55","repository_url":"https://api.github.com/repos/tukaani-project/xz","labels_url":"https://api.github.com/repos/tukaani-project/xz/issues/55/labels{/name}","comments_url":"https://api.github.com/repos/tukaani-project/xz/issues/55/comments","events_url":"https://api.github.com/repos/tukaani-project/xz/issues/55/events","html_url":"https://github.com/tukaani-project/xz/issues/55","id":1785719237,"node_id":"I_kwDOIQBEvs5qb-nF","number":55,"title":"[Bug]: warnings about missing symbols when building with the mold linker and lto","user":{"login":"kostadinsh","id":46091994,"node_id":"MDQ6VXNlcjQ2MDkxOTk0","avatar_url":"https://avatars.githubusercontent.com/u/46091994?v=4","gravatar_id":"","url":"https://api.github.com/users/kostadinsh","html_url":"https://github.com/kostadinsh","followers_url":"https://api.github.com/users/kostadinsh/followers","following_url":"https://api.github.com/users/kostadinsh/following{/other_user}","gists_url":"https://api.github.com/users/kostadinsh/gists{/gist_id}","starred_url":"https://api.github.com/users/kostadinsh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kostadinsh/subscriptions","organizations_url":"https://api.github.com/users/kostadinsh/orgs","repos_url":"https://api.github.com/users/kostadinsh/repos","events_url":"https://api.github.com/users/kostadinsh/events{/privacy}","received_events_url":"https://api.github.com/users/kostadinsh/received_events","type":"User","site_admin":false},"labels":[{"id":4687621022,"node_id":"LA_kwDOIQBEvs8AAAABF2drng","url":"https://api.github.com/repos/tukaani-project/xz/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2023-07-03T09:13:02Z","updated_at":"2023-07-05T10:23:43Z","closed_at":"2023-07-05T10:23:42Z","author_association":"NONE","active_lock_reason":null,"body":"### Describe the bug\n\nWhen building with the mold linker and -flto added to CFLAGS, this package seems to have some issues in the linking phase regarding symbols not being found. I've turned mold's warnings into errors with `-Wl,--fatal-warnings`, so I can catch them more easily.\r\n\r\nGCC version used is gcc (Gentoo 13.1.1_p20230527 p3) 13.1.1 20230527\r\nMold is built from git at commit `b04aba89d3a1931470983212925443e7aefca1e1`\r\n\r\nSteps to reproduce: \r\n1. Clone this repo and cd into the xz folder\r\n2. run `export CFLAGS=\"-O2 -pipe -flto=auto\"` and `export LDFLAGS=\"-fuse-ld=mold -Wl,--fatal-warnings\"`\r\n3. run `autoreconf -vfi`\r\n4. run `./configure --enable-threads --prefix=/usr`\r\n5. build the package with `make V=1`\r\n\r\nIn the log output I am only going to only add the last few lines of the log as I think the entire log would be way too much, and then add the full logs from `./configure` and `make` as an attachment\r\n\r\n[xz-configure.log](https://github.com/tukaani-project/xz/files/11935128/xz-configure.log)\r\n[xz-make.log](https://github.com/tukaani-project/xz/files/11935130/xz-make.log)\r\n\n\n### Version\n\ncommit 66bdcfa85fef2911cc80f5f30fed3f9610faccb4\n\n### Operating System\n\nGentoo Linux\n\n### Relevant log output\n\n```shell\nlibtool: link: gcc -shared  -fPIC -DPIC  .libs/liblzma_la-tuklib_physmem.o .libs/liblzma_la-tuklib_cpucores.o .libs/liblzma_la-common.o .libs/liblzma_la-block_util.o .libs/liblzma_la-easy_preset.o .libs/liblzma_la-filter_common.o .libs/liblzma_la-hardware_physmem.o .libs/liblzma_la-index.o .libs/liblzma_la-stream_flags_common.o .libs/liblzma_la-string_conversion.o .libs/liblzma_la-vli_size.o .libs/liblzma_la-hardware_cputhreads.o .libs/liblzma_la-outqueue.o .libs/liblzma_la-alone_encoder.o .libs/liblzma_la-block_buffer_encoder.o .libs/liblzma_la-block_encoder.o .libs/liblzma_la-block_header_encoder.o .libs/liblzma_la-easy_buffer_encoder.o .libs/liblzma_la-easy_encoder.o .libs/liblzma_la-easy_encoder_memusage.o .libs/liblzma_la-filter_buffer_encoder.o .libs/liblzma_la-filter_encoder.o .libs/liblzma_la-filter_flags_encoder.o .libs/liblzma_la-index_encoder.o .libs/liblzma_la-stream_buffer_encoder.o .libs/liblzma_la-stream_encoder.o .libs/liblzma_la-stream_flags_encoder.o .libs/liblzma_la-vli_encoder.o .libs/liblzma_la-stream_encoder_mt.o .libs/liblzma_la-microlzma_encoder.o .libs/liblzma_la-alone_decoder.o .libs/liblzma_la-auto_decoder.o .libs/liblzma_la-block_buffer_decoder.o .libs/liblzma_la-block_decoder.o .libs/liblzma_la-block_header_decoder.o .libs/liblzma_la-easy_decoder_memusage.o .libs/liblzma_la-file_info.o .libs/liblzma_la-filter_buffer_decoder.o .libs/liblzma_la-filter_decoder.o .libs/liblzma_la-filter_flags_decoder.o .libs/liblzma_la-index_decoder.o .libs/liblzma_la-index_hash.o .libs/liblzma_la-stream_buffer_decoder.o .libs/liblzma_la-stream_decoder.o .libs/liblzma_la-stream_flags_decoder.o .libs/liblzma_la-vli_decoder.o .libs/liblzma_la-stream_decoder_mt.o .libs/liblzma_la-microlzma_decoder.o .libs/liblzma_la-lzip_decoder.o .libs/liblzma_la-check.o .libs/liblzma_la-crc32_table.o .libs/liblzma_la-crc32_fast.o .libs/liblzma_la-crc64_table.o .libs/liblzma_la-crc64_fast.o .libs/liblzma_la-sha256.o .libs/liblzma_la-lz_encoder.o .libs/liblzma_la-lz_encoder_mf.o .libs/liblzma_la-lz_decoder.o .libs/liblzma_la-lzma_encoder_presets.o .libs/liblzma_la-lzma_encoder.o .libs/liblzma_la-lzma_encoder_optimum_fast.o .libs/liblzma_la-lzma_encoder_optimum_normal.o .libs/liblzma_la-fastpos_table.o .libs/liblzma_la-lzma_decoder.o .libs/liblzma_la-lzma2_encoder.o .libs/liblzma_la-lzma2_decoder.o .libs/liblzma_la-price_table.o .libs/liblzma_la-delta_common.o .libs/liblzma_la-delta_encoder.o .libs/liblzma_la-delta_decoder.o .libs/liblzma_la-simple_coder.o .libs/liblzma_la-simple_encoder.o .libs/liblzma_la-simple_decoder.o .libs/liblzma_la-x86.o .libs/liblzma_la-powerpc.o .libs/liblzma_la-ia64.o .libs/liblzma_la-arm.o .libs/liblzma_la-armthumb.o .libs/liblzma_la-arm64.o .libs/liblzma_la-sparc.o   -lpthread  -O2 -flto=auto -Wl,--version-script=../../src/liblzma/liblzma_linux.map -fuse-ld=mold -Wl,--fatal-warnings   -pthread -Wl,-soname -Wl,liblzma.so.5 -o .libs/liblzma.so.5.5.99\r\nmold: error: ../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2` to symbol `lzma_block_uncomp_encode`: symbol not found\r\nmold: error: ../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2` to symbol `lzma_cputhreads`: symbol not found\r\nmold: error: ../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2` to symbol `lzma_get_progress`: symbol not found\r\nmold: error: ../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2` to symbol `lzma_stream_encoder_mt`: symbol not found\r\nmold: error: ../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2` to symbol `lzma_stream_encoder_mt_memusage`: symbol not found\r\nmold: error: ../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.1.2alpha` to symbol `lzma_stream_encoder_mt`: symbol not found\r\nmold: error: ../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.1.2alpha` to symbol `lzma_stream_encoder_mt_memusage`: symbol not found\r\nmold: error: ../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2.2` to symbol `lzma_block_uncomp_encode`: symbol not found\r\nmold: error: ../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2.2` to symbol `lzma_cputhreads`: symbol not found\r\nmold: error: ../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2.2` to symbol `lzma_get_progress`: symbol not found\r\nmold: error: ../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2.2` to symbol `lzma_stream_encoder_mt`: symbol not found\r\nmold: error: ../../src/liblzma/liblzma_linux.map: cannot assign version `XZ_5.2.2` to symbol `lzma_stream_encoder_mt_memusage`: symbol not found\r\ncollect2: error: ld returned 1 exit status\r\nmake[4]: *** [Makefile:963: liblzma.la] Error 1\r\nmake[4]: Leaving directory '/home/kostadin/xz/src/liblzma'\r\nmake[3]: *** [Makefile:1747: all-recursive] Error 1\r\nmake[3]: Leaving directory '/home/kostadin/xz/src/liblzma'\r\nmake[2]: *** [Makefile:429: all-recursive] Error 1\r\nmake[2]: Leaving directory '/home/kostadin/xz/src'\r\nmake[1]: *** [Makefile:624: all-recursive] Error 1\r\nmake[1]: Leaving directory '/home/kostadin/xz'\r\nmake: *** [Makefile:493: all] Error 2\n```\n","reactions":{"url":"https://api.github.com/repos/tukaani-project/xz/issues/55/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/tukaani-project/xz/issues/55/timeline","performed_via_github_app":null,"state_reason":"completed"}},"public":true,"created_at":"2023-07-05T10:23:43Z","org":{"id":116083088,"login":"tukaani-project","gravatar_id":"","url":"https://api.github.com/orgs/tukaani-project","avatar_url":"https://avatars.githubusercontent.com/u/116083088?"}}
